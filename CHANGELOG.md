# 更新日志

## [0.1.13] - 2025-11-15

### 改进

#### 压缩文件移动流程优化
- ✅ 优化压缩完成后的文件移动逻辑
  - 压缩函数现在返回实际生成的完整文件路径（`archive_path`）
  - `compress_file_group` 优先使用压缩函数返回的路径，而非预设路径
  - 确保所有压缩方法（pgzip、7zip_command、py7zr）都正确返回文件路径
  - 文件移动时使用绝对路径，避免路径问题
- ✅ 添加详细的压缩和移动日志
  - 记录压缩函数返回的文件路径
  - 记录文件移动前后的路径和大小
  - 记录文件加入移动队列的状态
- ✅ 修复压缩完成后文件未被移动的问题
  - 确保压缩完成后文件正确移动到 `final_dir`
  - 确保文件正确加入 `TapeFileMover` 队列
  - 添加文件存在性检查日志

#### 关键阶段日志输出
- ✅ 添加关键阶段的日志输出（以 WARNING 级别输出，确保可见性）
  - `[扫描文件中...]` - 后台扫描任务开始时
  - `[扫描完成] 共 X 个文件，总大小 XX` - 扫描完成时
  - `[开始压缩] 批次 #X，X 个文件` - 开始压缩每个批次时
  - `[压缩完成] 文件组 X，大小: XX` - 每个文件组压缩完成时
  - `[文件已移动到正式目录] 文件名，大小: XX` - 文件从 temp 目录移动到 final 目录时
  - `[加入移动队列] 文件组 X，等待移动到磁带机` - 文件成功加入移动队列时
  - `[文件已移动到磁带机] 文件名 (文件组 X)` - 文件成功移动到磁带机时
  - `[移动到磁带机失败] 文件组 X，错误: XX` - 移动失败时

#### 写入磁带徽章状态显示
- ✅ 优化备份页面卡片中的阶段徽章显示
  - "写入磁带"徽章在写入阶段（`operation_stage === 'copy'`）显示为黄色警告色并带有脉冲动画
  - 写入完成后徽章恢复为普通样式（绿色或灰色）
  - 添加 `pulse-badge` CSS 动画效果，提供视觉反馈

#### 日志格式优化
- ✅ 优化扫描日志格式，明确区分不同扫描任务的计数
  - 后台扫描：`[后台扫描] 流式扫描：已扫描 X 个路径（包含目录），Y 个目录...`
  - 压缩扫描：`[压缩扫描]：已扫描 X 个文件（当前源路径，仅为当前源路径的文件数），找到...`
  - 每 10000 个文件输出一次进度日志（避免日志过多）
  - 明确说明后台扫描统计的是路径（包含目录），压缩扫描统计的是文件（仅当前源路径）

#### 路径过长和权限错误的处理
- ✅ 优化长路径和权限错误的处理
  - 在扫描阶段直接跳过路径超过 260 字符（Windows 限制）的文件
  - 跳过权限错误的文件，避免写入数据库
  - 添加详细的错误日志记录（仅记录前 10-20 个错误，避免日志过多）

### 修复

#### 压缩完成后文件移动问题
- ✅ 修复压缩完成后文件未被移动到磁带的问题
  - 修复 `compress_result['archive_path']` 未被正确使用的问题
  - 确保所有压缩方法都返回正确的 `archive_path`
  - 修复文件移动逻辑，确保使用压缩函数返回的实际路径

#### 文件移动队列状态更新
- ✅ 修复文件移动到磁带时的状态更新
  - `TapeFileMover` 现在正确传递 `backup_task` 对象
  - 写入开始时更新 `operation_stage` 为 `'copy'`
  - 写入完成后更新 `operation_stage` 为 `'finalize'`

## [0.1.12] - 2025-11-14

### 改进

#### 数据库初始化自动补齐压缩字段
- ✅ `config/database.py` 增加字段迁移逻辑
  - openGauss 初始化时使用 psycopg2 自动检测并补齐 `backup_tasks.compressed_bytes`、`backup_sets.compressed_bytes`、`backup_sets.compression_ratio`
  - PostgreSQL 初始化时使用 SQLAlchemy Inspector 逐表检查，缺失字段会通过 `ALTER TABLE ... ADD COLUMN ...` 自动补齐
  - SQLite 环境跳过字段迁移逻辑，保持原有行为
  - 添加字段注释（若数据库支持）以便后续维护
- ✅ 启动流程现在可自动修复缺失字段
  - 无需手动执行 SQL 脚本即可保证压缩统计相关字段齐全
  - 避免升级后因旧表缺少字段导致的 API 报错或压缩统计缺失

## [0.1.11] - 2025-11-13

### 修复

#### 计划任务页面路由修复
- ✅ 修复了 `/scheduler` 路由返回 404 的问题
  - 调整了路由注册顺序，将页面路由移到 API 路由之前，确保页面路由优先匹配
  - 更新了 `AuthMiddleware` 的 `EXCLUDED_PATHS`，添加了所有页面路由（`/backup`、`/recovery`、`/tape`、`/tapedrive`、`/scheduler`、`/tools`、`/system`）
  - 添加了调试日志，便于诊断路由问题
  - 修复了路由处理函数中的错误处理逻辑

### 改进

#### 计划任务页面独立化
- ✅ 将计划任务管理从系统设置页面移动到独立的导航链接和页面
  - 在 `base.html` 中添加了"计划"导航链接，位于"工具"链接左侧
  - 创建了独立的 `scheduler.html` 页面，包含完整的计划任务管理功能
  - 从 `system.html` 中移除了计划任务标签页和相关 JavaScript
  - 从 `system/_tabs_nav.html` 中移除了计划任务标签
  - 从 `system/_modals.html` 中移除了计划任务相关模态框（现在直接包含在 `scheduler.html` 中）
  - 添加了新的 FastAPI 路由 `/scheduler` 用于服务计划任务管理页面

#### 路由注册优化
- ✅ 优化了路由注册顺序
  - 页面路由（`@app.get()`）在 API 路由（`app.include_router()`）之前注册
  - 确保页面路由优先匹配，避免与 API 路由冲突
  - 提高了路由匹配的准确性和性能

#### 中间件配置优化
- ✅ 改进了认证中间件的路径排除逻辑
  - 将所有页面路由添加到 `EXCLUDED_PATHS`，避免 HTML 页面被认证中间件拦截
  - 添加了调试日志，记录跳过认证检查的路径
  - 改进了路径匹配逻辑，确保页面路由能够正确跳过认证

### 技术细节

#### 路由匹配优先级
- FastAPI 按照路由注册顺序匹配路由
- 页面路由先注册，确保精确匹配（如 `/scheduler`）优先于 API 路由的前缀匹配（如 `/api/scheduler/*`）
- 这样可以避免路由冲突和 404 错误

#### 中间件执行顺序
- 中间件按照添加顺序执行（从后往前）
- `AuthMiddleware` 检查路径是否在 `EXCLUDED_PATHS` 中
- 如果路径匹配，则跳过认证检查，继续处理请求
- 页面路由在 `EXCLUDED_PATHS` 中，因此不会被认证中间件拦截

## [0.1.10] - 2025-11-13

### 修复

#### 数据库连接池全面重构
- ✅ 将所有数据库连接从旧模式迁移到连接池模式
  - 修复了78处使用旧连接模式（`conn = await get_opengauss_connection()` + `await conn.close()`）的代码
  - 统一使用新的连接池模式（`async with get_opengauss_connection() as conn:`）
  - 修复了 `TypeError: object _AsyncGeneratorContextManager can't be used in 'await' expression` 错误
  - 解决了 `WinError 121: 信号灯超时时间已到` 连接超时问题

- ✅ 修复的文件列表（共19个文件）:
  - `backup/backup_engine.py` - 6处
  - `backup/backup_db.py` - 9处
  - `backup/backup_task_manager.py` - 3处
  - `backup/tape_handler.py` - 1处
  - `web/api/backup.py` - 8处
  - `web/api/system/notification.py` - 4处
  - `web/api/system/statistics.py` - 6处
  - `web/api/system/logs.py` - 1处
  - `web/api/system/tape_config.py` - 1处
  - `web/api/scheduler.py` - 2处
  - `web/api/tape/crud.py` - 1处
  - `recovery/recovery_engine.py` - 6处
  - `tape/tape_manager.py` - 2处
  - `tape/tape_operations.py` - 1处
  - `utils/log_utils.py` - 2处
  - `utils/scheduler/task_storage.py` - 12处
  - `utils/scheduler/scheduler.py` - 1处
  - `utils/scheduler/task_executor.py` - 6处
  - `utils/scheduler/action_handlers.py` - 5处

- ✅ 应用关闭时正确释放连接池资源
  - 在 `main.py` 的 `shutdown()` 方法中添加了关闭 openGauss 连接池的逻辑
  - 优化了关闭顺序：先关闭连接池，再关闭数据库管理器
  - 确保所有数据库连接在应用关闭时正确释放

### 改进

#### 连接池配置可配置化
- ✅ 添加了连接池超时时间配置项
  - `DB_POOL_TIMEOUT: float = 30.0` - 连接池连接超时时间（秒）
  - `DB_COMMAND_TIMEOUT: float = 60.0` - 命令超时时间（秒）
  - `DB_ACQUIRE_TIMEOUT: float = 10.0` - 从连接池获取连接的超时时间（秒）
  - 所有超时时间都可以通过配置文件（`.env`）调整

- ✅ 连接池参数使用配置值
  - 连接池创建时使用配置的超时参数
  - 获取连接时使用配置的超时参数
  - 日志输出包含实际使用的超时值，便于监控和调试

#### 连接池错误处理优化
- ✅ 改进了连接池错误处理
  - 正确处理 `UNLISTEN statement is not yet supported` 警告（openGauss 限制）
  - 将 openGauss 限制性警告降级为 DEBUG 级别日志
  - 其他错误使用 WARNING 级别日志
  - 确保连接释放不会因为 openGauss 限制而失败

### 技术细节

#### 连接池实现
- 使用 `asyncpg.create_pool()` 创建连接池
- 连接池参数：
  - `min_size`: 最小连接数（pool_size // 2）
  - `max_size`: 最大连接数（pool_size + max_overflow）
  - `timeout`: 连接超时时间（可配置）
  - `command_timeout`: 命令超时时间（可配置）
  - `max_queries`: 每个连接的最大查询数（50000）
  - `max_inactive_connection_lifetime`: 非活跃连接的最大生命周期（300秒）

#### 连接获取机制
- 使用 `async with get_opengauss_connection() as conn:` 获取连接
- 自动管理连接的获取和释放
- 支持连接获取超时重试（最多3次，指数退避）
- 连接池关闭时自动重新创建

#### 使用场景
- 适用于所有使用 openGauss 数据库的场景
- 特别适用于高并发场景（连接池可以复用连接）
- 解决了大量并发请求时的连接超时问题

## [0.1.9] - 2025-11-12

### 改进

#### 文件扫描性能优化（智能批次阈值）
- ✅ 根据目录数量智能匹配批次阈值
  - 目录数量 >= 50000：使用10个文件/路径作为批次阈值
  - 目录数量 >= 10000：使用25个文件/路径作为批次阈值
  - 目录数量 >= 1000：使用50个文件/路径作为批次阈值
  - 目录数量 < 1000：使用100个文件/路径作为批次阈值
  - 适用于独立扫描任务和压缩扫描任务

- ✅ 强制提交间隔优化
  - 强制提交间隔从5分钟（300秒）调整为20分钟（1200秒）
  - 队列等待超时时间从5分钟（300秒）调整为20分钟（1200秒）
  - 心跳日志间隔从5分钟（300秒）调整为20分钟（1200秒）
  - 警告阈值从10分钟（600秒）调整为30分钟（1800秒）

- ✅ 扫描任务优化
  - 独立扫描任务（后台扫描）使用智能批次阈值
  - 压缩扫描任务（流式扫描）使用智能批次阈值
  - 日志中显示批次阈值信息，便于监控

### 技术细节

#### 智能批次阈值规则
- 根据待扫描目录数量动态调整批次阈值
- 目录数量越多，批次阈值越小，确保进度更新更频繁
- 对于大量目录结构（如40.5万个目录），使用更小的批次阈值（10个文件）

#### 强制提交机制
- 即使没有达到批次阈值，每20分钟也会强制提交一次批次
- 确保在文件分布稀疏的情况下，也能定期更新进度
- 队列等待超时时间与强制提交间隔一致（20分钟）

#### 使用场景
- 特别适用于包含大量子目录的目录结构
- 对于文件分布稀疏的场景，确保进度更新更频繁
- 减少不必要的批次提交，提高性能

## [0.1.8] - 2025-11-12

### 改进

#### 文件扫描器性能优化（大量目录处理）
- ✅ 使用 `os.scandir()` 替代 `rglob()` 以提高性能
  - `os.scandir()` 在 Windows 上比 `rglob()` 更快，特别是在处理大量目录时
  - 内存占用更低，不会一次性加载所有路径
  - 使用迭代方式逐个目录扫描，避免内存溢出

- ✅ 迭代式目录遍历实现
  - 使用 `dirs_to_scan` 队列管理待扫描目录
  - 使用 `scanned_dirs` 集合避免重复扫描
  - 按需处理，减少内存压力

- ✅ 大型目录结构检测与自适应日志
  - 自动检测大型目录结构（超过1万个目录）
  - 大型目录结构下使用更频繁的日志输出：
    - 目录日志：每30秒（而非2分钟）
    - 进度日志：每30秒（而非1分钟）
  - 日志中包含待扫描目录数量，便于监控进度

- ✅ 任务卡片显示优化
  - 修复任务卡片中源路径、目标和运行状态显示问题
  - 在 `update_task_status` 中同时更新 `source_paths` 和 `tape_id`（当状态为 RUNNING 时）
  - 在 `get_task_status` 中返回完整的任务信息（包括 `source_paths`、`tape_id`、`description`）
  - 添加 `update_task_fields` 方法用于更新特定字段
  - 确保任务卡片正确显示源路径、磁带ID和操作状态

- ✅ 错误处理增强
  - 目录权限错误单独处理，不影响整体扫描
  - 错误计数与限制（最多记录20个权限错误）
  - 路径过长检测与跳过
  - 改进的异常处理和日志记录

- ✅ 性能监控改进
  - 显示待扫描目录数量
  - 显示目录计数
  - 显示扫描速度（路径/秒）
  - 显示权限错误和路径过长错误计数

### 技术细节

#### 优化效果
- 扫描速度提升：`os.scandir()` 比 `rglob()` 快约2-3倍
- 内存占用降低：迭代处理，不一次性加载所有路径
- 支持大规模目录结构：已测试支持40.5万个目录
- 更好的进度可见性：更频繁的日志输出，便于监控

#### 使用场景
- 特别适用于包含大量子目录的目录结构（如 `D:\备份\天正协同备份\tbmdata\data\ftpdata` 中有40.5万个目录）
- 首次扫描可能需要较长时间，但不会因为内存问题而失败
- 后续扫描会更快（部分目录可能已缓存）

## [0.1.7] - 2025-11-12

### 改进

#### 备份任务中止功能完善
- ✅ 完善 Ctrl+C 中止任务功能
  - 在 `execute_backup_task` 方法中添加 `KeyboardInterrupt` 和 `CancelledError` 异常处理
  - 在 `_perform_backup` 方法中添加 `KeyboardInterrupt` 和 `CancelledError` 异常处理
  - 在 `_scan_for_progress_update` 方法中添加 `KeyboardInterrupt` 和 `CancelledError` 异常处理
  - 任务被中止时正确更新状态为 `CANCELLED`
  - 任务被中止时正确更新扫描进度为 `[已取消]`
  - 记录错误信息为"用户中止任务（Ctrl+C）"或"任务被取消"

- ✅ 后台扫描任务能够被正确取消
  - 在 `finally` 块中确保后台扫描任务被正确取消
  - 等待后台扫描任务取消完成（超时 5 秒）
  - 即使被取消也保存已扫描的文件数和字节数
  - 记录取消日志，便于追踪

- ✅ 流式扫描循环能够被正确中止
  - 在流式扫描循环中添加取消检查
  - 每批次检查任务是否被取消
  - 检测到取消信号时立即退出循环
  - 记录中止日志

- ✅ 资源清理机制完善
  - 在 `finally` 块中清理后台扫描任务
  - 等待任务取消完成（超时 5 秒）
  - 记录清理日志
  - 确保资源正确释放

- ✅ 任务状态更新优化
  - 任务被中止时状态更新为 `CANCELLED`
  - 错误信息记录为"用户中止任务（Ctrl+C）"或"任务被取消"
  - 扫描进度显示为 `[已取消]`
  - 即使被中止也保存已处理的文件数和字节数

- ✅ 异常处理完善
  - 添加 `KeyboardInterrupt` 专门处理（用户按 Ctrl+C）
  - 添加 `asyncio.CancelledError` 专门处理（任务被取消）
  - 重新抛出异常，让上层处理
  - 记录详细的错误日志和堆栈跟踪

#### 后台扫描任务优化
- ✅ 移除独立线程的判断条件
  - 取消 `if backup_task and backup_task.source_paths:` 判断条件
  - 直接在流式扫描和压缩循环之前启动后台扫描任务
  - 与流式扫描和压缩循环共用前置条件
  - 确保后台扫描任务总是能够启动

- ✅ 后台扫描任务事件循环修复
  - 修复后台线程中无法使用 `asyncio.get_running_loop()` 的问题
  - 在启动后台线程之前获取主事件循环
  - 在后台线程中使用主事件循环提交批次
  - 确保批次能够正确提交到队列

- ✅ 日志输出改进
  - 将关键日志从 `debug` 改为 `info` 级别
  - 添加更多日志信息（目录名、批次数量、文件数、字节数等）
  - 每批次提交时记录日志
  - 目录遍历完成时记录日志
  - 收到完成信号时记录日志

- ✅ 错误处理改进
  - 改进异常捕获和处理
  - 添加错误日志（包含堆栈跟踪）
  - 确保任务正常完成
  - 即使失败也尝试更新已扫描的进度

## [0.1.6] - 2025-11-12

### 改进

#### 备份管理页面显示优化
- ✅ 删除压缩包进度显示
  - 移除"压缩包进度: 125800/125800"的显示
  - 简化任务卡片信息展示

- ✅ 添加数据量显示
  - 新增"数据量"字段，显示已处理文件大小（GB单位）
  - 使用 `formatBytesToGB` 函数格式化显示
  - 实时更新数据量信息

- ✅ 添加已用时间显示
  - 新增"已用时间"字段，显示任务执行时长
  - 支持显示格式：天、小时、分钟、秒
  - 运行中的任务实时更新已用时间
  - 已完成任务显示总耗时

- ✅ 改进进度计算逻辑
  - 优先使用后端提供的实际总字节数（`total_bytes_actual`字段）
  - 后端未提供时自动预估总字节数：
    - 策略1：基于平均文件大小预估（已处理文件数 × 平均文件大小）
    - 策略2：基于当前进度反推（已处理字节数 ÷ 进度百分比）
    - 策略3：保守倍数估算（已处理字节数 × 3）
  - 基于数据量的进度计算（80%权重）+ 文件数进度（20%权重）
  - 分阶段进度计算：扫描阶段（0-70%）、压缩+写入阶段（70-100%）
  - 确保进度计算更准确，反映实际备份进度

## [0.1.5] - 2025-12-20

### 修复

#### 备份页面卡片显示修复
- ✅ 修复进度计算逻辑
  - 进度计算改为：`已处理文件数（累计）/总扫描文件数 * 100`
  - 修复前端进度条显示，确保准确反映文件处理进度
  - 修复卡片更新时的进度计算逻辑

- ✅ 修复压缩包进度显示
  - 修复 `estimated_archive_count` 传递问题
  - 确保第一批压缩完成后正确保存和传递预计压缩包总数
  - 改进 `estimated_archive_count` 的计算逻辑，基于总扫描文件数和平均文件大小
  - 添加调试日志，便于追踪压缩包进度

- ✅ 修复压缩率传递和显示
  - 确保 `compression_ratio` 正确计算和返回（如 3.7%）
  - 修复 `get_backup_tasks` API 返回 `compressed_bytes` 和 `compression_ratio`
  - 修复前端压缩率显示逻辑，确保正确显示百分比格式

- ✅ 修复开始时间和完成时间传递
  - 确保 `started_at` 和 `completed_at` 都保存到数据库
  - 修复 `_update_task_status` 方法，在状态变更时正确保存时间字段
  - 确保 `get_task_status` 和 `get_backup_tasks` API 都返回时间字段
  - 修复前端时间显示，确保开始时间和完成时间正确显示

- ✅ 修复API返回字段完整性
  - `get_backup_tasks` API 添加 `compressed_bytes` 和 `compression_ratio` 字段
  - `get_task_status` API 添加 `completed_at` 字段
  - 确保所有必需字段都正确传递到前端

### 改进

#### 备份任务状态更新优化
- ✅ 改进 `_update_task_status` 方法
  - 根据任务状态自动更新 `started_at`（RUNNING状态）和 `completed_at`（COMPLETED/FAILED状态）
  - 使用动态SQL构建UPDATE语句，只更新必要的字段
  - 确保时间字段在状态变更时正确保存

## [0.1.4] - 2025-12-19

### 改进

#### 计划任务调度配置可编辑
- ✅ 允许直接编辑计划任务的调度配置时间
  - 移除时间输入框的 `readonly` 属性，支持直接输入时间
  - 添加时间格式验证（HH:MM格式，如 02:00）
  - 实时验证和格式化，自动同步到隐藏输入框
  - 支持每日、每周、每月、每年任务的时间编辑
  - 添加时间格式提示和标签说明

- ✅ 改进调度配置界面
  - 添加字段标签和格式说明
  - 改进布局，使配置项更清晰
  - 时间输入框支持直接编辑或使用时间选择器

#### 定时检查任务优化
- ✅ 取消保留期检查的定时任务
  - 移除默认的保留期检查定时任务（`RETENTION_CHECK_CRON`）
  - 改为在打开磁带管理页面时自动检查一次
  - API接口 `GET /api/tape/list` 会自动执行保留期检查
  - 备份开始前已经检查了保留期，避免重复检查

- ✅ 废弃月度备份默认任务
  - 移除默认的月度备份任务注册（`MONTHLY_BACKUP_CRON`）
  - 计划任务的执行时间由用户在Web界面创建时设置
  - 不再使用配置文件中的默认Cron表达式
  - 所有计划任务通过Web界面创建和管理

#### 磁带管理页面状态显示修复
- ✅ 修复正在格式化的磁带不应显示为可用
  - 修复统计API：`MAINTENANCE` 状态的磁带不计入可用数量
  - 修复前端显示：确保状态值统一为小写，CSS样式正确应用
  - 正在格式化的磁带显示为"格式化中"（黄色警告样式），而不是"可用"

### 文档

- ✅ 更新定时检查说明文档
  - 标记保留期检查任务为"已取消定时执行"
  - 说明保留期检查改为页面打开时触发
  - 标记月度备份任务为"已废弃"
  - 更新检查频率总结表

## [0.1.3] - 2025-11-11

### 新增

#### 恢复页面使用真实数据
- ✅ 恢复引擎从数据库查询真实备份集数据
  - `search_backup_sets()`: 从数据库查询备份集列表，支持过滤条件
  - `get_backup_set_files()`: 从数据库查询备份集文件列表
  - `get_backup_groups()`: 从数据库查询备份组列表
  - `_get_backup_set_info()`: 从数据库查询备份集详细信息
  - 支持 openGauss 和 SQLAlchemy 两种数据库查询方式

- ✅ 恢复页面前端使用 API 获取真实数据
  - 删除硬编码的示例数据
  - 添加 `loadBackupGroups()` 从 API 加载备份组
  - 添加 `loadBackupSets()` 从 API 加载备份集列表
  - 添加 `loadBackupSetFiles()` 从 API 加载文件列表
  - 添加 `buildFileTree()` 动态构建文件树
  - 添加文件搜索和类型过滤功能
  - 添加恢复任务创建功能

#### 首页使用真实数据
- ✅ Dashboard API 提供真实统计数据
  - `get_system_statistics()`: 从数据库查询系统统计信息
  - 备份任务统计（总数、运行中、已完成、失败）
  - 磁带库存统计（总数、可用、使用中、过期、在线/离线）
  - 存储统计（总容量、已用容量、使用率）
  - 最近备份活动列表
  - 存储使用趋势（最近30天）
  - 成功率统计（总体、本月、上月对比）

- ✅ 首页前端使用 API 获取真实数据
  - 删除所有硬编码的示例数据
  - 添加 `loadDashboardData()` 从 API 加载统计数据
  - 添加 `renderStorageTrend()` 渲染存储趋势图表
  - 添加 `renderRecentBackups()` 渲染最近备份活动列表
  - 实时更新所有统计卡片（备份任务、存储、磁带、成功率等）
  - 自动刷新机制（每30秒刷新一次）
  - 数据库连接状态检查

#### 计划任务支持恢复操作
- ✅ 完善 RecoveryActionHandler 实现
  - 从配置中获取恢复参数（backup_set_id, files, target_path）
  - 调用恢复引擎创建和执行恢复任务
  - 添加错误处理和日志记录
  - 返回详细的执行结果

### 改进

#### 备份引擎流式处理优化
- ✅ 实现智能流式备份处理
  - 添加配置项 `SCAN_BATCH_SIZE`（文件数阈值）和 `SCAN_BATCH_SIZE_BYTES`（字节数阈值）
  - 修改 `_perform_backup()` 实现流式处理：扫描和压缩循环执行
  - 添加 `_scan_source_files_streaming()` 异步生成器，分批返回文件
  - 达到批次阈值时立即开始压缩，不再等待所有文件扫描完成
  - 降低内存占用，提升大文件备份性能

- ✅ 7z压缩多线程支持
  - 修改 `_compress_file_group()` 使用 `py7zr.SevenZipFile` 替代 `tarfile`
  - 启用多线程压缩（使用 `COMPRESSION_THREADS` 配置）
  - 确保压缩完成判断：使用 `with` 语句确保 `archive.close()` 完成
  - 检查文件大小稳定，使用 `completed` 标志确保压缩操作完成

## [0.1.2] - 2025-11-10

### 改进

#### 计划任务格式化功能优化
- ✅ 计划任务格式化改为后台异步执行，不阻塞API响应
  - 使用 `asyncio.create_task()` 后台执行格式化任务
  - API立即返回，提升用户体验
  - 与磁盘管理页面格式化逻辑保持一致

- ✅ 添加当月判断和卷标自动更新功能
  - 判断当前磁带卷标是否为当月
  - 如果是当月，根据当前系统时间更新卷标
  - 如果不是当月，根据当前系统时间生成新卷标
  - 确保卷标始终与当前系统时间一致

- ✅ 复用磁盘管理的完整格式化逻辑
  - 状态更新：格式化前设置为 `MAINTENANCE`，成功后设置为 `AVAILABLE`，失败设置为 `ERROR`
  - 读取实际值：格式化成功后读取实际卷标和序列号，并更新数据库
  - 错误处理：格式化失败时发送钉钉通知
  - 与磁盘管理页面功能完全一致

- ✅ 序列号格式统一
  - 从 `YYMMNN` 格式改为 `TPMMNN` 格式
  - 与磁盘管理页面的序列号格式保持一致

#### 格式化阻塞问题修复
- ✅ 修复格式化完成后可能阻塞的问题
  - 为 `fsutil` 命令添加10秒超时，防止命令卡住
  - 改进输出读取逻辑，添加单次读取超时（1秒）和总超时（30秒）
  - 确保格式化完成后能正常退出，不会无限等待

- ✅ 优化命令输出读取机制
  - 使用分块读取（每次4KB），避免一次性读取大量数据
  - 添加超时保护，防止读取操作卡住
  - 改进错误处理和日志记录

#### 文档更新
- ✅ 创建格式化流程详解文档 (`docs/格式化流程详解.md`)
  - 详细的格式化执行流程说明
  - 顺序执行机制说明
  - 超时机制说明
  - 状态流转图

- ✅ 创建格式化阻塞问题分析文档 (`docs/格式化阻塞问题分析.md`)
  - 问题分析
  - 修复方案
  - 超时设置说明

- ✅ 创建计划任务格式化功能分析文档 (`docs/计划任务格式化功能分析.md`)
  - 功能对比分析
  - 潜在问题分析
  - 改进建议

- ✅ 创建计划任务格式化改进总结文档 (`docs/计划任务格式化改进总结.md`)
  - 改进内容总结
  - 执行流程说明
  - 与磁盘管理的对比

## [0.1.1] - 2025-11-08

### 改进

#### 磁带格式化操作优化
- ✅ 将磁带格式化操作改为后台任务，避免阻塞前端
  - 使用FastAPI的`BackgroundTasks`执行格式化操作
  - API立即返回响应，前端不再等待格式化完成
  - 格式化完成后在操作历史中记录日志
  - 提升用户体验，避免长时间等待

#### 计划任务源选择器统一
- ✅ 统一计划任务源选择器行为
  - 无论备份目标是"磁带机"还是"存储"，源选择按钮都调用存储选择器（文件浏览器）
  - 添加代码注释说明统一行为
  - 简化用户操作流程

## [0.1.0] - 2025-11-04

### 新增

#### ITDT集成支持
- ✅ 集成IBM Tape Diagnostic Tool (ITDT)支持
  - 创建ITDT接口类 (`tape/itdt_interface.py`)
  - 支持ITDT命令行模式操作
  - 实现所有核心磁带操作（加载、卸载、倒带、擦除、格式化等）
  - 支持设备扫描和状态查询
  - 支持诊断测试功能

#### 磁带操作接口切换
- ✅ 支持ITDT和SCSI接口切换
  - 添加配置项 `TAPE_INTERFACE_TYPE` 选择接口类型
  - 修改 `TapeOperations` 类支持多接口切换
  - 保持API接口不变，后端可切换实现
  - ITDT接口作为推荐方式（更稳定、更标准）

#### ITDT配置支持
- ✅ 添加ITDT相关配置项
  - `TAPE_INTERFACE_TYPE`: 接口类型选择（"itdt" 或 "scsi"）
  - `ITDT_PATH`: ITDT可执行文件路径
  - `ITDT_LOG_LEVEL`: 日志级别（Errors|Warnings|Information|Debug）
  - `ITDT_LOG_PATH`: 日志文件路径
  - `ITDT_RESULT_PATH`: 结果文件路径

#### 文档更新
- ✅ 创建ITDT集成方案文档 (`docs/ITDT集成方案.md`)
  - 详细的ITDT命令分析
  - 架构设计方案
  - 实现步骤和时间表
  - 风险评估和缓解措施
- ✅ 更新README.md
  - 添加ITDT安装和配置说明
  - 添加接口选择说明
  - 更新版本历史

### 改进

#### 磁带操作稳定性
- ✅ ITDT接口提供更稳定的磁带操作
  - 使用IBM官方工具，兼容性更好
  - 标准化命令接口，错误处理更完善
  - 支持更多诊断和测试功能

#### 系统可扩展性
- ✅ 接口抽象设计，便于未来扩展
  - 统一的接口抽象
  - 支持多接口并存
  - 便于添加新的磁带操作接口

### 技术细节

#### ITDT支持的操作
- 基本操作：load, unload, rewind, erase, format
- 读写操作：write, read, weof (write filemark)
- 定位操作：fsf, fsr, bsf, bsr (forward/backward space)
- 状态查询：tur, qrypos, devinfo, logsense
- 设备扫描：scan, qrypath
- 诊断测试：standardtest, systemtest, rwtest

#### 兼容性
- 支持Windows和Linux平台
- 保持与现有SCSI接口的兼容性
- API接口保持不变，切换透明

## [0.0.14] - 2025-11-04

### 修复

#### 计划任务系统JavaScript错误修复
- ✅ 修复`getActionConfig`方法中的null检查问题
  - 修复`Cannot read properties of null (reading 'value')`错误
  - 增强元素查找函数，支持全局和面板内查找
  - 添加安全的值获取函数`val()`，处理元素不存在的情况
  - 添加安全的选中状态获取函数`checked()`，使用可选链操作符
  - 添加元素可见性检查函数`isElementVisibleAndExists()`
  - 在所有DOM元素访问前添加存在性检查，避免null引用错误

#### 模态框aria-hidden警告修复
- ✅ 修复目录浏览器模态框的aria-hidden警告
  - 优化模态框显示逻辑，确保焦点管理正确
  - 改善无障碍访问体验

## [0.0.13] - 2025-11-04

### 改进

#### 磁带添加/更新逻辑优化
- ✅ 将“磁带标签”明确为磁带身份的唯一标识
- ✅ 当从磁带机读取到已有标签时：
  - 标签输入框设为只读，禁用月份选择与“生成标签”按钮
  - 其他字段可编辑
- ✅ 保存逻辑调整：
  - 若数据库已存在该标签则自动执行更新（PUT /api/tape/update/{tape_id}）
  - 若不存在则执行创建（POST /api/tape/create）
  - 模态框标题与确认按钮文案随模式自动切换（添加/更新）
- ✅ 仅前端逻辑调整（`web/templates/tape.html`），兼容后端现有接口

## [0.0.12] - 2025-11-04

### 修复

#### 计划任务系统修复
- ✅ 修复时间格式解析问题
  - 支持多种时间格式：`2025-11-04 17:05:00`、`2025/11/04 17:05:00`、`2025-11-04 17:05`、`2025/11/04 17:05`
  - 使用链式try-except处理不同格式，提高兼容性
  
- ✅ 修复openGauss数据库操作问题
  - `get_task`、`update_task`、`delete_task` 方法对openGauss使用原生SQL查询（asyncpg）
  - 避免SQLAlchemy版本解析错误：`Could not determine version from string '(openGauss-lite 7.0.0-RC1...)'`
  - 正确处理枚举类型（使用CAST）和JSON字段
  - 确保整数字段（total_runs、success_runs、failure_runs）不为None
  
- ✅ 修复API路由匹配问题
  - 调整路由定义顺序：更具体的路径（如`/tasks/{task_id}/disable`）必须在通用路径（如`/tasks/{task_id}`）之前定义
  - 修复`POST /api/scheduler/tasks/{task_id}/disable`和`DELETE /api/scheduler/tasks/{task_id}`返回404的问题
  - 确保FastAPI能够正确匹配路由

- ✅ 增强错误日志
  - 所有数据库操作错误都包含详细的堆栈跟踪信息
  - 便于调试和排查问题

## [0.0.11] - 2025-11-04

### 改进

#### 计划任务界面全面优化
- ✅ 优化计划任务弹出窗口布局
  - 任务名称、备份目标和备份类型一行三个字段（各占 col-md-4）
  - 调度类型、任务动作类型和调度配置一行三个字段（各占 col-md-4）
  - 备份源路径和目标路径一行显示（各占 col-md-6）
  - 任务描述和排除模式一行显示（各占 col-md-6）
  
- ✅ 备份目标配置优化
  - 备份目标选择改为下拉框（磁带机/存储），默认磁带机
  - 备份目标选择"磁带机"时：显示磁带机选择区域，隐藏目标路径
  - 备份目标选择"存储"时：显示目标路径，隐藏磁带机选择
  - 磁带机和存储共用同一位置，根据选择动态切换显示
  
- ✅ 目标磁带机选择优化
  - 改为下拉框 + 添加按钮方式（类似目录添加逻辑）
  - 下拉框包含"自动选择磁带机"、"全部磁带机"和所有可用磁带机
  - 选择后点击"添加"按钮添加到列表（深色背景卡片显示）
  - 支持添加多个磁带机
  - 选择"全部磁带机"时自动清除其他选择
  - 已选择"全部磁带机"时不允许添加单个磁带机
  
- ✅ 目标路径和源路径优化
  - 目标路径支持多选（类似源路径）
  - 目标路径列表使用深色背景卡片显示
  - 浏览按钮文字改为"浏览"（不再显示"浏览并添加"）
  - 合并浏览和添加功能：浏览选择后自动添加，无需再点击添加按钮
  
- ✅ 排除模式优化
  - 预填常用排除项：*.bak, *.tmp, *.log, *.swp, *.cache, Thumbs.db, .DS_Store, $RECYCLE.BIN, System Volume Information, pagefile.sys, $*
  - 删除提示文字"支持通配符模式，每行一个"

## [0.0.10] - 2025-11-03

### 改进

#### API路由优化
- ✅ 优化磁带管理API路由命名
  - `PUT /api/tape/{tape_id}` 改为 `PUT /api/tape/update/{tape_id}`
  - `GET /api/tape/{tape_id}` 改为 `GET /api/tape/show/{tape_id}`
  - 更新所有相关前端调用

#### 磁带管理界面优化
- ✅ 优化磁带扫描和标签读取流程
  - 合并"读取磁带标签"功能到"从磁带机扫描信息"按钮
  - 扫描时并行执行设备扫描和读取磁带标签
  - 优化扫描结果模态框显示格式：
    - 设备信息：标题在上，关键信息（厂商、型号、产品）显示在下方
    - 磁带信息：标题在上，关键信息（磁带标签、序列号、创建日期）对齐显示
  - 序列号使用后端Python `uuid.uuid4()`生成（HEX格式：全大写无连字符，32字符）
  - 添加后端UUID生成API：`GET /api/tape/generate-uuid`
  - 删除序列号刷新按钮，序列号由扫描结果自动生成
  - "应用信息"按钮仅在获得磁带标签后启用
  - 优化设备信息显示：隐藏"Unknown"序列号，代码块使用深底白字样式

#### 计划任务界面优化
- ✅ 优化计划任务弹出窗口布局
  - 任务名称和备份类型并排显示（第一行标签，第二行输入框）

## [0.0.9] - 2025-11-02

### 新增

- 计划任务目录浏览能力
  - 新增后端文件系统浏览接口：GET `/api/system/file-system/drives`、GET `/api/system/file-system/list?path=...`
  - Windows 使用 WinAPI 获取盘符，Linux 获取挂载点，统一返回结构
  - 前端新增左右分栏目录浏览器（驱动器/网络路径 + 目录/文件列表）
  - 支持输入网络路径（`\\server\share`、`//server/share`、`smb://...`）

- 备份管理与计划任务联动
  - 计划任务可选择备份模板执行，避免重复配置
  - 执行时自动生成备份记录并关联模板，防止同模板同日重复执行

### 改进

- 计划任务 UI 优化
  - 备份源路径支持多选与样式优化（卡片式、网络标签、路径截断）
  - 目录浏览器深色主题适配，文本高对比度，交互高亮
  - 表单布局优化：
    - “备份类型 + 目标磁带机”同一行两列
    - “启用压缩 + 启用加密 + 启用任务”同一行三列，并移动到“排除模式”上方

- 依赖与加载顺序
  - 全局引入 `axios.min.js`，修复 `axios is not defined` 问题（base 模板统一加载）
  - `scheduler.js` 作为 ES Module 导入并兼容全局 axios

- 系统与数据库
  - 数据库初始化引入所有模型，确保新表与枚举自动创建
  - 移除应用启动时的路由清单调试日志

### 修复

- SQLAlchemy Declarative 冲突：将 `metadata` 字段重命名为 `task_metadata`
- openGauss 版本解析导致任务加载报错的容错处理（记录日志，不阻塞表创建）


所有重要的变更都会记录在此文件中。

本文档遵循 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/) 格式。

## [0.0.8] - 2025-11-01

### 新增

#### 磁带创建和管理逻辑优化
- ✅ 完善磁带创建逻辑：月份选择默认当前月，创建和过期日期仅计算年月
  - 创建日期和过期日期计算只考虑年月，忽略具体日期
  - 过期判断仅比较年月：当前年月 >= 过期年月
  - 月份选择器默认选中当前月，添加提示文本
  - 实现磁带标签读取后自动填充：如果数据库已存在，禁用标签输入框并更新其他信息
  
#### 磁带标签保持不变机制
- ✅ 实现擦除和格式化后保留磁带标签
  - 擦除操作后自动重新写入原始标签，保留创建日期和过期日期
  - 格式化操作前读取现有标签，格式化成功后重新写入
  - 确保磁带标签在整个生命周期内保持恒定

### 修复

#### LTFS文件系统标签支持
- ✅ 修复Windows下LTFS环境中无法读取磁带标签的问题
  - 实现双模式标签读取/写入：优先使用LTFS文件系统（`O:\TAPE_LABEL.txt`），失败回退到SCSI磁带头
  - Windows系统且配置了LTFS盘符时，自动从文件系统读取标签
  - 兼容IBM LTFS环境中磁带设备被独占的情况
  - 解析LTFS格式的标签文件（TAPE_xxx, Created, Capacity字段）
  - 写入标签时同样优先写入LTFS文件系统
  
#### 时区感知datetime处理
- ✅ 修复过期判断时区问题：使用timezone-aware datetime进行比较
  - 数据库返回的是timezone-aware datetime，需要使用相同的类型进行比较
  - 统一使用datetime.now(timezone.utc)进行过期判断

## [0.0.7] - 2025-10-31

### 移除

#### UUID功能完全移除
- ✅ 移除所有UUID相关功能和代码
  - 从数据库模型中删除`tape_uuid`和`set_uuid`字段
  - 删除物理UUID读取相关的所有SCSI接口方法
  - 移除UUID读取失败的错误对话框
  - 删除磁带列表中的UUID显示
  - 简化磁带创建流程，取消UUID验证要求
  - 清理所有UUID相关的Windows Storage API和VPD读取代码

## [0.0.6] - 2025-10-30

### 新增

#### 磁带管理扫描结果模态框
- ✅ 添加磁带设备扫描结果详情显示
  - 扫描后显示完整设备信息（厂商、型号、序列号、设备类型、建议容量等）
  - 提供"应用信息"按钮自动填充表单
  - 改善用户体验

#### 磁带编辑功能
- ✅ 实现磁带记录编辑功能
  - 支持编辑磁带序列号、类型、容量、位置、备注
  - 主键(tape_id)和标签不允许修改
  - 添加PUT `/api/tape/{tape_id}` 更新API

#### 物理磁带标签读写
- ✅ 实现磁带物理标签自动读写功能
  - 创建磁带时自动写入标签到物理磁带
  - 读取磁带标签以检测是否已格式化
  - **独立的写入标签API**：POST `/api/tape/write-label`允许用户修改现有磁带的卷标
  - 智能格式化：仅未格式化磁带才格式化
  - 使用SCSI READ(16)/WRITE(16)命令直接操作磁带头部
  - 修复读写操作错误处理以检查success字段
  - **WMI到DOS路径映射**：自动将WMI DeviceID转换为Windows DOS设备路径
  - **磁带设备路径验证**：优先使用\\.\TAPEn路径，通过INQUIRY命令验证设备类型确保准确性

### 修复

#### IBM LTO检测修复
- ✅ 修复WMI识别vendor字段错误导致LTO检测失败
  - vendor为"LTO"时从model或path中提取IBM信息
  - 从model中提取LTO代数并设置建议容量
  - Windows/Linux平台全面修复

#### 磁带容量单位转换
- ✅ 修复TB转GB容量计算错误
  - 18TB应转换为18432GB（18 * 1024）
  - 更新前后端容量转换逻辑

#### 数据库枚举值大小写
- ✅ 修复PostgreSQL/OpenGauss枚举值区分大小写问题
  - 使用全大写枚举值（AVAILABLE, IN_USE, FULL等）
  - 统一前后端状态值格式

#### 磁带创建API兼容性
- ✅ 修复磁带创建API在OpenGauss上的兼容性问题
  - 使用psycopg2直接连接避免SQLAlchemy版本解析
  - 修复tape status枚举值大小写问题
  - `/api/tape/list`、`/api/tape/create`、`/api/tape/check`全面优化
  - 明确指定health_score默认值为100，确保新磁带显示健康而非严重

#### 磁带显示问题
- ✅ 修复磁带卡片显示异常
  - health_score为空时默认100分
  - 状态映射支持大小写（AVAILABLE/available等）
  - 添加过期时间显示
  - 类型和容量显示为"LTO-9 / 18.0 TB"格式
  - 使用容量显示为"实际使用/实际最大容量"

### 改进

#### 磁带默认值优化
- ✅ 添加磁带默认位置为"机房"
  - 新磁带创建时自动填充位置为"机房"

#### 磁带下拉选择器
- ✅ 修复磁带容量下拉选择器值匹配问题
  - 统一选项值格式（18TB而非18 TB）
  - 确保自动填充功能正常工作

#### 调试信息增强
- ✅ 添加数据库枚举类型创建和检查调试日志
  - 显示枚举类型值信息
  - 便于排查数据库兼容性问题

## [0.0.5] - 2025-10-29

### 新增

#### 模态框拖拽功能
- ✅ 实现所有模态框的可拖拽功能
  - 模态框内容区域可移动
  - 移除模态框透明度，改为不透明深色背景(#0d1626)
  - 改善模态框的用户交互体验

#### 数据库自动初始化
- ✅ OpenGauss数据库自动创建和权限配置
  - 自动检测数据库是否存在，不存在则创建
  - 自动设置数据库所有者权限
  - 自动配置public schema权限和默认权限
  - 使用psycopg2直接执行DDL语句

#### 磁带管理数据库集成
- ✅ 磁带列表API支持数据库查询
  - `/api/tape/list` - 从数据库获取所有磁带记录
  - `/api/tape/inventory` - 从数据库聚合统计信息
  - 支持磁带状态、位置、健康状态筛选
  - 支持磁带搜索功能

#### 磁带操作数据库同步
- ✅ 磁带操作自动同步到数据库
  - `load_tape` - 加载磁带时更新状态为in_use
  - `unload_tape` - 卸载磁带时更新状态为available
  - `erase_tape` - 擦除磁带时重置磁带信息
  - `write_data` - 写入数据后更新used_bytes和write_count

#### 磁带管理UI动态加载
- ✅ 磁带管理页面完全动态化
  - 统计卡片：磁带总数、可用磁带、已满磁带、错误磁带
  - 磁带列表：支持状态、位置、健康状态筛选
  - 磁带搜索：按标签、序列号、ID搜索
  - 磁带详情：动态显示完整磁带信息

### 修复

#### OpenGauss兼容性
- ✅ 修复OpenGauss版本字符串解析问题
  - 使用psycopg2直接连接，绕过SQLAlchemy版本解析
  - 修复DATETIME类型在OpenGauss中不支持的问题，改用TIMESTAMP
  - 修复ENUM类型创建问题，使用SQLAlchemy引擎生成SQL
  - 移除无效的server_version_check参数

#### 数据库初始化
- ✅ 修复数据库未初始化导致的RuntimeError
  - 统一使用全局db_manager实例
  - 修复main.py中创建新DatabaseManager实例的问题
  - 使用依赖注入get_db()获取数据库会话

#### 模态框显示
- ✅ 彻底禁用模态框遮罩层
  - 设置.modal-backdrop { display: none !important; }
  - 移除所有模态框的data-bs-backdrop属性或设为false
  - 设置模态框z-index为9999确保显示在最上层

#### 系统启动容错
- ✅ 系统启动时数据库连接失败不退出
  - 组件初始化失败时记录警告日志继续启动
  - 允许用户通过Web界面修复配置
  - 提供清晰的错误提示信息

### 改进

#### 磁带机配置页面
- ✅ 自动扫描磁带设备
  - 页面加载时自动触发设备扫描
  - 连接状态和已检测设备并排显示
  - 提高用户体验

#### 数据库健康检查
- ✅ OpenGauss数据库健康检查优化
  - 使用psycopg2直接连接，避免SQLAlchemy版本解析
  - 异步健康检查使用原生SQL语句
  - 添加5秒连接超时设置

#### API性能优化
- ✅ 减少重复API调用
  - `loadTapeStatistics`使用已加载的磁带数据
  - 优化DOMContentLoaded事件处理顺序
  - 提升页面加载速度

## [0.0.4] - 2025-10-28

### 修复

#### 模态框显示问题
- ✅ 修复所有模态框(modal)被遮罩层遮挡的问题
  - 设置模态框 z-index 为 9999
  - 设置遮罩层 z-index 为 9998
  - 确保所有弹窗(添加磁带、扫描磁带、添加通知人员等)正常显示

#### 配置保存优化
- ✅ 修复通知设置保存后被重载覆盖的问题
- ✅ 修复数据库配置保存后被重载覆盖的问题
- ✅ 修复磁带机配置保存后被重载覆盖的问题
- ✅ 保存配置后不再自动重载，保持用户输入内容

#### 数据库支持
- ✅ 添加 OpenGauss 数据库方言支持
  - 安装 `opengauss-sqlalchemy>=2.4.0` 依赖包
  - 支持在系统设置中选择 OpenGauss 数据库类型

#### 配置测试优化
- ✅ 数据库测试从输入框读取配置信息
- ✅ 通知测试从输入框读取配置信息
- ✅ 测试前不需要保存配置，实时验证

### 改进

#### UI统一性增强
- ✅ 统一所有页面使用 console-panel 和 service-card 样式
- ✅ 首页、备份管理、恢复管理、磁带管理等页面视觉一致
- ✅ 首页磁带设备状态动态加载
- ✅ 提高文字亮度，改善深色背景下的可读性

#### 导航优化
- ✅ 磁带机配置提升为独立的顶级导航项
- ✅ 系统设置移除磁带机配置选项卡
- ✅ 系统设置默认显示"常规设置"选项卡
- ✅ 优化选中标签的文字颜色和背景

## [0.0.3] - 2025-10-28

### 新增

#### 用户界面全面升级
- ✅ 应用现代暗色科技主题界面
  - 从.sample目录引入完整的UI组件和样式
  - 深色背景色(#0a0e17)配合紫色系主题
  - 响应式布局，支持各种屏幕尺寸
- ✅ 丰富的视觉背景效果
  - 粒子动画效果(particles.js)
  - 电路板图案覆盖层
  - 数据流动画背景
  - 毛玻璃模糊效果(backdrop-filter)
- ✅ 优化的导航栏设计
  - 固定顶部导航栏
  - 半透明背景与模糊效果
  - 悬停和激活状态的平滑过渡动画
  - 用户头像和版本信息显示
- ✅ 控制台面板(console-panel)样式
  - 半透明卡片的毛玻璃效果
  - 圆角边框和阴影
  - 悬停时的上浮动画效果
- ✅ 服务卡片(service-card)组件
  - 顶部彩色渐变条
  - 图标容器样式
  - 状态指示器可视化
- ✅ 首页完全重构
  - 系统状态卡片展示
  - 快速操作按钮
  - 系统信息表格
  - 响应式栅格布局

### 改进

- ✅ 配色方案更新
  - 主色调从蓝色改为紫色(#8b7cf6)
  - 更适合磁带备份系统的科技感
  - 统一的色彩变量系统
- ✅ 字体系统优化
  - 使用AlimamaDaoLiTi字体
  - 统一的基础字体大小(0.9rem)
  - 导航、标题、正文分层字体大小
- ✅ 静态资源整理
  - 引入Bootstrap Icons图标库
  - 引入Particles.js动画库
  - 引入Marked.js Markdown渲染
  - 整理CSS/JS/图片资源结构

### 技术细节

#### 前端资源
- `web/static/css/ai.css` - 主样式文件(紫色主题)
- `web/static/js/components/backgroundEffects.js` - 背景效果
- `web/static/js/vendor/` - 第三方库文件
- `web/static/img/` - Logo和装饰图片

#### 模板更新
- `web/templates/base.html` - 基础模板全面重构
- `web/templates/index.html` - 首页应用新UI风格

#### UI特性
- CSS变量系统支持主题定制
- 响应式设计，移动端友好
- 动画过渡效果，提升用户体验
- 毛玻璃和模糊效果，现代感强

## [0.0.2] - 2025-10-28

### 新增

#### 磁带机配置增强
- ✅ 最大卷大小单位改为GB显示（更用户友好）
- ✅ 已检测设备显示磁盘容量和LTO代数信息
- ✅ 设备列表增强显示（厂商、型号、路径、容量、状态）

#### 通知系统增强
- ✅ 完整的通知事件配置界面
  - 备份相关：成功、开始、失败
  - 恢复相关：成功、失败
  - 磁带相关：更换、过期、错误
  - 系统相关：容量预警、系统错误
- ✅ 通知人员管理界面
  - 添加通知人员模态框
  - 支持多人员通知配置

#### 备份任务创建增强
- ✅ 新增备份类型支持
  - 完整备份 (Full Backup)
  - 增量备份 (Incremental)
  - 差异备份 (Differential)
  - 镜像备份 (Mirror) - 新增
  - 归档备份 (Archive) - 新增
  - 快照备份 (Snapshot) - 新增
- ✅ 源路径选择改进
  - 输入框支持多路径
  - 浏览按钮（待实现文件选择对话框）
- ✅ 备份目标选择
  - 磁盘存储
  - 磁带机（可选择具体磁带）

#### SCSI接口增强
- ✅ 新增磁带SCSI操作命令
  - format_tape - 格式化磁带
  - erase_tape - 擦除磁带
  - load_unload - 加载/卸载
  - space_blocks - 按块定位
  - write_filemarks - 写入文件标记
  - set_mark - 设置磁带标记
- ✅ 新增磁带操作API端点
  - POST /api/tape/format - 格式化
  - POST /api/tape/rewind - 倒带
  - POST /api/tape/space - 定位

## [0.0.1] - 2025-10-28

### 新增

#### 配置管理
- ✅ 新增 `.env.sample` 配置模板文件
- ✅ 新增 `SystemConfig` 数据模型（`models/system_config.py`）
- ✅ 新增 `SystemConfigManager` 配置管理器（`config/config_manager.py`）
- ✅ 新增 Web界面数据库配置功能
- ✅ 支持多数据库类型（SQLite、PostgreSQL、openGauss、MySQL）
- ✅ 配置参数自动从.env文件加载
- ✅ 数据库配置支持Web界面修改

#### 文档
- ✅ `README.md` - 项目说明文档
- ✅ `docs/系统架构.md` - 系统架构说明
- ✅ `docs/使用说明.md` - 用户使用指南
- ✅ `docs/开发说明.md` - 开发指南
- ✅ `docs/配置管理说明.md` - 配置管理说明
- ✅ `docs/数据库配置说明.md` - 数据库配置说明
- ✅ `docs/数据库配置测试说明.md` - 数据库配置测试指南
- ✅ `docs/配置参数存储规划.md` - 配置存储策略
- ✅ `docs/配置系统优化总结.md` - 配置系统优化总结
- ✅ `docs/仅使用OpenGauss的可行性说明.md` - OpenGauss使用说明
- ✅ `docs/Redis和Celery使用说明.md` - Redis/Celery使用说明
- ✅ `docs/IBM磁带机API使用示例.md` - IBM磁带机API示例
- ✅ `docs/IBM磁带机快速开始指南.md` - IBM磁带机快速开始
- ✅ `docs/IBM磁带机集成说明.md` - IBM磁带机集成说明

#### 核心功能
- ✅ 备份引擎（`backup/backup_engine.py`）
- ✅ 恢复引擎（`recovery/recovery_engine.py`）
- ✅ 磁带管理器（`tape/tape_manager.py`）
- ✅ 磁带操作（`tape/tape_operations.py`）
- ✅ SCSI接口（`tape/scsi_interface.py`）
- ✅ 核心备份处理器（`mcp/core.py`）
- ✅ 计划任务调度器（`utils/scheduler.py`）
- ✅ 钉钉通知器（`utils/dingtalk_notifier.py`）
- ✅ 日志管理器（`utils/logger.py`）

#### Web界面
- ✅ 主入口（`web/app.py`）
- ✅ 备份管理API（`web/api/backup.py`）
- ✅ 恢复管理API（`web/api/recovery.py`）
- ✅ 磁带管理API（`web/api/tape.py`）
- ✅ 系统管理API（`web/api/system.py`）
- ✅ 用户管理API（`web/api/user.py`）
- ✅ 认证中间件（`web/middleware/auth_middleware.py`）
- ✅ 日志中间件（`web/middleware/logging_middleware.py`）
- ✅ HTML模板（`web/templates/`）
  - index.html - 首页
  - backup.html - 备份管理
  - recovery.html - 恢复管理
  - tape.html - 磁带管理
  - system.html - 系统设置
  - base.html - 基础模板

#### 数据模型
- ✅ 基础模型（`models/base.py`）
- ✅ 备份模型（`models/backup.py`）
- ✅ 磁带模型（`models/tape.py`）
- ✅ 用户模型（`models/user.py`）
- ✅ 系统日志模型（`models/system_log.py`）
- ✅ 系统配置模型（`models/system_config.py`）

#### 静态资源
- ✅ CSS样式（`web/static/css/main.css`）
- ✅ JavaScript（`web/static/js/main.js`）
- ✅ Markdown渲染支持

#### 测试
- ✅ 测试框架配置（`tests/conftest.py`）
- ✅ 备份功能测试（`tests/test_backup.py`）
- ✅ 磁带功能测试（`tests/test_tape.py`）
- ✅ 配置功能测试（`tests/test_config.py`）

#### 文档
- ✅ `SCSI接口实现分析报告.md` - SCSI接口分析

### 修改

#### 配置优化
- ✅ 脱敏敏感配置信息（密码、密钥）
- ✅ 补充配置参数（ENVIRONMENT, WEB_HOST, ENABLE_CORS等）
- ✅ 统一Base模型引用
- ✅ 优化配置加载逻辑
- ✅ 数据库文件路径标准化（移动到data目录）
- ✅ 版本号从1.0.0调整为0.0.1
- ✅ 完善.env和.env.sample文件

#### 数据库
- ✅ 优化openGauss版本检测处理
- ✅ 支持异步和同步数据库操作
- ✅ 添加数据库连接池配置
- ✅ 改进数据库健康检查
- ✅ 支持SQLite数据库文件路径配置

### 安全

- ✅ 敏感信息脱敏处理
- ✅ 密码字段加密存储
- ✅ JWT令牌认证
- ✅ 输入验证和SQL注入防护

### 文档

- ✅ 完善README.md项目说明
- ✅ 添加详细的配置说明文档
- ✅ 补充开发和使用指南
- ✅ 创建系统架构文档

### 已知问题

- ⚠️ 磁带设备检测功能需要实际硬件测试
- ⚠️ 部分核心功能需要实际业务验证
- ⚠️ 计划任务持久化待完善

### 待办事项

- 🔲 标准LOG SENSE解析优化
- 🔲 MODE SENSE/SELECT完善
- 🔲 UI SCSI状态显示
- 🔲 实现Celery分布式任务（可选）
- 🔲 添加配置加密功能
- 🔲 完善Web界面交互
- 🔲 增加更多测试用例
- 🔲 实现配置版本管理

### 版本管理

- ✅ 新增CHANGELOG.md版本管理文件
- ✅ 实现版本API接口（GET /api/system/version）
- ✅ 添加UI版本显示和弹窗功能
- ✅ 优化数据库文件路径管理（data/taf_backup.db）
- ✅ 配置参数脱敏和标准化

#### SCSI接口重构

- ✅ 完善Windows SCSI Pass Through完整实现
  - 完整实现SCSI_PASS_THROUGH结构填充
  - 正确执行DeviceIoControl调用
  - 支持数据双向传输
- ✅ 修复Linux SG_IO导入问题
  - 优化平台特定导入逻辑
  - 确保fcntl正确可用
- ✅ 实现READ/WRITE SCSI命令
  - READ(16) 和 WRITE(16)完整实现
  - 支持64位LBA寻址
  - 替换旧式READ/WRITE(6)
- ✅ 添加SCSI命令重试机制
  - 指数退避重试策略
  - 智能错误类型判断
  - 自动处理临时性错误
- ✅ 实现设备热插拔监控
  - 设备连接/断开自动检测
  - 状态变化事件通知
  - 监控任务管理
- ✅ 优化SCSI接口架构
  - 代码结构优化
  - 错误处理增强
  - 日志记录完善

#### 磁带机配置UI

- ✅ 新增磁带机配置标签页
  - 设备路径配置
  - 块大小和卷大小配置
  - 磁带池配置
- ✅ 实现配置API
  - GET /api/system/tape/config - 获取配置
  - POST /api/system/tape/test - 测试连接
  - PUT /api/system/tape/config - 保存配置
  - GET /api/system/tape/scan - 扫描设备
- ✅ 设备扫描和测试
  - 实时扫描磁带设备
  - 连接状态测试
  - 设备列表显示

#### Bug修复

- ✅ 数据库健康检查修复（text导入）
- ✅ Recovery API Request参数修复
- ✅ 数据库配置密码自动填充
- ✅ 磁带连接测试逻辑优化
- ✅ 错误处理改进

#### 文档

- ✅ `SCSI接口重构总结.md` - SCSI重构文档
- ✅ `Build_Summary_20241101.md` - 构建总结

## [未发布]

### 计划

- 标准LOG SENSE解析（需要IBM文档参考）
- MODE SENSE/SELECT完整实现
- UI SCSI状态显示增强
- 配置加密功能
- 配置导入/导出
- 配置变更历史
- 配置版本回滚
- 更多监控指标
- 性能优化

---

**企业级磁带备份系统**
项目地址: https://github.com/grigs28/TAF
版本：v0.0.5

