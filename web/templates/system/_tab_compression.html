<!-- 压缩配置标签页 -->
<div class="tab-pane fade" id="compression" role="tabpanel" aria-labelledby="compression-tab">
    <div class="container-fluid py-4">
        <h5 class="mb-4">
            <i class="bi bi-archive me-2"></i>压缩配置
        </h5>
        
        <form id="compressionConfigForm">
            <div class="row">
                <div class="col-md-8">
                    <!-- 压缩方法选择 -->
                    <div class="mb-3">
                        <label for="compressionMethod" class="form-label">
                            压缩方法 <span class="text-danger">*</span>
                        </label>
                        <select class="form-select bg-dark text-light" id="compressionMethod" name="compression_method" required>
                            <option value="pgzip">PGZip (多线程GZip，默认)</option>
                            <option value="py7zr">py7zr (Python库，不支持多线程)</option>
                            <option value="7zip_command">7-Zip命令行 (支持多线程，推荐)</option>
                            <option value="tar">tar (仅打包，不压缩)</option>
                            <option value="zstd">Zstandard (高压缩效率)</option>
                        </select>
                        <small class="form-text text-muted">
                            选择压缩方法。PGZip默认开启，可在需要更高压缩率时切换到7-Zip或Zstandard。
                        </small>
                    </div>
                    
                    <!-- 7-Zip程序路径配置 -->
                    <div class="mb-3" id="sevenzipPathGroup">
                        <label for="sevenzipPath" class="form-label">
                            7-Zip程序路径 <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control bg-dark text-light" id="sevenzipPath" 
                                   name="sevenzip_path" placeholder="C:\Program Files\7-Zip\7z.exe" required>
                            <button class="btn btn-outline-secondary" type="button" id="browseSevenzipBtn">
                                <i class="bi bi-folder me-1"></i>浏览
                            </button>
                            <button class="btn btn-outline-info" type="button" id="checkSevenzipBtn" title="检查路径有效性">
                                <i class="bi bi-check-circle me-1"></i>检查
                            </button>
                            <button class="btn btn-outline-info" type="button" id="autoFindSevenzipBtn" title="自动查找7-Zip">
                                <i class="bi bi-search me-1"></i>自动查找
                            </button>
                        </div>
                        <small class="form-text text-muted" id="sevenzipPathHelp">
                            指定7-Zip可执行文件 (7z.exe) 的完整路径。
                        </small>
                        <div id="sevenzipPathStatus" class="mt-2"></div>
                    </div>
                    
                    <!-- Python/PGZip线程数配置 -->
                    <div class="mb-3" id="compressionThreadsGroup">
                        <label for="compressionThreads" class="form-label">
                            Python/PGZip线程数
                        </label>
                        <input type="number" class="form-control bg-dark text-light" id="compressionThreads" 
                               name="compression_threads" min="1" max="64" value="4">
                        <small class="form-text text-muted">
                            适用于PGZip与py7zr，建议设置为CPU核心数。
                        </small>
                    </div>

                    <!-- zstd线程数 -->
                    <div class="mb-3" id="zstdThreadsGroup" style="display: none;">
                        <label for="zstdThreads" class="form-label">
                            Zstandard线程数
                        </label>
                        <input type="number" class="form-control bg-dark text-light" id="zstdThreads"
                               name="zstd_threads" min="1" max="64" value="4">
                        <small class="form-text text-muted">
                            用于 Zstandard 压缩模式，控制压缩线程数。
                        </small>
                    </div>
                    
                    <!-- PGZip块大小 -->
                    <div class="mb-3" id="pgzipBlockSizeGroup">
                        <label for="pgzipBlockSize" class="form-label">
                            PGZip块大小 <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control bg-dark text-light" id="pgzipBlockSize"
                                   name="pgzip_block_size" value="1M" placeholder="例如 1M、512M、1G">
                            <span class="input-group-text">默认 1M</span>
                        </div>
                        <small class="form-text text-muted">
                            控制PGZip的块大小，支持 K/M/G 单位。块越大压缩越快，压缩率略低。
                        </small>
                    </div>
                    
                    <!-- 7-Zip命令行线程数配置 -->
                    <div class="mb-3" id="compressionCommandThreadsGroup">
                        <label for="compressionCommandThreads" class="form-label">
                            7-Zip命令行线程数 (-mmt参数) <span class="text-danger">*</span>
                        </label>
                        <input type="number" class="form-control bg-dark text-light" id="compressionCommandThreads" 
                               name="compression_command_threads" min="1" max="64" value="4" required>
                        <small class="form-text text-muted">
                            7-Zip命令行工具使用的线程数（-mmt参数）。建议值：CPU核心数。当前CPU核心数: <span id="cpuCount"></span>
                        </small>
                    </div>
                    
                    <!-- 压缩级别 -->
                    <div class="mb-3">
                        <label for="compressionLevel" class="form-label">
                            压缩级别 <span class="text-danger">*</span>
                        </label>
                        <input type="range" class="form-range" id="compressionLevel" name="compression_level" 
                               min="0" max="9" value="5" oninput="updateCompressionLevelDisplay(this.value)">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">0 (不压缩)</small>
                            <small class="text-muted" id="compressionLevelDisplay">5 (平衡)</small>
                            <small class="text-muted">9 (最高)</small>
                        </div>
                        <small class="form-text text-muted">
                            压缩级别：0=不压缩，1-3=快速，4-6=平衡（推荐5），7-9=最高压缩。
                        </small>
                    </div>
                    
                    <!-- 直接压缩到磁带 -->
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="compressDirectlyToTape" 
                                   name="compress_directly_to_tape" checked>
                            <label class="form-check-label" for="compressDirectlyToTape">
                                直接压缩到磁带机
                            </label>
                        </div>
                        <small class="form-text text-muted">
                            启用后，压缩文件将直接写入磁带盘符（O盘），跳过 temp/final 目录。禁用后将使用原有流程（先压缩到临时目录，再移动到磁带机）。
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- 操作按钮 -->
            <div class="row mt-4">
                <div class="col-md-8">
                    <button type="button" class="btn btn-secondary" id="resetCompressionConfigBtn">
                        <i class="bi bi-arrow-counterclockwise me-2"></i>重置为默认值
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// 显示消息函数（复用scheduler-utils中的实现）
function showMessage(message, type = 'info') {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-danger' : 
                      type === 'warning' ? 'alert-warning' : 'alert-info';
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert ${alertClass} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}

// 更新压缩级别显示
function updateCompressionLevelDisplay(value) {
    const display = document.getElementById('compressionLevelDisplay');
    const levelNames = {
        0: '0 (不压缩)',
        1: '1 (快速)',
        2: '2 (快速)',
        3: '3 (快速)',
        4: '4 (平衡)',
        5: '5 (平衡)',
        6: '6 (平衡)',
        7: '7 (最高)',
        8: '8 (最高)',
        9: '9 (最高)'
    };
    display.textContent = levelNames[value] || value;
}

// 压缩配置管理
document.addEventListener('DOMContentLoaded', function() {
    // 获取CPU核心数
    const cpuCount = navigator.hardwareConcurrency || 4;
    const cpuCountEl = document.getElementById('cpuCount');
    if (cpuCountEl) {
        cpuCountEl.textContent = cpuCount;
        // 设置默认线程数为CPU核心数（如果输入框为空）
        const threadsInput = document.getElementById('compressionCommandThreads');
        if (threadsInput && !threadsInput.value) {
            threadsInput.value = cpuCount;
        }
    }
    
    // 加载压缩配置
    loadCompressionConfig();
    
    // 压缩方法改变时的处理
    const compressionMethodSelect = document.getElementById('compressionMethod');
    if (compressionMethodSelect) {
        compressionMethodSelect.addEventListener('change', function() {
            updateCompressionMethodUI(this.value);
        });
    }
    
    // 浏览7-Zip路径按钮
    const browseBtn = document.getElementById('browseSevenzipBtn');
    if (browseBtn) {
        browseBtn.addEventListener('click', function() {
            // 注意：浏览器安全限制，无法直接使用文件选择器选择可执行文件
            // 提示用户手动输入路径
            const path = prompt('请输入7-Zip程序路径 (7z.exe):', 
                document.getElementById('sevenzipPath').value || 'C:\\Program Files\\7-Zip\\7z.exe');
            if (path) {
                document.getElementById('sevenzipPath').value = path;
                // 自动检查路径
                checkSevenzipPath(path);
            }
        });
    }
    
    // 检查7-Zip路径按钮
    const checkBtn = document.getElementById('checkSevenzipBtn');
    if (checkBtn) {
        checkBtn.addEventListener('click', function() {
            const path = document.getElementById('sevenzipPath').value;
            if (path) {
                checkSevenzipPath(path);
            } else {
                showMessage('请先输入7-Zip程序路径', 'warning');
            }
        });
    }
    
    // 自动查找7-Zip按钮
    const autoFindBtn = document.getElementById('autoFindSevenzipBtn');
    if (autoFindBtn) {
        autoFindBtn.addEventListener('click', function() {
            autoFindSevenzip();
        });
    }
    
    // 重置配置按钮
    const resetBtn = document.getElementById('resetCompressionConfigBtn');
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            if (confirm('确定要重置压缩配置为默认值吗？')) {
                resetCompressionConfig();
            }
        });
    }
});

// 加载压缩配置
async function loadCompressionConfig() {
    try {
        const response = await fetch('/api/system/compression');
        if (!response.ok) {
            throw new Error('获取配置失败');
        }
        const config = await response.json();
        
        // 填充表单
        const methodSelect = document.getElementById('compressionMethod');
        if (methodSelect) {
            methodSelect.value = config.compression_method || 'pgzip';
            updateCompressionMethodUI(methodSelect.value);
        }
        if (config.sevenzip_path) {
            document.getElementById('sevenzipPath').value = config.sevenzip_path;
        }
        const pythonThreadsInput = document.getElementById('compressionThreads');
        if (pythonThreadsInput) {
            pythonThreadsInput.value = config.pgzip_threads ?? config.compression_threads ?? pythonThreadsInput.value;
        }
        if (config.compression_command_threads !== undefined) {
            document.getElementById('compressionCommandThreads').value = config.compression_command_threads;
        }
        if (config.compression_level !== undefined) {
            document.getElementById('compressionLevel').value = config.compression_level;
            updateCompressionLevelDisplay(config.compression_level);
        }
        if (config.compress_directly_to_tape !== undefined) {
            document.getElementById('compressDirectlyToTape').checked = config.compress_directly_to_tape;
        }
        if (config.pgzip_block_size) {
            document.getElementById('pgzipBlockSize').value = config.pgzip_block_size;
        }
        if (config.zstd_threads !== undefined) {
            document.getElementById('zstdThreads').value = config.zstd_threads;
        }
        
        // 自动检查7-Zip路径
        if (config.sevenzip_path) {
            checkSevenzipPath(config.sevenzip_path);
        }
        
    } catch (error) {
        console.error('加载压缩配置失败:', error);
        showMessage('加载压缩配置失败: ' + error.message, 'error');
    }
}

// 更新压缩方法UI
function updateCompressionMethodUI(method) {
    const sevenzipPathGroup = document.getElementById('sevenzipPathGroup');
    const compressionThreadsGroup = document.getElementById('compressionThreadsGroup');
    const compressionCommandThreadsGroup = document.getElementById('compressionCommandThreadsGroup');
    const pgzipBlockSizeGroup = document.getElementById('pgzipBlockSizeGroup');
    const zstdThreadsGroup = document.getElementById('zstdThreadsGroup');
    method = method || 'pgzip';

    if (method === '7zip_command') {
        sevenzipPathGroup.style.display = 'block';
        compressionCommandThreadsGroup.style.display = 'block';
        compressionThreadsGroup.style.display = 'none';
        pgzipBlockSizeGroup.style.display = 'none';
        zstdThreadsGroup.style.display = 'none';
        document.getElementById('sevenzipPath').required = true;
        document.getElementById('compressionCommandThreads').required = true;
    } else if (method === 'pgzip') {
        sevenzipPathGroup.style.display = 'none';
        compressionCommandThreadsGroup.style.display = 'none';
        compressionThreadsGroup.style.display = 'block';
        pgzipBlockSizeGroup.style.display = 'block';
        zstdThreadsGroup.style.display = 'none';
        document.getElementById('sevenzipPath').required = false;
        document.getElementById('compressionCommandThreads').required = false;
    } else if (method === 'tar') {
        sevenzipPathGroup.style.display = 'none';
        compressionCommandThreadsGroup.style.display = 'none';
        compressionThreadsGroup.style.display = 'none';
        pgzipBlockSizeGroup.style.display = 'none';
        zstdThreadsGroup.style.display = 'none';
        document.getElementById('sevenzipPath').required = false;
        document.getElementById('compressionCommandThreads').required = false;
    } else if (method === 'zstd') {
        sevenzipPathGroup.style.display = 'none';
        compressionCommandThreadsGroup.style.display = 'none';
        compressionThreadsGroup.style.display = 'none';
        pgzipBlockSizeGroup.style.display = 'none';
        zstdThreadsGroup.style.display = 'block';
        document.getElementById('sevenzipPath').required = false;
        document.getElementById('compressionCommandThreads').required = false;
    } else {
        sevenzipPathGroup.style.display = 'none';
        compressionCommandThreadsGroup.style.display = 'none';
        compressionThreadsGroup.style.display = 'block';
        pgzipBlockSizeGroup.style.display = 'none';
        zstdThreadsGroup.style.display = 'none';
        document.getElementById('sevenzipPath').required = false;
        document.getElementById('compressionCommandThreads').required = false;
    }
}

// 检查7-Zip路径
async function checkSevenzipPath(path) {
    const statusDiv = document.getElementById('sevenzipPathStatus');
    statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>检查中...';
    
    try {
        const response = await fetch(`/api/system/compression/check-sevenzip?path=${encodeURIComponent(path)}`);
        const result = await response.json();
        
        if (result.is_valid) {
            statusDiv.innerHTML = '<div class="text-success"><i class="bi bi-check-circle me-1"></i>路径有效</div>';
        } else {
            statusDiv.innerHTML = `<div class="text-danger"><i class="bi bi-x-circle me-1"></i>${result.message || '路径无效'}</div>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<div class="text-danger"><i class="bi bi-x-circle me-1"></i>检查失败: ${error.message}</div>`;
    }
}

// 自动查找7-Zip
async function autoFindSevenzip() {
    const statusDiv = document.getElementById('sevenzipPathStatus');
    statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>查找中...';
    
    try {
        const response = await fetch('/api/system/compression/check-sevenzip');
        const result = await response.json();
        
        if (result.found_paths && result.found_paths.length > 0) {
            // 使用第一个找到的路径
            const foundPath = result.found_paths[0].path;
            document.getElementById('sevenzipPath').value = foundPath;
            statusDiv.innerHTML = `<div class="text-success"><i class="bi bi-check-circle me-1"></i>已找到: ${foundPath}</div>`;
            
            // 自动检查路径
            checkSevenzipPath(foundPath);
        } else {
            statusDiv.innerHTML = '<div class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>未找到7-Zip，请手动指定路径</div>';
        }
    } catch (error) {
        statusDiv.innerHTML = `<div class="text-danger"><i class="bi bi-x-circle me-1"></i>查找失败: ${error.message}</div>`;
    }
}

// 保存压缩配置
async function saveCompressionConfig(options = {}) {
    const { silent = false, reload = true } = options;
    const form = document.getElementById('compressionConfigForm');
    const formData = new FormData(form);
    
    const config = {
        compression_method: formData.get('compression_method'),
        sevenzip_path: formData.get('sevenzip_path') || undefined,
        compression_threads: parseInt(formData.get('compression_threads')) || undefined,
        compression_command_threads: parseInt(formData.get('compression_command_threads')) || undefined,
        compression_level: parseInt(formData.get('compression_level')) || undefined,
        compress_directly_to_tape: document.getElementById('compressDirectlyToTape').checked,
        pgzip_block_size: formData.get('pgzip_block_size') || undefined,
        pgzip_threads: parseInt(formData.get('compression_threads')) || undefined,
        zstd_threads: parseInt(formData.get('zstd_threads')) || undefined,
    };
    
    try {
        const response = await fetch('/api/system/compression', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(config)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || '保存失败');
        }
        
        await response.json();
        if (!silent) {
            showMessage('压缩配置保存成功', 'success');
        }
        
        if (reload) {
            await loadCompressionConfig();
        }
        return true;
        
    } catch (error) {
        console.error('保存压缩配置失败:', error);
        if (!silent) {
            showMessage('保存压缩配置失败: ' + error.message, 'error');
        }
        throw error;
    }
}

// 重置压缩配置
async function resetCompressionConfig() {
    try {
        // 重置为默认值
        document.getElementById('compressionMethod').value = 'pgzip';
        document.getElementById('sevenzipPath').value = 'C:\\Program Files\\7-Zip\\7z.exe';
        document.getElementById('compressionThreads').value = '4';
        document.getElementById('compressionCommandThreads').value = '4';
        document.getElementById('compressionLevel').value = '5';
        document.getElementById('pgzipBlockSize').value = '1G';
        document.getElementById('compressDirectlyToTape').checked = true;
        updateCompressionLevelDisplay('5');
        updateCompressionMethodUI('pgzip');
        
        // 保存默认配置
        await saveCompressionConfig();
        
    } catch (error) {
        console.error('重置压缩配置失败:', error);
        showMessage('重置压缩配置失败: ' + error.message, 'error');
    }
}

</script>

