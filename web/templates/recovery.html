{% extends "base.html" %}

{% block title %}{{ app_name }} - 数据恢复{% endblock %}

{% block extra_css %}
<style>
:root { --recoveryPaneHeight: 720px; }
.backup-set-card {
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
}
.backup-set-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.backup-set-full { border-left-color: #28a745; }
.backup-set-incremental { border-left-color: #007bff; }
.backup-set-differential { border-left-color: #ffc107; }

.file-tree {
    max-height: var(--recoveryPaneHeight);
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 4px;
}

.tree-node {
    padding: 4px 8px;
    cursor: pointer;
    transition: background-color 0.2s;
}
.tree-node:hover {
    background-color: #f8f9fa;
}
.tree-node.selected {
    background-color: #e3f2fd;
}
</style>
{% endblock %}

{% block content %}
<div class="console-panel">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="mb-0">
            <i class="bi bi-cloud-download me-2"></i>数据恢复
        </h5>
        <button class="btn btn-success" id="startRecoveryBtn" disabled>
            <i class="bi bi-play-circle me-2"></i>开始恢复
        </button>
    </div>

    <div class="row">
        <!-- 备份集时间轴 -->
        <div class="col-lg-4">
            <div class="service-card">
                <div class="card-body">
                    <h6 class="mb-2">
                        <i class="bi bi-calendar-event me-2"></i>
                        备份集时间轴
                    </h6>
                    <!-- 当前备份集信息（移动到时间轴区域） -->
                    <div class="alert alert-info py-2 mb-3">
                        <strong>当前备份集:</strong>
                        <span id="currentBackupName">完整备份 (2025-10-01 02:00)</span>
                        <button class="btn btn-sm btn-outline-secondary float-end" id="changeBackupBtn">
                            <i class="bi bi-arrow-left-right me-1"></i>切换
                        </button>
                    </div>
                    <!-- 月份选择 -->
                    <div class="mb-3">
                        <select class="form-select" id="monthSelect">
                            <option value="">加载中...</option>
                        </select>
                    </div>

                    <!-- 备份集列表 -->
                    <div class="backup-timeline">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-hourglass-split me-2"></i>正在加载备份集...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 文件浏览器 -->
        <div class="col-lg-8">
            <div class="service-card">
                <div class="card-body">
                    <h6 class="mb-3">
                        <i class="bi bi-folder-open me-2"></i>
                        文件浏览器
                    </h6>
                    <!-- 当前备份集信息已移动到左侧时间轴区域 -->

                    <!-- 搜索和筛选 -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="搜索文件或文件夹..." id="fileSearch">
                                <button class="btn btn-outline-secondary" type="button">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="fileTypeFilter">
                                <option>所有文件</option>
                                <option>仅显示文件</option>
                                <option>仅显示文件夹</option>
                            </select>
                        </div>
                    </div>

                    <!-- 文件树 -->
                    <div class="file-tree" id="fileTree">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-info-circle me-2"></i>请先选择备份集
                        </div>
                    </div>

                    <!-- 选中文件统计 -->
                    <div class="mt-3 p-3 service-card rounded">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>选中文件:</strong>
                                <span class="text-primary" id="selectedCount">0</span>
                            </div>
                            <div class="col-md-3">
                                <strong>总大小:</strong>
                                <span id="selectedSize">0 KB</span>
                            </div>
                            <div class="col-md-3">
                                <strong>包含文件夹:</strong>
                                <span id="folderCount">0</span>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-sm btn-outline-primary" id="selectAllBtn">
                                    <i class="bi bi-check-square me-1"></i>全选
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" id="clearSelectionBtn">
                                    <i class="bi bi-x-circle me-1"></i>清除
                                </button>
                            </div>
                        </div>
                        <!-- 选中文件列表 -->
                        <div class="mt-3">
                            <div class="list-group" id="selectedFilesList" style="max-height: var(--recoveryPaneHeight); overflow-y: auto;"></div>
                        </div>
                    </div>

                    <!-- 恢复选项 -->
                    <hr class="my-4">
                    <h6 class="mb-3">
                        <i class="bi bi-gear me-2"></i>
                        恢复选项
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">恢复目标路径 <small class="text-muted ms-2">文件将恢复到此目录</small></label>
                            <div class="input-group">
                                <input type="text" class="form-control" value="/tmp/recovery" id="recoveryPath">
                                <button class="btn btn-outline-secondary" type="button" id="browseRecoveryPathBtn">
                                    <i class="bi bi-folder2-open me-1"></i>浏览
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">覆盖选项</label>
                            <select class="form-select" id="overwriteOption">
                                <option value="ask">询问是否覆盖</option>
                                <option value="skip">跳过已存在的文件</option>
                                <option value="overwrite">覆盖所有文件</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="preservePerms" checked>
                                <label class="form-check-label" for="preservePerms">保留文件权限</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="verifyIntegrity" checked>
                                <label class="form-check-label" for="verifyIntegrity">验证文件完整性</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sendNotification" checked>
                                <label class="form-check-label" for="sendNotification">发送完成通知</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.backup-timeline {
    flex: 1;
    overflow-y: auto;
    max-height: var(--recoveryPaneHeight);
    margin-left: -25px;
    margin-right: -25px;
    padding-left: 25px;
    padding-right: 25px;
}

.backup-set-card {
    cursor: pointer;
}
.backup-set-card.selected {
    background-color: #e3f2fd;
    border-color: #2196f3 !important;
}

.tree-node {
    display: flex;
    align-items: center;
    padding: 4px 8px;
    border-radius: 4px;
    margin: 1px 0;
}

.tree-node:hover {
    background-color: #f8f9fa;
}

.tree-node.selected {
    background-color: #e3f2fd;
}
</style>
<script>
// 恢复页文件树与选中列表联动
(function() {
    const treeRoot = document.getElementById('fileTree');
    if (!treeRoot) return;

    const selectedCountEl = document.getElementById('selectedCount');
    const selectedSizeEl = document.getElementById('selectedSize');
    const folderCountEl = document.getElementById('folderCount');
    const listEl = document.getElementById('selectedFilesList');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const clearSelectionBtn = document.getElementById('clearSelectionBtn');
    const monthSelect = document.getElementById('monthSelect');
    const changeBackupBtn = document.getElementById('changeBackupBtn');
    const timeline = document.querySelector('.backup-timeline');
    const currentBackupNameEl = document.getElementById('currentBackupName');
    const startRecoveryBtn = document.getElementById('startRecoveryBtn');
    const fileSearch = document.getElementById('fileSearch');
    const fileTypeFilter = document.getElementById('fileTypeFilter');

    let autoId = 1;
    const fileIndex = new Map(); // id -> {el,type,sizeBytes,children:[],name}
    const selectedFiles = new Set(); // only files
    const selectedFolders = new Set();
    let currentBackupSetId = null;
    let allFiles = []; // 存储所有文件数据

    // 格式化字节大小
    function formatBytes(b){
        const units = ['B','KB','MB','GB','TB'];
        let i=0; let v=b;
        while (v>=1024 && i<units.length-1){ v/=1024; i++; }
        return (i===0? v : v.toFixed(1)) + ' ' + units[i];
    }

    function bytesFromText(txt){
        if (!txt) return 0;
        const m = String(txt).trim().match(/([0-9]+(?:\.[0-9]+)?)\s*(KB|MB|GB|TB|B)/i);
        if (!m) return 0;
        const n = parseFloat(m[1]);
        const unit = m[2].toUpperCase();
        const mul = {B:1, KB:1024, MB:1024**2, GB:1024**3, TB:1024**4}[unit]||1;
        return Math.round(n*mul);
    }

    // 从API加载备份组列表
    async function loadBackupGroups() {
        try {
            const response = await fetch('/api/recovery/backup-groups');
            const data = await response.json();
            const groups = data.backup_groups || [];
            
            // 更新月份选择下拉框
            monthSelect.innerHTML = '';
            groups.forEach(group => {
                const option = document.createElement('option');
                const [year, month] = group.split('-');
                option.value = group;
                option.textContent = `${year}年${parseInt(month)}月`;
                monthSelect.appendChild(option);
            });
            
            // 默认选择第一个月份
            if (groups.length > 0) {
                monthSelect.value = groups[0];
                await loadBackupSets(groups[0]);
            }
        } catch (error) {
            console.error('加载备份组失败:', error);
        }
    }

    // 从API加载备份集列表
    async function loadBackupSets(backupGroup) {
        try {
            const response = await fetch(`/api/recovery/backup-sets?backup_group=${encodeURIComponent(backupGroup)}`);
            const data = await response.json();
            const backupSets = data.backup_sets || [];
            
            // 清空时间轴
            timeline.innerHTML = '';
            
            if (backupSets.length === 0) {
                timeline.innerHTML = '<div class="alert alert-info">该月份暂无备份集</div>';
                return;
            }
            
            // 渲染备份集卡片
            backupSets.forEach(backupSet => {
                const card = document.createElement('div');
                card.className = `backup-set-card backup-set-${getBackupTypeClass(backupSet.backup_type)} mb-3 p-3`;
                card.dataset.backupId = backupSet.set_id;
                
                const backupTime = new Date(backupSet.backup_time);
                const timeStr = backupTime.toLocaleString('zh-CN', { 
                    year: 'numeric', month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit' 
                });
                
                card.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${getBackupTypeName(backupSet.backup_type)}</h6>
                            <small class="text-muted">${timeStr}</small>
                            <div class="mt-2">
                                <small class="text-muted">磁带: </small>
                                <span class="badge bg-secondary">${backupSet.tape_id || 'N/A'}</span>
                            </div>
                            <div class="mt-1">
                                <small class="text-muted">大小: </small>
                                <span>${formatBytes(backupSet.total_bytes || 0)}</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <span class="badge ${getBackupTypeBadge(backupSet.backup_type)}">${getBackupTypeShortName(backupSet.backup_type)}</span>
                        </div>
                    </div>
                `;
                
                // 点击选择备份集
                card.addEventListener('click', function() {
                    timeline.querySelectorAll('.backup-set-card.selected').forEach(c=>c.classList.remove('selected'));
                    this.classList.add('selected');
                    currentBackupSetId = backupSet.set_id;
                    const title = this.querySelector('h6')?.textContent?.trim() || '';
                    const time = this.querySelector('small.text-muted')?.textContent?.trim() || '';
                    if (currentBackupNameEl){ 
                        currentBackupNameEl.textContent = title + (time? ' ('+time+')':''); 
                    }
                    loadBackupSetFiles(backupSet.set_id);
                });
                
                timeline.appendChild(card);
            });
            
            // 默认选择第一个备份集
            if (backupSets.length > 0) {
                const firstCard = timeline.querySelector('.backup-set-card');
                if (firstCard) {
                    firstCard.click();
                }
            }
        } catch (error) {
            console.error('加载备份集失败:', error);
            timeline.innerHTML = '<div class="alert alert-danger">加载备份集失败: ' + error.message + '</div>';
        }
    }

    // 从API加载备份集文件列表
    async function loadBackupSetFiles(backupSetId) {
        try {
            const response = await fetch(`/api/recovery/backup-sets/${encodeURIComponent(backupSetId)}/files`);
            const data = await response.json();
            allFiles = data.files || [];
            
            // 构建文件树
            buildFileTree(allFiles);
        } catch (error) {
            console.error('加载文件列表失败:', error);
            treeRoot.innerHTML = '<div class="alert alert-danger">加载文件列表失败: ' + error.message + '</div>';
        }
    }

    // 构建文件树
    function buildFileTree(files) {
        // 清空文件树
        treeRoot.innerHTML = '';
        fileIndex.clear();
        autoId = 1;
        
        // 构建目录结构
        const tree = {};
        files.forEach(file => {
            const pathParts = file.file_path.split('/').filter(p => p);
            let current = tree;
            
            pathParts.forEach((part, index) => {
                if (!current[part]) {
                    current[part] = {
                        type: index === pathParts.length - 1 ? file.file_type : 'directory',
                        file: index === pathParts.length - 1 ? file : null,
                        children: {}
                    };
                }
                current = current[part].children;
            });
        });
        
        // 渲染树节点
        function renderNode(node, name, path, parentEl, level = 0) {
            const isDir = node.type === 'directory';
            const nodeEl = document.createElement('div');
            nodeEl.className = 'tree-node';
            nodeEl.dataset.id = 'n' + (autoId++);
            nodeEl.style.paddingLeft = (level * 16) + 'px';
            
            const id = nodeEl.dataset.id;
            const sizeBytes = node.file ? (node.file.file_size || 0) : 0;
            
            nodeEl.innerHTML = `
                <input type="checkbox" class="form-check-input me-2">
                <i class="bi ${isDir ? 'bi-folder' : getFileIcon(node.file?.file_name || name)} me-2"></i>
                <span>${name}</span>
                ${!isDir && sizeBytes > 0 ? `<small class="text-muted ms-2">${formatBytes(sizeBytes)}</small>` : ''}
            `;
            
            const children = [];
            if (isDir) {
                Object.keys(node.children).sort().forEach(childName => {
                    const childNode = node.children[childName];
                    const childPath = path ? `${path}/${childName}` : childName;
                    const childEl = renderNode(childNode, childName, childPath, null, level + 1);
                    children.push(childEl.dataset.id);
                });
            }
            
            fileIndex.set(id, {
                el: nodeEl,
                type: isDir ? 'dir' : 'file',
                sizeBytes: sizeBytes,
                children: children,
                name: name,
                file: node.file
            });
            
            if (parentEl) {
                parentEl.appendChild(nodeEl);
            }
            
            return nodeEl;
        }
        
        // 渲染根节点
        Object.keys(tree).sort().forEach(name => {
            const node = tree[name];
            const rootNode = renderNode(node, name, name, treeRoot, 0);
        });
    }

    // 获取文件图标
    function getFileIcon(fileName) {
        const ext = fileName.split('.').pop()?.toLowerCase() || '';
        const iconMap = {
            'pdf': 'bi-file-pdf',
            'doc': 'bi-file-word', 'docx': 'bi-file-word',
            'xls': 'bi-file-earmark-spreadsheet', 'xlsx': 'bi-file-earmark-spreadsheet',
            'jpg': 'bi-file-image', 'jpeg': 'bi-file-image', 'png': 'bi-file-image', 'gif': 'bi-file-image',
            'txt': 'bi-file-text',
            'zip': 'bi-file-zip', '7z': 'bi-file-zip', 'rar': 'bi-file-zip'
        };
        return iconMap[ext] || 'bi-file-earmark-text';
    }

    // 获取备份类型样式类
    function getBackupTypeClass(type) {
        const typeMap = {
            'full': 'full',
            'monthly_full': 'full',
            'incremental': 'incremental',
            'differential': 'differential'
        };
        return typeMap[type] || 'full';
    }

    // 获取备份类型名称
    function getBackupTypeName(type) {
        const typeMap = {
            'full': '完整备份',
            'monthly_full': '完整备份',
            'incremental': '增量备份',
            'differential': '差异备份'
        };
        return typeMap[type] || '备份';
    }

    // 获取备份类型短名称
    function getBackupTypeShortName(type) {
        const typeMap = {
            'full': '完整',
            'monthly_full': '完整',
            'incremental': '增量',
            'differential': '差异'
        };
        return typeMap[type] || '备份';
    }

    // 获取备份类型徽章样式
    function getBackupTypeBadge(type) {
        const typeMap = {
            'full': 'bg-success',
            'monthly_full': 'bg-success',
            'incremental': 'bg-primary',
            'differential': 'bg-warning'
        };
        return typeMap[type] || 'bg-secondary';
    }

    function assignIdsAndBuildIndex(container){
        // 已由 buildFileTree 处理，此函数保留用于兼容
    }

    // 备份集选择联动
    function bindTimelineSelection(){
        // 已在 loadBackupSets 中处理
    }

    // 切换按钮
    if (changeBackupBtn && timeline){
        changeBackupBtn.addEventListener('click', function(){
            timeline.scrollIntoView({behavior:'smooth', block:'start'});
            const sel = timeline.querySelector('.backup-set-card.selected') || timeline.querySelector('.backup-set-card');
            if (sel){ sel.classList.add('selected'); sel.style.outline='2px solid #2196f3'; setTimeout(()=> sel.style.outline='', 1200); }
        });
    }

    // 月份下拉：加载对应月份的备份集
    if (monthSelect){
        monthSelect.addEventListener('change', async function(){
            await loadBackupSets(this.value);
        });
    }

    function selectFile(id, on){
        const meta = fileIndex.get(id); if (!meta) return;
        const cb = meta.el.querySelector('input[type="checkbox"]');
        if (cb) cb.checked = !!on;
        if (meta.type === 'file'){
            if (on) selectedFiles.add(id); else selectedFiles.delete(id);
        } else {
            if (on) selectedFolders.add(id); else selectedFolders.delete(id);
            // 递归子孙
            meta.children.forEach(ch => selectFile(ch, on));
            // 递归更深层
            meta.children.forEach(ch => {
                const cm = fileIndex.get(ch);
                if (cm && cm.type==='dir'){
                    cm.children.forEach(grand => selectFile(grand, on));
                }
            });
        }
        refreshStatsAndList();
    }

    function refreshStatsAndList(){
        let files = Array.from(selectedFiles);
        let total = 0;
        files.forEach(id => { const m = fileIndex.get(id); if (m) total += m.sizeBytes; });
        selectedCountEl.textContent = String(files.length);
        selectedSizeEl.textContent = formatBytes(total);
        folderCountEl.textContent = String(selectedFolders.size);
        
        // 更新开始恢复按钮状态
        if (startRecoveryBtn) {
            startRecoveryBtn.disabled = files.length === 0 || !currentBackupSetId;
        }
        
        // 渲染列表
        listEl.innerHTML = files.map(id => {
            const m = fileIndex.get(id); if (!m) return '';
            return `<div class="list-group-item d-flex justify-content-between align-items-center">
                        <div class="text-truncate" style="max-width:75%"><i class="bi bi-file-earmark-text me-2"></i>${m.name}</div>
                        <div class="d-flex align-items-center gap-3">
                            <span class="text-muted small">${formatBytes(m.sizeBytes)}</span>
                            <button type="button" class="btn btn-sm btn-outline-danger" data-remove-id="${id}"><i class="bi bi-x"></i></button>
                        </div>
                    </div>`;
        }).join('');
    }

    // 事件委托：树复选框点击
    treeRoot.addEventListener('change', function(e){
        const target = e.target;
        if (target && target.matches('input[type="checkbox"]')){
            const node = target.closest('.tree-node');
            if (!node) return;
            selectFile(node.dataset.id, target.checked);
        }
    });

    // 事件：选中文件列表移除
    listEl.addEventListener('click', function(e){
        const btn = e.target.closest('button[data-remove-id]');
        if (!btn) return;
        const id = btn.getAttribute('data-remove-id');
        selectFile(id, false);
    });

    // 全选/清除
    if (selectAllBtn){
        selectAllBtn.addEventListener('click', function(){
            fileIndex.forEach((meta, id) => { if (meta.type==='file') selectFile(id, true); });
        });
    }
    if (clearSelectionBtn){
        clearSelectionBtn.addEventListener('click', function(){
            Array.from(selectedFiles).forEach(id => selectFile(id, false));
            Array.from(selectedFolders).forEach(id => selectFile(id, false));
        });
    }

    // 文件搜索
    if (fileSearch) {
        fileSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            if (!searchTerm) {
                // 显示所有文件
                fileIndex.forEach((meta, id) => {
                    meta.el.style.display = '';
                });
                return;
            }
            
            // 过滤文件
            fileIndex.forEach((meta, id) => {
                const match = meta.name.toLowerCase().includes(searchTerm) || 
                             (meta.file && meta.file.file_path && meta.file.file_path.toLowerCase().includes(searchTerm));
                meta.el.style.display = match ? '' : 'none';
            });
        });
    }

    // 文件类型过滤
    if (fileTypeFilter) {
        fileTypeFilter.addEventListener('change', function() {
            const filterType = this.value;
            fileIndex.forEach((meta, id) => {
                if (filterType === '所有文件') {
                    meta.el.style.display = '';
                } else if (filterType === '仅显示文件') {
                    meta.el.style.display = meta.type === 'file' ? '' : 'none';
                } else if (filterType === '仅显示文件夹') {
                    meta.el.style.display = meta.type === 'dir' ? '' : 'none';
                }
            });
        });
    }

    // 开始恢复按钮
    if (startRecoveryBtn) {
        startRecoveryBtn.addEventListener('click', async function() {
            if (!currentBackupSetId || selectedFiles.size === 0) {
                alert('请先选择备份集和要恢复的文件');
                return;
            }

            const recoveryPath = document.getElementById('recoveryPath')?.value || '/tmp/recovery';
            const selectedFileList = Array.from(selectedFiles).map(id => {
                const meta = fileIndex.get(id);
                if (!meta || !meta.file) return null;
                return {
                    id: meta.file.id,
                    file_path: meta.file.file_path,
                    file_name: meta.file.file_name,
                    file_size: meta.file.file_size,
                    compressed_size: meta.file.compressed_size
                };
            }).filter(f => f !== null);

            if (selectedFileList.length === 0) {
                alert('没有有效的文件可以恢复');
                return;
            }

            try {
                this.disabled = true;
                this.textContent = '恢复中...';

                const response = await fetch('/api/recovery/tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        backup_set_id: currentBackupSetId,
                        files: selectedFileList,
                        target_path: recoveryPath
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('恢复任务已创建，正在后台执行');
                    // 可以在这里添加任务状态监控
                } else {
                    alert('创建恢复任务失败: ' + (result.message || '未知错误'));
                }
            } catch (error) {
                console.error('创建恢复任务失败:', error);
                alert('创建恢复任务失败: ' + error.message);
            } finally {
                this.disabled = false;
                this.textContent = '<i class="bi bi-play-circle me-2"></i>开始恢复';
            }
        });
    }

    // 初始化：加载备份组
    loadBackupGroups();
})();
</script>
{% endblock %}