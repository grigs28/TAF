{% extends "base.html" %}

{% block title %}{{ app_name }} - 计划任务{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', path='/css/ai.css') }}" rel="stylesheet">
<style>
    .console-panel {
        background: rgba(13, 22, 38, 0.9);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    .service-card {
        background: rgba(26, 35, 50, 0.8);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .table-responsive {
        overflow-x: auto;
    }
    
    .table {
        color: #fff;
    }
    
    .table thead th {
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        background: rgba(0, 0, 0, 0.3);
    }
    
    .table tbody tr:hover {
        background: rgba(255, 255, 255, 0.05);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    }
</style>
{% endblock %}

{% block content %}
<div class="console-panel">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="mb-0">
            <i class="bi bi-clock-history me-2"></i>计划任务管理
        </h5>
        <button class="btn btn-primary" id="addScheduledTaskBtn">
            <i class="bi bi-plus-circle me-1"></i>添加任务
        </button>
    </div>
    
    <div class="service-card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>任务名称</th>
                            <th>调度类型</th>
                            <th>调度配置</th>
                            <th>状态</th>
                            <th>下次执行</th>
                            <th>上次执行</th>
                            <th>执行统计</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="scheduledTasksTableBody">
                        <tr>
                            <td colspan="8" class="text-center text-muted">
                                <i class="bi bi-hourglass-split me-2"></i>加载中...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 计划任务模态框 -->
{% include 'system/_modal_scheduler_task.html' %}
<!-- 目录浏览器模态框 -->
{% include 'system/_modal_directory_browser.html' %}

<!-- 计划任务管理JavaScript -->
<script type="module">
// 确保 axios 已加载
if (typeof window.axios === 'undefined') {
    console.error('axios 未加载，请确保在页面中引入了 axios.min.js');
}

// 动态导入 SchedulerManager 模块
(async function() {
    try {
        // 使用绝对路径导入（与 backup.html 中的方式一致）
        const module = await import('/static/js/modules/system/scheduler.js');
        // SchedulerManager 已经在 scheduler.js 中挂载到 window 对象
        // 但如果还没有，这里也设置一下
        if (module.SchedulerManager) {
            window.SchedulerManager = module.SchedulerManager;
        }
        
        // 页面加载完成后初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                // 初始化计划任务管理器
                if (window.SchedulerManager && !window.SchedulerManager.initialized) {
                    window.SchedulerManager.init();
                    window.SchedulerManager.initialized = true;
                }
            });
        } else {
            // DOM 已经加载完成，直接初始化
            if (window.SchedulerManager && !window.SchedulerManager.initialized) {
                window.SchedulerManager.init();
                window.SchedulerManager.initialized = true;
            }
        }
    } catch (error) {
        console.error('加载 SchedulerManager 模块失败:', error);
        // 显示错误提示
        const tbody = document.getElementById('scheduledTasksTableBody');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>加载计划任务管理器失败，请刷新页面重试
                        <br><small>错误: ${error.message}</small>
                    </td>
                </tr>
            `;
        }
    }
})();
</script>
{% endblock %}
