{% extends "base.html" %}

{% block title %}{{ app_name }} - 磁带机配置{% endblock %}

{% block extra_css %}
<style>
.setting-card {
    transition: all 0.3s ease;
}
.setting-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.status-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}
.status-online { background-color: #28a745; }
.status-offline { background-color: #dc3545; }
.status-warning { background-color: #ffc107; }
</style>
{% endblock %}

{% block content %}
<div class="console-panel">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="mb-0">
            <i class="bi bi-server me-2"></i>磁带机配置
        </h5>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="setting-card service-card mb-3">
                <div class="card-body">
                    <h6 class="card-title">磁带机配置</h6>
                    <div class="mb-3">
                        <label class="form-label">设备路径</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-hdd"></i>
                            </span>
                            <input type="text" class="form-control" id="tapeDevicePath" placeholder="/dev/nst0">
                        </div>
                        <small class="text-muted">Linux: /dev/nst0, Windows: \\.\TAPE0</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">驱动盘符 (Windows)</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-hdd-rack"></i>
                            </span>
                            <input type="text" class="form-control" id="tapeDriveLetter" placeholder="o" maxlength="1" style="max-width: 80px;">
                        </div>
                        <small class="text-muted">Windows系统磁带驱动器的盘符</small>
                    </div>

                    <hr>
                    <h6 class="card-title mt-3">数据块配置</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">默认块大小</label>
                            <select class="form-select" id="blockSize">
                                <option value="65536">64KB</option>
                                <option value="131072">128KB</option>
                                <option value="262144" selected>256KB (推荐)</option>
                                <option value="524288">512KB</option>
                                <option value="1048576">1MB</option>
                            </select>
                            <small class="text-muted">磁带数据块大小</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">最大卷大小</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="maxVolumeSize" value="300" step="1">
                                <span class="input-group-text">GB</span>
                            </div>
                            <small class="text-muted">单个备份卷的最大大小</small>
                        </div>
                    </div>

                    <hr>
                    <h6 class="card-title mt-3">磁带管理</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">磁带池大小</label>
                            <input type="number" class="form-control" id="tapePoolSize" value="12" min="1" max="100">
                            <small class="text-muted">管理的磁带数量</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">状态检查间隔</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="tapeCheckInterval" value="3600" min="60">
                                <span class="input-group-text">秒</span>
                            </div>
                            <small class="text-muted">磁带状态自动检查间隔</small>
                        </div>
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="autoTapeCleanup" checked>
                        <label class="form-check-label" for="autoTapeCleanup">自动清理过期磁带</label>
                    </div>

                    <div class="mb-3">
                        <button class="btn btn-outline-primary" id="testTapeConnectionBtn">
                            <i class="bi bi-plug me-2"></i>测试连接
                        </button>
                        <button class="btn btn-success" id="saveTapeConfigBtn">
                            <i class="bi bi-save me-2"></i>保存配置
                        </button>
                        <button class="btn btn-info" id="scanTapeDevicesBtn">
                            <i class="bi bi-search me-2"></i>扫描设备
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="row">
                <div class="col-12 mb-3">
                    <div class="setting-card service-card">
                        <div class="card-body">
                            <h6 class="card-title">连接状态</h6>
                            <div class="text-center" id="tapeStatus">
                                <div class="status-indicator status-offline mb-2"></div>
                                <p class="text-danger" id="tapeStatusText">未连接</p>
                                <small class="text-muted" id="tapeDeviceInfo">未检测到设备</small>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">块大小:</small>
                                <small class="text-muted" id="currentBlockSize">256KB</small>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">池大小:</small>
                                <small class="text-muted" id="currentTapePoolSize">12</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 mb-3">
                    <div class="setting-card service-card">
                        <div class="card-body">
                            <h6 class="card-title">已检测设备</h6>
                            <div id="detectedDevices" style="max-height: 300px; overflow-y: auto;">
                                <p class="text-muted text-center mb-0">
                                    <i class="bi bi-info-circle"></i>
                                    暂无设备
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 当前磁带信息卡片 -->
                <div class="col-12">
                    <div class="setting-card service-card">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="bi bi-database me-2"></i>当前磁带
                            </h6>
                            <div id="currentTapeCard" class="text-center py-3">
                                <div class="text-muted">
                                    <i class="bi bi-info-circle"></i>
                                    <p class="mb-0">加载中...</p>
                                </div>
                            </div>
                            <hr>
                            <div class="d-flex gap-2 justify-content-center">
                                <button class="btn btn-primary btn-sm" id="loadTapeBtn" style="display: none;">
                                    <i class="bi bi-upload me-1"></i>加载磁带
                                </button>
                                <button class="btn btn-warning btn-sm" id="unloadTapeBtn" style="display: none;">
                                    <i class="bi bi-eject me-1"></i>弹出磁带
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 磁带机操作历史 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="service-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history me-2"></i>
                        磁带机操作历史
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>操作</th>
                                    <th>设备</th>
                                    <th>用户</th>
                                    <th>状态</th>
                                    <th>备注</th>
                                </tr>
                            </thead>
                            <tbody id="tapeDriveHistoryTableBody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">加载中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ===== 磁带机配置JavaScript =====
document.addEventListener('DOMContentLoaded', function() {
    loadTapeConfig();
    
    // 页面加载时自动扫描设备
    scanDevicesOnLoad();
    
    // 加载操作历史
    loadTapeDriveHistory();
    
    // 加载当前磁带信息
    loadCurrentTape();
    
    // 定期刷新当前磁带信息（每30秒）
    setInterval(loadCurrentTape, 30000);
    
    // 测试磁带连接
    document.getElementById('testTapeConnectionBtn').addEventListener('click', async function() {
        const btn = this;
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-arrow-clockwise spinner me-2"></i>测试中...';
        
        try {
            const config = getTapeConfig();
            const response = await fetch('/api/system/tape/test', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(config)
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('✅ 磁带机连接测试成功！');
                updateTapeStatus(result);
                loadTapeDriveHistory();  // 刷新操作历史
                loadCurrentTape();  // 刷新当前磁带信息
            } else {
                alert('❌ 磁带机连接测试失败：' + result.message);
                updateTapeStatus({ connected: false });
                loadTapeDriveHistory();  // 刷新操作历史
                loadCurrentTape();  // 刷新当前磁带信息
            }
        } catch (error) {
            alert('❌ 测试失败：' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    });
    
    // 保存磁带配置
    document.getElementById('saveTapeConfigBtn').addEventListener('click', async function() {
        const btn = this;
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-arrow-clockwise spinner me-2"></i>保存中...';
        
        try {
            const config = getTapeConfig();
            
            // 验证必填字段
            if (!config.tape_device_path || config.tape_device_path.trim() === '') {
                alert('❌ 请填写设备路径');
                btn.disabled = false;
                btn.innerHTML = originalHtml;
                return;
            }
            
            const response = await fetch('/api/system/tape/config', {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(config)
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('✅ 配置已保存');
                loadTapeDriveHistory();  // 刷新操作历史
            } else {
                alert('❌ 保存失败：' + result.message);
                loadTapeDriveHistory();  // 刷新操作历史
            }
        } catch (error) {
            alert('❌ 保存失败：' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    });
    
    // 扫描磁带设备
    document.getElementById('scanTapeDevicesBtn').addEventListener('click', async function() {
        const btn = this;
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-arrow-clockwise spinner me-2"></i>扫描中...';
        
        try {
            const response = await fetch('/api/system/tape/scan');
            const result = await response.json();
            
            if (result.success && result.devices && result.devices.length > 0) {
                displayDetectedDevices(result.devices);
                alert(`✅ 检测到 ${result.devices.length} 个磁带设备！`);
                loadTapeDriveHistory();  // 刷新操作历史
                loadCurrentTape();  // 刷新当前磁带信息
            } else {
                displayDetectedDevices([]);
                alert('⚠️ 未检测到磁带设备');
                loadTapeDriveHistory();  // 刷新操作历史
                loadCurrentTape();  // 刷新当前磁带信息
            }
        } catch (error) {
            alert('❌ 扫描失败：' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    });
});

function loadTapeConfig() {
    fetch('/api/system/tape/config')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const config = data.config;
                if (config.tape_device_path) {
                    document.getElementById('tapeDevicePath').value = config.tape_device_path;
                }
                if (config.tape_drive_letter) {
                    document.getElementById('tapeDriveLetter').value = config.tape_drive_letter;
                }
                if (config.default_block_size) {
                    document.getElementById('blockSize').value = config.default_block_size;
                }
                if (config.max_volume_size) {
                    // 将字节转换为GB显示
                    const gb = Math.round(config.max_volume_size / (1024 ** 3));
                    document.getElementById('maxVolumeSize').value = gb;
                }
                if (config.tape_pool_size) {
                    document.getElementById('tapePoolSize').value = config.tape_pool_size;
                }
                if (config.tape_check_interval) {
                    document.getElementById('tapeCheckInterval').value = config.tape_check_interval;
                }
                if (config.auto_tape_cleanup !== undefined) {
                    document.getElementById('autoTapeCleanup').checked = config.auto_tape_cleanup;
                }
                updateTapeStatus(data.status || {});
                
                // 加载配置后，立即加载当前磁带信息
                loadCurrentTape();
            }
        })
        .catch(error => console.error('加载磁带配置失败:', error));
}

function getTapeConfig() {
    return {
        tape_device_path: document.getElementById('tapeDevicePath').value,
        tape_drive_letter: document.getElementById('tapeDriveLetter').value,
        default_block_size: parseInt(document.getElementById('blockSize').value),
        max_volume_size: parseInt(document.getElementById('maxVolumeSize').value) * (1024 ** 3), // GB转字节
        tape_pool_size: parseInt(document.getElementById('tapePoolSize').value),
        tape_check_interval: parseInt(document.getElementById('tapeCheckInterval').value),
        auto_tape_cleanup: document.getElementById('autoTapeCleanup').checked
    };
}

function updateTapeStatus(status) {
    const statusDiv = document.getElementById('tapeStatus');
    const statusText = document.getElementById('tapeStatusText');
    const deviceInfo = document.getElementById('tapeDeviceInfo');
    const indicator = statusDiv.querySelector('.status-indicator');
    
    if (status.connected) {
        indicator.className = 'status-indicator status-online mb-2';
        statusText.className = 'text-success';
        statusText.textContent = '已连接';
        deviceInfo.textContent = status.device_info || '设备正常';
    } else {
        indicator.className = 'status-indicator status-offline mb-2';
        statusText.className = 'text-danger';
        statusText.textContent = '未连接';
        deviceInfo.textContent = status.error || '未检测到设备';
    }
}

function displayDetectedDevices(devices) {
    const container = document.getElementById('detectedDevices');
    
    if (!devices || devices.length === 0) {
        container.innerHTML = '<p class="text-muted text-center mb-0"><i class="bi bi-info-circle"></i> 暂无设备</p>';
        return;
    }
    
    let html = '<ul class="list-unstyled mb-0">';
    devices.forEach(device => {
        // 格式化容量显示
        let capacityDisplay = '';
        if (device.native_capacity) {
            const tb = (device.native_capacity / (1024 ** 4)).toFixed(1);
            capacityDisplay = `<small class="text-muted d-block"><i class="bi bi-hdd"></i> 容量: ${tb} TB</small>`;
        }
        
        // LTO代数显示
        let ltoDisplay = '';
        if (device.is_ibm_lto && device.lto_generation) {
            ltoDisplay = `<span class="badge bg-info ms-1">LTO-${device.lto_generation}</span>`;
        }
        
        html += `
            <li class="mb-2 p-2 border rounded">
                <div class="fw-bold">${device.vendor} ${device.model}${ltoDisplay}</div>
                <small class="text-muted d-block"><i class="bi bi-geo-alt"></i> ${device.path}</small>
                ${capacityDisplay}
                ${device.status === 'online' ? 
                    '<span class="badge bg-success">在线</span>' : 
                    '<span class="badge bg-danger">离线</span>'}
            </li>
        `;
    });
    html += '</ul>';
    container.innerHTML = html;
}

function scanDevicesOnLoad() {
    // 页面加载时自动扫描设备
    fetch('/api/system/tape/scan')
        .then(response => response.json())
        .then(result => {
            if (result.success && result.devices && result.devices.length > 0) {
                displayDetectedDevices(result.devices);
            } else {
                displayDetectedDevices([]);
            }
        })
        .catch(error => {
            console.error('自动扫描设备失败:', error);
            displayDetectedDevices([]);
        });
}

// 加载磁带机操作历史
async function loadTapeDriveHistory() {
    try {
        const tbody = document.getElementById('tapeDriveHistoryTableBody');
        if (!tbody) return;
        
        // 显示加载中
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">加载中...</td></tr>';
        
        const response = await fetch('/api/system/tape/history?limit=50&offset=0');
        const result = await response.json();
        
        if (result && result.success && result.history && result.history.length > 0) {
            tbody.innerHTML = '';
            
            result.history.forEach(log => {
                // 格式化时间
                const time = log.time ? new Date(log.time).toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }) : 'N/A';
                
                // 操作名称
                const operation = log.operation || '操作';
                
                // 设备名称
                const deviceName = log.device_name || '-';
                
                // 用户名
                const username = log.username || 'system';
                
                // 状态徽章
                const statusBadge = log.success 
                    ? '<span class="badge bg-success">成功</span>' 
                    : '<span class="badge bg-danger">失败</span>';
                
                // 备注信息
                const message = log.message || '';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${time}</td>
                    <td>${operation}</td>
                    <td>${deviceName}</td>
                    <td>${username}</td>
                    <td>${statusBadge}</td>
                    <td>${message}</td>
                `;
                tbody.appendChild(row);
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">暂无操作历史</td></tr>';
        }
    } catch (error) {
        console.error('加载磁带机操作历史失败:', error);
        const tbody = document.getElementById('tapeDriveHistoryTableBody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">加载失败: ' + error.message + '</td></tr>';
        }
    }
}

// 加载当前磁带信息
async function loadCurrentTape() {
    try {
        const card = document.getElementById('currentTapeCard');
        if (!card) return;
        
        const response = await fetch('/api/tape/current');
        const result = await response.json();
        
        // 检查是否有磁带信息
        if (result && result.tape_id) {
            // 有磁带，显示详细信息
            const formatBytes = (bytes) => {
                if (bytes >= 1024 ** 4) return (bytes / (1024 ** 4)).toFixed(2) + ' TB';
                if (bytes >= 1024 ** 3) return (bytes / (1024 ** 3)).toFixed(2) + ' GB';
                if (bytes >= 1024 ** 2) return (bytes / (1024 ** 2)).toFixed(2) + ' MB';
                return bytes + ' B';
            };
            
            const usagePercent = result.usage_percent || 0;
            const progressColor = usagePercent >= 90 ? 'danger' : usagePercent >= 70 ? 'warning' : 'success';
            
            // 状态样式
            const statusConfig = {
                'AVAILABLE': {class: 'success', text: '可用'},
                'available': {class: 'success', text: '可用'},
                'IN_USE': {class: 'primary', text: '使用中'},
                'in_use': {class: 'primary', text: '使用中'},
                'FULL': {class: 'danger', text: '已满'},
                'full': {class: 'danger', text: '已满'}
            };
            const status = statusConfig[result.status] || {class: 'secondary', text: result.status || '未知'};
            
            card.innerHTML = `
                <div class="text-start">
                    <div class="mb-2">
                        <h6 class="mb-1">${result.label || result.tape_id}</h6>
                        <small class="text-muted">磁带ID: ${result.tape_id}</small>
                    </div>
                    <div class="mb-2">
                        <span class="badge bg-${status.class}">${status.text}</span>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">容量: </small>
                        <small>${formatBytes(result.capacity_bytes || 0)}</small>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">已用: </small>
                        <small>${formatBytes(result.used_bytes || 0)} / ${formatBytes(result.capacity_bytes || 0)}</small>
                        <small class="text-muted"> (${usagePercent.toFixed(1)}%)</small>
                    </div>
                    <div class="mb-2">
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-${progressColor}" style="width: ${usagePercent}%"></div>
                        </div>
                    </div>
                    ${result.location ? `
                    <div class="mb-2">
                        <small class="text-muted">位置: </small>
                        <small>${result.location}</small>
                    </div>
                    ` : ''}
                    ${result.created_date ? `
                    <div class="mb-2">
                        <small class="text-muted">创建日期: </small>
                        <small>${new Date(result.created_date).toLocaleDateString('zh-CN')}</small>
                    </div>
                    ` : ''}
                    ${result.expiry_date ? `
                    <div class="mb-2">
                        <small class="text-muted">过期日期: </small>
                        <small>${new Date(result.expiry_date).toLocaleDateString('zh-CN')}</small>
                    </div>
                    ` : ''}
                </div>
            `;
        } else {
            // 未处于“已加载”状态时，尝试直接读取磁带标签与设备信息
            try {
                const [labelResp, devicesResp] = await Promise.all([
                    fetch('/api/tape/read-label'),
                    fetch('/api/system/tape/scan')
                ]);
                const labelData = await labelResp.json();
                const devicesData = await devicesResp.json();

                if (labelData && labelData.success && labelData.metadata) {
                    const m = labelData.metadata;
                    const device = (devicesData && devicesData.success && devicesData.devices && devicesData.devices[0]) ? devicesData.devices[0] : null;

                    const deviceInfo = device ? `${device.vendor || 'Unknown'} ${device.model || ''}`.trim() : '未检测到设备信息';
                    const devicePath = device ? (device.path || '') : '';

                    const createdText = m.created_date ? new Date(m.created_date).toLocaleDateString('zh-CN') : '';
                    const expiryText = m.expiry_date ? new Date(m.expiry_date).toLocaleDateString('zh-CN') : '';

                    card.innerHTML = `
                        <div class="text-start">
                            <div class="mb-2">
                                <h6 class="mb-1">${m.label || m.tape_id || '未知磁带'}</h6>
                                ${m.tape_id ? `<small class="text-muted">磁带ID: ${m.tape_id}</small>` : ''}
                            </div>
                            ${m.serial_number ? `
                            <div class="mb-2">
                                <small class="text-muted">序列号: </small>
                                <small>${m.serial_number}</small>
                            </div>` : ''}
                            ${createdText ? `
                            <div class="mb-2">
                                <small class="text-muted">创建日期: </small>
                                <small>${createdText}</small>
                            </div>` : ''}
                            ${expiryText ? `
                            <div class="mb-2">
                                <small class="text-muted">过期日期: </small>
                                <small>${expiryText}</small>
                            </div>` : ''}
                            <hr class="my-2" />
                            <div class="mb-1">
                                <small class="text-muted">设备: </small>
                                <small>${deviceInfo}</small>
                            </div>
                            ${devicePath ? `
                            <div class="mb-1">
                                <small class="text-muted">路径: </small>
                                <code class="bg-dark text-light px-2 py-0 rounded">${devicePath}</code>
                            </div>` : ''}
                        </div>
                    `;
                } else {
                    // 无法读取到标签
                    card.innerHTML = `
                        <div class="text-muted">
                            <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                            <p class="mb-0 mt-2">当前没有加载的磁带</p>
                        </div>
                    `;
                }
            } catch (e) {
                card.innerHTML = `
                    <div class="text-muted">
                        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                        <p class="mb-0 mt-2">当前没有加载的磁带</p>
                    </div>
                `;
            }
        }
        
        // 更新加载和弹出按钮的显示状态
        const loadBtn = document.getElementById('loadTapeBtn');
        const unloadBtn = document.getElementById('unloadTapeBtn');
        if (result && result.tape_id) {
            // 有磁带，显示弹出按钮
            if (unloadBtn) unloadBtn.style.display = 'inline-block';
            if (loadBtn) loadBtn.style.display = 'none';
        } else {
            // 没有磁带，显示加载按钮
            if (loadBtn) loadBtn.style.display = 'inline-block';
            if (unloadBtn) unloadBtn.style.display = 'none';
        }
    } catch (error) {
        console.error('加载当前磁带信息失败:', error);
        const card = document.getElementById('currentTapeCard');
        if (card) {
            card.innerHTML = `
                <div class="text-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    <p class="mb-0">加载失败: ${error.message}</p>
                </div>
            `;
        }
    }
}

// 加载磁带按钮事件
document.getElementById('loadTapeBtn')?.addEventListener('click', async function() {
    const btn = this;
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-arrow-clockwise spinner me-1"></i>加载中...';
    
    try {
        // 先获取可用磁带列表，让用户选择
        const tapesResp = await fetch('/api/tape/list');
        const tapesData = await tapesResp.json();
        
        if (!tapesData || !tapesData.success || !tapesData.tapes || tapesData.tapes.length === 0) {
            alert('没有可用的磁带');
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            return;
        }
        
        // 简化：自动选择第一个可用磁带
        const availableTape = tapesData.tapes.find(t => t.status === 'AVAILABLE' || t.status === 'available') || tapesData.tapes[0];
        
        const response = await fetch(`/api/tape/operations/load?tape_id=${encodeURIComponent(availableTape.tape_id)}`, {
            method: 'POST'
        });
        const result = await response.json();
        
        if (result.success) {
            alert(`磁带 ${availableTape.tape_id} 加载成功`);
            loadCurrentTape();
            loadTapeDriveHistory();
        } else {
            alert(`加载失败: ${result.message || '未知错误'}`);
        }
    } catch (error) {
        console.error('加载磁带失败:', error);
        alert(`加载失败: ${error.message}`);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
});

// 弹出磁带按钮事件
document.getElementById('unloadTapeBtn')?.addEventListener('click', async function() {
    if (!confirm('确定要弹出当前磁带吗？')) {
        return;
    }
    
    const btn = this;
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-arrow-clockwise spinner me-1"></i>弹出中...';
    
    try {
        const response = await fetch('/api/tape/operations/unload', {
            method: 'POST'
        });
        const result = await response.json();
        
        if (result.success) {
            alert('磁带弹出成功');
            loadCurrentTape();
            loadTapeDriveHistory();
        } else {
            alert(`弹出失败: ${result.message || '未知错误'}`);
        }
    } catch (error) {
        console.error('弹出磁带失败:', error);
        alert(`弹出失败: ${error.message}`);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
});
</script>
{% endblock %}

