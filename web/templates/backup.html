{% extends "base.html" %}

{% block title %}{{ app_name }} - 备份管理{% endblock %}

{% block extra_css %}
<style>
.task-card {
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
}
.task-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.task-running { border-left-color: #007bff; }
.task-completed { border-left-color: #28a745; }
.task-failed { border-left-color: #dc3545; }
.task-pending { border-left-color: #ffc107; }

.progress-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.8rem;
}
</style>
{% endblock %}

{% block content %}
<div class="console-panel">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="mb-0">
            <i class="bi bi-cloud-upload me-2"></i>备份管理
        </h5>
        <div class="btn-group">
            <button class="btn btn-success" onclick="window.location.href='/system#scheduler'; setTimeout(() => { const btn = document.getElementById('addScheduledTaskBtn'); if (btn) btn.click(); }, 500);">
                <i class="bi bi-calendar-check me-2"></i>创建计划备份
            </button>
        </div>
    </div>
    
    <!-- 提示信息 -->
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="bi bi-info-circle me-2"></i>
        <strong>提示：</strong>推荐使用 <a href="/system#scheduler" class="alert-link">计划任务模块</a> 创建定期备份任务，支持多种调度方式（每日、每周、每月等）。
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- 统计信息 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="service-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-2">总任务数</h6>
                            <h3 class="mb-0" id="totalTasks">-</h3>
                        </div>
                        <div class="ai-icon">
                            <i class="bi bi-stack"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="service-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-2">成功</h6>
                            <h3 class="mb-0" id="completedTasks">-</h3>
                        </div>
                        <div class="ai-icon">
                            <i class="bi bi-check-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="service-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-2">运行中</h6>
                            <h3 class="mb-0" id="runningTasks">-</h3>
                        </div>
                        <div class="ai-icon">
                            <i class="bi bi-hourglass-split"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="service-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-2">失败</h6>
                            <h3 class="mb-0" id="failedTasks">-</h3>
                        </div>
                        <div class="ai-icon">
                            <i class="bi bi-x-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 筛选和搜索 -->
    <div class="row mb-4">
        <div class="col">
            <div class="service-card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <select class="form-select bg-dark text-light" id="statusFilter">
                                <option value="">所有状态</option>
                                <option value="running">运行中</option>
                                <option value="completed">已完成</option>
                                <option value="failed">失败</option>
                                <option value="pending">等待中</option>
                                <option value="not_run">未运行</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select bg-dark text-light" id="typeFilter">
                                <option value="">所有类型</option>
                                <option value="full">完整备份</option>
                                <option value="incremental">增量备份</option>
                                <option value="differential">差异备份</option>
                                <option value="monthly_full">月度备份</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control bg-dark text-light" id="searchInput" placeholder="搜索备份任务...">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary w-100" id="searchBtn">
                                <i class="bi bi-search me-1"></i>搜索
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 备份任务列表 -->
    <div class="row">
        <div class="col-12">
            <div class="service-card">
                <div class="card-body">
                    <!-- 运行中的任务 -->
                    <h6 class="mb-3">
                        <i class="bi bi-hourglass-split me-2"></i>运行中的任务
                    </h6>
                    <div class="row mb-4" id="runningTasksList">
                        <div class="col-12">
                            <p class="text-muted">加载中...</p>
                        </div>
                    </div>

                    <!-- 所有任务列表（包含未运行） -->
                    <h6 class="mb-3">
                        <i class="bi bi-list-ul me-2"></i>所有任务
                    </h6>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>任务名称</th>
                                    <th>类型</th>
                                    <th>源路径</th>
                                    <th>状态</th>
                                    <th>开始时间</th>
                                    <th>完成时间</th>
                                    <th>数据大小</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="allTasksTable">
                                <tr>
                                    <td colspan="8" class="text-center text-muted">加载中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 引入计划任务模态框 -->
{% include 'system/_modal_scheduler_task.html' %}
{% include 'system/_modal_directory_browser.html' %}

<script>
// 加载备份统计数据
async function loadBackupStatistics() {
    try {
        const response = await fetch('/api/backup/statistics');
        const stats = await response.json();
        
        if (stats) {
            document.getElementById('totalTasks').textContent = stats.total_tasks || 0;
            document.getElementById('completedTasks').textContent = stats.completed_tasks || 0;
            document.getElementById('runningTasks').textContent = stats.running_tasks || 0;
            document.getElementById('failedTasks').textContent = stats.failed_tasks || 0;
        }
    } catch (error) {
        console.error('加载备份统计失败:', error);
    }
}

// 格式化字节大小
function formatBytes(bytes) {
    if (!bytes || bytes === 0) return '-';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
}

// 格式化日期时间
function formatDateTime(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}

// 格式化任务类型
function formatTaskType(taskType) {
    const typeMap = {
        'full': { text: '完整备份', class: 'bg-info' },
        'incremental': { text: '增量备份', class: 'bg-secondary' },
        'differential': { text: '差异备份', class: 'bg-warning' },
        'monthly_full': { text: '月度备份', class: 'bg-primary' }
    };
    const type = typeMap[taskType] || { text: taskType, class: 'bg-secondary' };
    return `<span class="badge ${type.class}">${type.text}</span>`;
}

// 格式化状态
function formatStatus(status) {
    const statusMap = {
        'completed': { text: '成功', class: 'bg-success' },
        'failed': { text: '失败', class: 'bg-danger' },
        'running': { text: '运行中', class: 'bg-primary' },
        'pending': { text: '等待中', class: 'bg-warning' },
        'cancelled': { text: '已取消', class: 'bg-secondary' },
        'paused': { text: '已暂停', class: 'bg-secondary' }
    };
    const s = statusMap[status] || { text: status, class: 'bg-secondary' };
    return `<span class="badge ${s.class}">${s.text}</span>`;
}

// 加载运行中的任务
async function loadRunningTasks() {
    try {
        const response = await fetch('/api/backup/tasks?status=running&limit=10');
        const tasks = await response.json();
        
        const container = document.getElementById('runningTasksList');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (tasks && tasks.length > 0) {
            tasks.forEach(task => {
                const sourcePaths = Array.isArray(task.source_paths) ? task.source_paths.join(', ') : (task.source_paths || 'N/A');
                const progress = task.progress_percent || 0;
                const startedTime = task.started_at ? formatDateTime(task.started_at) : '-';
                const tapeInfo = task.tape_device || task.tape_id || '自动选择';
                
                const taskCard = document.createElement('div');
                taskCard.className = 'col-md-6 col-lg-4 mb-3';
                taskCard.innerHTML = `
                    <div class="service-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0">${task.task_name || '未命名任务'}</h6>
                                <span class="badge bg-primary">运行中</span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">源路径:</small><br>
                                <code>${sourcePaths}</code>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">目标:</small><br>
                                <code>${tapeInfo}</code>
                            </div>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">进度:</small>
                                    <small class="text-muted">${progress.toFixed(1)}%</small>
                                </div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-primary" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">开始时间: ${startedTime}</small>
                                <small class="text-muted">${task.processed_files || 0}/${task.total_files || 0} 文件</small>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(taskCard);
            });
        } else {
            container.innerHTML = '<div class="col-12"><p class="text-muted">暂无运行中的任务</p></div>';
        }
    } catch (error) {
        console.error('加载运行中的任务失败:', error);
        const container = document.getElementById('runningTasksList');
        if (container) {
            container.innerHTML = '<div class="col-12"><p class="text-danger">加载失败: ' + error.message + '</p></div>';
        }
    }
}

// 加载所有任务（包含未运行的计划任务）
async function loadAllTasks() {
    try {
        const statusFilter = document.getElementById('statusFilter')?.value || '';
        const typeFilter = document.getElementById('typeFilter')?.value || '';
        const searchQuery = document.getElementById('searchInput')?.value || '';
        
        let url = '/api/backup/tasks?limit=100&offset=0';
        if (statusFilter) url += `&status=${encodeURIComponent(statusFilter)}`;
        if (typeFilter) url += `&task_type=${encodeURIComponent(typeFilter)}`;
        if (searchQuery) url += `&q=${encodeURIComponent(searchQuery)}`;
        
        const response = await fetch(url);
        const tasks = await response.json();
        
        const tbody = document.getElementById('allTasksTable');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (tasks && tasks.length > 0) {
            tasks.forEach(task => {
                const sourcePaths = Array.isArray(task.source_paths) ? task.source_paths.join(', ') : (task.source_paths || (task.is_template ? '计划任务' : 'N/A'));
                const row = document.createElement('tr');
                row.className = task.is_template ? 'table-warning' : '';
                row.innerHTML = `
                    <td><strong>${task.task_name || '未命名任务'}</strong>${task.is_template ? ' <span class="badge bg-secondary">模板</span>' : ''}</td>
                    <td>${formatTaskType(task.task_type || 'full')}</td>
                    <td><code class="text-truncate d-inline-block" style="max-width:200px;" title="${sourcePaths}">${sourcePaths}</code></td>
                    <td>${formatStatus(task.status || 'pending')}</td>
                    <td>${formatDateTime(task.started_at)}</td>
                    <td>${formatDateTime(task.completed_at)}</td>
                    <td>${formatBytes(task.processed_bytes || 0)}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            ${task.from_scheduler ? `
                                ${task.enabled === false ? `
                                    <button class="btn btn-outline-success" onclick="enableBackupTask(${task.task_id})" title="启用">
                                        <i class="bi bi-play"></i>
                                    </button>
                                ` : `
                                    <button class="btn btn-outline-warning" onclick="disableBackupTask(${task.task_id})" title="禁用">
                                        <i class="bi bi-pause"></i>
                                    </button>
                                `}
                                <button class="btn btn-outline-info" onclick="runBackupTask(${task.task_id})" title="立即运行">
                                    <i class="bi bi-play-circle"></i>
                                </button>
                            ` : `
                                <button class="btn btn-outline-warning" title="禁用" disabled>
                                    <i class="bi bi-pause"></i>
                                </button>
                                <button class="btn btn-outline-info" title="立即运行" disabled>
                                    <i class="bi bi-play-circle"></i>
                                </button>
                            `}
                            <button class="btn btn-outline-primary" onclick="editBackupTask(${task.task_id}, ${task.from_scheduler || false})" title="编辑">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteBackupTask(${task.task_id}, ${task.from_scheduler || false})" title="删除">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">暂无任务</td></tr>';
        }
    } catch (error) {
        console.error('加载所有任务失败:', error);
        const tbody = document.getElementById('allTasksTable');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">加载失败: ' + error.message + '</td></tr>';
        }
    }
}

// 查看任务详情
function viewTaskDetails(taskId) {
    // TODO: 实现查看任务详情
    console.log('查看任务详情:', taskId);
}

// 下载备份
function downloadBackup(taskId) {
    // TODO: 实现下载备份
    console.log('下载备份:', taskId);
}

// 重试任务
function retryTask(taskId) {
    // TODO: 实现重试任务
    console.log('重试任务:', taskId);
}

// 禁用备份任务（计划任务）
async function disableBackupTask(taskId) {
    if (!confirm('确定要禁用此计划任务吗？')) {
        return;
    }
    try {
        const response = await fetch(`/api/scheduler/tasks/${taskId}/disable`, {
            method: 'POST'
        });
        const result = await response.json();
        if (result.success) {
            alert('任务已禁用');
            loadAllTasks();
        } else {
            alert('禁用失败: ' + (result.message || '未知错误'));
        }
    } catch (error) {
        console.error('禁用任务失败:', error);
        alert('禁用失败: ' + error.message);
    }
}

// 启用备份任务（计划任务）
async function enableBackupTask(taskId) {
    if (!confirm('确定要启用此计划任务吗？')) {
        return;
    }
    try {
        const response = await fetch(`/api/scheduler/tasks/${taskId}/enable`, {
            method: 'POST'
        });
        const result = await response.json();
        if (result.success) {
            alert('任务已启用');
            loadAllTasks();
        } else {
            alert('启用失败: ' + (result.message || '未知错误'));
        }
    } catch (error) {
        console.error('启用任务失败:', error);
        alert('启用失败: ' + error.message);
    }
}

// 运行备份任务（计划任务）
async function runBackupTask(taskId) {
    if (!confirm('确定要立即运行此计划任务吗？')) {
        return;
    }
    try {
        const response = await fetch(`/api/scheduler/tasks/${taskId}/run`, {
            method: 'POST'
        });
        const result = await response.json();
        if (result.success) {
            alert('任务已启动');
            loadAllTasks();
            loadRunningTasks();
        } else {
            alert('运行失败: ' + (result.message || '未知错误'));
        }
    } catch (error) {
        console.error('运行任务失败:', error);
        alert('运行失败: ' + error.message);
    }
}

// 编辑备份任务
async function editBackupTask(taskId, isScheduler) {
    // 确保 SchedulerManager 已加载
    if (!window.SchedulerManager) {
        // 动态加载 SchedulerManager
        try {
            const module = await import('/static/js/modules/system/scheduler.js');
            window.SchedulerManager = module.SchedulerManager;
        } catch (error) {
            console.error('加载 SchedulerManager 失败:', error);
            alert('无法加载计划任务管理器，请刷新页面重试');
            return;
        }
    }
    
    if (isScheduler === true || isScheduler === 'true') {
        // 直接调用计划任务的编辑功能
        window.SchedulerManager.editTask(taskId);
        return;
    }
    
    // 备份任务模板：转换为计划任务格式并填充表单
    try {
        let backupTask;
        try {
            // 尝试获取备份任务详情
            const response = await fetch(`/api/backup/tasks/${taskId}`);
            if (!response.ok) {
                // 如果404，说明可能是计划任务的ID，尝试直接编辑计划任务
                if (response.status === 404) {
                    console.log('备份任务不存在，尝试作为计划任务编辑:', taskId);
                    window.SchedulerManager.editTask(taskId);
                    return;
                }
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            backupTask = await response.json();
        } catch (error) {
            // 如果获取失败，尝试作为计划任务编辑
            console.log('获取备份任务失败，尝试作为计划任务编辑:', error);
            try {
                window.SchedulerManager.editTask(taskId);
                return;
            } catch (schedError) {
                console.error('编辑计划任务也失败:', schedError);
                throw error;
            }
        }
        
        // 尝试通过任务名称查找计划任务
        try {
            const schedResponse = await fetch(`/api/scheduler/tasks`);
            const schedTasks = await schedResponse.json();
            const matchingTask = schedTasks.find(t => t.task_name === backupTask.task_name);
            
            if (matchingTask) {
                // 找到对应的计划任务，直接编辑
                window.SchedulerManager.editTask(matchingTask.id);
                return;
            }
        } catch (error) {
            console.log('查找计划任务失败，将使用备份任务模板数据:', error);
        }
        
        // 没有对应的计划任务，将备份任务模板转换为计划任务格式
        const sourcePaths = backupTask.source_paths || [];
        const excludePatterns = Array.isArray(backupTask.exclude_patterns) 
            ? backupTask.exclude_patterns 
            : (backupTask.exclude_patterns ? backupTask.exclude_patterns.split('\n') : []);
        
        // 构建计划任务格式的数据
        const schedulerTaskData = {
            id: null, // 新建任务
            task_name: backupTask.task_name || '',
            description: backupTask.description || '',
            schedule_type: 'once', // 默认一次性任务
            schedule_config: {
                datetime: new Date().toISOString().replace('T', ' ').substring(0, 19)
            },
            action_type: 'backup',
            action_config: {
                source_paths: sourcePaths,
                task_type: backupTask.task_type || 'full',
                tape_device: backupTask.tape_device || null,
                target_type: backupTask.tape_device ? 'tape' : 'storage',
                tape_devices: backupTask.tape_device ? [backupTask.tape_device] : [],
                compression_enabled: backupTask.compression_enabled !== false,
                encryption_enabled: backupTask.encryption_enabled === true,
                exclude_patterns: excludePatterns
            },
            enabled: true
        };
        
        // 填充表单并打开模态框
        window.SchedulerManager.fillForm(schedulerTaskData);
        window.SchedulerManager.currentTask = null; // 标记为新建任务
        
        const modal = new bootstrap.Modal(document.getElementById('scheduledTaskModal'));
        modal.show();
    } catch (error) {
        console.error('编辑备份任务失败:', error);
        alert('编辑失败: ' + error.message);
    }
}

// 删除备份任务
async function deleteBackupTask(taskId, isScheduler) {
    if (!confirm('确定要删除此任务吗？此操作不可恢复！')) {
        return;
    }
    try {
        if (isScheduler) {
            // 删除计划任务
            const response = await fetch(`/api/scheduler/tasks/${taskId}`, {
                method: 'DELETE'
            });
            const result = await response.json();
            if (result.success) {
                alert('任务已删除');
                loadAllTasks();
            } else {
                alert('删除失败: ' + (result.message || '未知错误'));
            }
        } else {
            // 删除备份任务模板
            const response = await fetch(`/api/backup/tasks/${taskId}`, {
                method: 'DELETE'
            });
            const result = await response.json();
            if (result.success) {
                alert('备份任务模板已删除');
                loadAllTasks();
            } else {
                alert('删除失败: ' + (result.message || '未知错误'));
            }
        }
    } catch (error) {
        console.error('删除任务失败:', error);
        alert('删除失败: ' + error.message);
    }
}

// 页面加载时加载数据
document.addEventListener('DOMContentLoaded', async function() {
    // 确保 SchedulerManager 已加载
    if (!window.SchedulerManager) {
        try {
            const module = await import('/static/js/modules/system/scheduler.js');
            window.SchedulerManager = module.SchedulerManager;
            // 初始化 SchedulerManager（但不加载任务列表）
            if (!window.SchedulerManager.initialized) {
                await window.SchedulerManager.loadTapeDevices();
                window.SchedulerManager.setupEventListeners();
                window.SchedulerManager.setupActionTypeChange();
                window.SchedulerManager.setupDatePickers();
                window.SchedulerManager.setupDirectoryBrowsers();
                window.SchedulerManager.initialized = true;
            }
        } catch (error) {
            console.error('加载 SchedulerManager 失败:', error);
        }
    }
    
    loadBackupStatistics();
    loadRunningTasks();
    loadAllTasks();
    
    // 绑定筛选和搜索事件
    const statusFilter = document.getElementById('statusFilter');
    const typeFilter = document.getElementById('typeFilter');
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    
    if (statusFilter) {
        statusFilter.addEventListener('change', loadAllTasks);
    }
    if (typeFilter) {
        typeFilter.addEventListener('change', loadAllTasks);
    }
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadAllTasks();
            }
        });
    }
    if (searchBtn) {
        searchBtn.addEventListener('click', loadAllTasks);
    }
    
    // 每30秒刷新一次
    setInterval(function() {
        loadBackupStatistics();
        loadRunningTasks();
        loadAllTasks();
    }, 30000);
});
</script>

{% endblock %}