{% extends "base.html" %}

{% block title %}{{ app_name }} - 磁带管理{% endblock %}

{% block extra_css %}
<style>
.tape-card {
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
}
.tape-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.tape-available { border-left-color: #28a745; }
.tape-in-use { border-left-color: #007bff; }
.tape-full { border-left-color: #dc3545; }
.tape-expired { border-left-color: #6c757d; }
.tape-maintenance { border-left-color: #ffc107; }

.health-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}
.health-excellent { background-color: #28a745; }
.health-good { background-color: #17a2b8; }
.health-warning { background-color: #ffc107; }
.health-critical { background-color: #dc3545; }
.health-unknown { background-color: #6c757d; }
</style>
{% endblock %}

{% block content %}
<div class="console-panel">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="mb-0">
            <i class="bi bi-database me-2"></i>磁带管理
        </h5>
        <div>
            <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#scanTapeModal">
                <i class="bi bi-search me-2"></i>扫描磁带
            </button>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTapeModal">
                <i class="bi bi-plus-circle me-2"></i>添加磁带
            </button>
        </div>
    </div>

    <!-- 统计信息 -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="service-card">
                <div class="card-body text-center">
                    <div class="ai-icon mb-2">
                        <i class="bi bi-collection"></i>
                    </div>
                    <h3 class="mb-0" id="statTotalTapes">-</h3>
                    <small class="text-secondary">总磁带数</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="service-card">
                <div class="card-body text-center">
                    <div class="ai-icon mb-2">
                        <i class="bi bi-circle"></i>
                    </div>
                    <h3 class="mb-0" id="statAvailableTapes">-</h3>
                    <small class="text-secondary">可用</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="service-card">
                <div class="card-body text-center">
                    <div class="ai-icon mb-2">
                        <i class="bi bi-play-circle"></i>
                    </div>
                    <h3 class="mb-0" id="statInUseTapes">-</h3>
                    <small class="text-secondary">使用中</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="service-card">
                <div class="card-body text-center">
                    <div class="ai-icon mb-2">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                    <h3 class="mb-0" id="statFullTapes">-</h3>
                    <small class="text-secondary">已满</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="service-card">
                <div class="card-body text-center">
                    <div class="ai-icon mb-2">
                        <i class="bi bi-clock"></i>
                    </div>
                    <h3 class="mb-0" id="statExpiredTapes">-</h3>
                    <small class="text-secondary">已过期</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="service-card">
                <div class="card-body text-center">
                    <div class="ai-icon mb-2">
                        <i class="bi bi-x-circle"></i>
                    </div>
                    <h3 class="mb-0" id="statErrorTapes">-</h3>
                    <small class="text-secondary">故障</small>
                </div>
            </div>
        </div>
    </div>

    <!-- 筛选和搜索 -->
    <div class="row mb-4">
        <div class="col">
            <div class="service-card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <select class="form-select" id="statusFilter">
                                <option value="">所有状态</option>
                                <option value="available">可用</option>
                                <option value="in_use">使用中</option>
                                <option value="full">已满</option>
                                <option value="expired">已过期</option>
                                <option value="maintenance">维护中</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="locationFilter">
                                <option value="">所有位置</option>
                                <option value="drive-1">驱动器 1</option>
                                <option value="drive-2">驱动器 2</option>
                                <option value="storage">存储柜</option>
                                <option value="offsite">外部存储</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="healthFilter">
                                <option value="">所有健康状态</option>
                                <option value="excellent">优秀</option>
                                <option value="good">良好</option>
                                <option value="warning">警告</option>
                                <option value="critical">严重</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="searchInput" placeholder="搜索磁带标签、序列号或备注...">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary w-100" id="searchBtn">
                                <i class="bi bi-search me-1"></i>搜索
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 磁带列表 -->
    <div class="row">
        <div class="col-12">
            <div class="service-card">
                <div class="card-body">
                    <div class="row" id="tapeListContainer">
                        <!-- 磁带卡片将在这里动态生成 -->
                        <div class="col-12 text-center text-muted py-4">
                            <i class="bi bi-arrow-clockwise spinner"></i> 加载中...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 磁带操作历史 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="service-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history me-2"></i>
                        磁带操作历史
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>磁带</th>
                                    <th>操作</th>
                                    <th>用户</th>
                                    <th>状态</th>
                                    <th>备注</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>2025-10-30 10:30:15</td>
                                    <td><span class="badge bg-secondary">TAP002</span></td>
                                    <td>开始备份</td>
                                    <td>system</td>
                                    <td><span class="badge bg-success">成功</span></td>
                                    <td>月度完整备份任务</td>
                                </tr>
                                <tr>
                                    <td>2025-10-29 15:45:22</td>
                                    <td><span class="badge bg-secondary">TAP003</span></td>
                                    <td>完成备份</td>
                                    <td>system</td>
                                    <td><span class="badge bg-success">成功</span></td>
                                    <td>磁带已满，自动卸载</td>
                                </tr>
                                <tr>
                                    <td>2025-10-28 09:20:11</td>
                                    <td><span class="badge bg-secondary">TAP001</span></td>
                                    <td>加载磁带</td>
                                    <td>admin</td>
                                    <td><span class="badge bg-warning">警告</span></td>
                                    <td>手动操作</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 扫描磁带模态框 -->
<div class="modal fade" id="scanTapeModal" tabindex="-1" data-bs-backdrop="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">扫描磁带设备</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>正在扫描磁带设备...</p>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加磁带模态框 -->
<div class="modal fade" id="addTapeModal" tabindex="-1" data-bs-backdrop="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加新磁带</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-outline-info" id="scanForAddTapeBtn">
                            <i class="bi bi-search me-1"></i>从磁带机扫描信息
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary ms-2" id="readTapeLabelBtn">
                            <i class="bi bi-tag me-1"></i>读取磁带标签
                        </button>
                    </div>
                    <div id="tapeLabelInfo" class="alert alert-light d-none mb-3">
                        <small><i class="bi bi-info-circle me-1"></i><span id="tapeLabelInfoText"></span></small>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">磁带标签</label>
                            <input type="text" class="form-control" id="tapeLabel" placeholder="TAP001" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">序列号</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="tapeSerial" placeholder="STK123456789" required>
                                <button type="button" class="btn btn-outline-secondary" id="generateSerialBtn" title="自动生成">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">磁带类型</label>
                            <select class="form-select" id="tapeType" required>
                                <option value="">选择类型</option>
                                <option value="LTO-9">LTO-9</option>
                                <option value="LTO-8">LTO-8</option>
                                <option value="LTO-7">LTO-7</option>
                                <option value="LTO-6">LTO-6</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">容量</label>
                            <select class="form-select" id="tapeCapacity" required>
                                <option value="">选择容量</option>
                                <option value="18TB">18 TB (LTO-9)</option>
                                <option value="12TB">12 TB (LTO-8)</option>
                                <option value="6TB">6 TB (LTO-7)</option>
                                <option value="2.5TB">2.5 TB (LTO-6)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">位置</label>
                        <input type="text" class="form-control" id="tapeLocation" placeholder="存储柜 A-1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">备注</label>
                        <textarea class="form-control" rows="3" id="tapeRemark" placeholder="可选的备注信息"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmAddTapeBtn">添加磁带</button>
            </div>
        </div>
    </div>
</div>

<script>
// 加载磁带数据
async function loadTapeStatistics() {
    try {
        const response = await fetch('/api/tape/inventory');
        const result = await response.json();
        
        if (result) {
            document.getElementById('statTotalTapes').textContent = result.total_tapes || 0;
            document.getElementById('statAvailableTapes').textContent = result.available_tapes || 0;
            document.getElementById('statInUseTapes').textContent = result.in_use_tapes || 0;
            
            // 使用allTapesData统计已满和故障磁带
            const fullTapes = allTapesData.filter(t => t.status === 'full').length;
            document.getElementById('statFullTapes').textContent = fullTapes;
            
            document.getElementById('statExpiredTapes').textContent = result.expired_tapes || 0;
            
            const errorTapes = allTapesData.filter(t => t.status === 'error').length;
            document.getElementById('statErrorTapes').textContent = errorTapes;
        }
    } catch (error) {
        console.error('加载磁带统计失败:', error);
    }
}

// 存储所有磁带数据用于筛选
let allTapesData = [];

// 筛选和搜索磁带列表
function filterTapeList() {
    const container = document.getElementById('tapeListContainer');
    const statusFilter = document.getElementById('statusFilter').value;
    const locationFilter = document.getElementById('locationFilter').value;
    const healthFilter = document.getElementById('healthFilter').value;
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    
    let filteredTapes = allTapesData;
    
    // 状态筛选
    if (statusFilter) {
        filteredTapes = filteredTapes.filter(t => t.status === statusFilter);
    }
    
    // 位置筛选
    if (locationFilter) {
        filteredTapes = filteredTapes.filter(t => 
            t.location && t.location.toLowerCase().includes(locationFilter.toLowerCase())
        );
    }
    
    // 健康状态筛选
    if (healthFilter) {
        const healthMap = {
            'excellent': (score) => score >= 80,
            'good': (score) => score >= 60 && score < 80,
            'warning': (score) => score >= 40 && score < 60,
            'critical': (score) => score < 40
        };
        if (healthMap[healthFilter]) {
            filteredTapes = filteredTapes.filter(t => healthMap[healthFilter](t.health_score));
        }
    }
    
    // 搜索筛选
    if (searchInput) {
        filteredTapes = filteredTapes.filter(t => 
            t.tape_id.toLowerCase().includes(searchInput) ||
            (t.serial_number && t.serial_number.toLowerCase().includes(searchInput)) ||
            (t.location && t.location.toLowerCase().includes(searchInput)) ||
            (t.notes && t.notes.toLowerCase().includes(searchInput))
        );
    }
    
    // 渲染筛选后的列表
    renderTapeList(filteredTapes);
}

// 渲染磁带列表
function renderTapeList(tapes) {
    const container = document.getElementById('tapeListContainer');
    
    if (tapes.length > 0) {
        container.innerHTML = '';
        
        tapes.forEach(tape => {
            // 状态样式
            const statusConfig = {
                'available': {class: 'success', text: '可用'},
                'in_use': {class: 'primary', text: '使用中'},
                'full': {class: 'danger', text: '已满'},
                'expired': {class: 'secondary', text: '已过期'},
                'error': {class: 'danger', text: '故障'},
                'maintenance': {class: 'warning', text: '维护中'},
                'new': {class: 'info', text: '新建'}
            };
            const status = statusConfig[tape.status] || {class: 'secondary', text: tape.status};
            
            // 健康状态
            const getHealthIndicator = (score) => {
                if (score >= 80) return '<span class="health-indicator health-excellent"></span>优秀';
                if (score >= 60) return '<span class="health-indicator health-good"></span>良好';
                if (score >= 40) return '<span class="health-indicator health-warning"></span>警告';
                return '<span class="health-indicator health-critical"></span>严重';
            };
            
            // 容量格式化
            const formatBytes = (bytes) => {
                if (bytes >= 1024 ** 4) return (bytes / (1024 ** 4)).toFixed(1) + ' TB';
                if (bytes >= 1024 ** 3) return (bytes / (1024 ** 3)).toFixed(1) + ' GB';
                if (bytes >= 1024 ** 2) return (bytes / (1024 ** 2)).toFixed(1) + ' MB';
                return bytes + ' B';
            };
            
            // 进度条颜色
            const getProgressColor = (percent) => {
                if (percent >= 90) return 'danger';
                if (percent >= 70) return 'warning';
                return 'success';
            };
            
            const cardHtml = `
                <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                    <div class="service-card tape-${tape.status}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="card-title mb-0">${tape.tape_id}</h6>
                                    <small class="text-muted">序列号: ${tape.serial_number || 'N/A'}</small>
                                </div>
                                <span class="badge bg-${status.class}">${status.text}</span>
                            </div>
                            <div class="mb-2">
                                ${getHealthIndicator(tape.health_score)}
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">类型: </small>
                                <span>LTO-${tape.generation}</span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">容量: </small>
                                <span>${formatBytes(tape.used_bytes)} / ${formatBytes(tape.capacity_bytes)}</span>
                            </div>
                            <div class="mb-2">
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-${getProgressColor(tape.usage_percent)}" style="width: ${tape.usage_percent}%"></div>
                                </div>
                                <small class="text-muted">${tape.usage_percent.toFixed(1)}% 使用</small>
                            </div>
                            ${tape.location ? `<div class="mb-2">
                                <small class="text-muted">位置: </small>
                                <span>${tape.location}</span>
                            </div>` : ''}
                            ${tape.first_use_date ? `<div class="mb-2">
                                <small class="text-muted">首次使用: </small>
                                <span>${new Date(tape.first_use_date).toLocaleDateString()}</span>
                            </div>` : ''}
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-sm btn-outline-primary" data-tape-id="${tape.tape_id}" onclick="showTapeDetails('${tape.tape_id}')">
                                    <i class="bi bi-info-circle"></i> 详情
                                </button>
                                <button class="btn btn-sm btn-outline-warning" data-tape-id="${tape.tape_id}" onclick="editTape('${tape.tape_id}')">
                                    <i class="bi bi-pencil"></i> 编辑
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', cardHtml);
        });
    } else {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无磁带</div>';
    }
}

// 加载磁带列表
async function loadTapeList() {
    try {
        const response = await fetch('/api/tape/list');
        const result = await response.json();
        
        if (result.success && result.tapes) {
            allTapesData = result.tapes;
            filterTapeList();
        } else {
            document.getElementById('tapeListContainer').innerHTML = '<div class="col-12 text-center text-muted py-4">暂无磁带</div>';
        }
    } catch (error) {
        console.error('加载磁带列表失败:', error);
        document.getElementById('tapeListContainer').innerHTML = '<div class="col-12 text-center text-danger py-4">加载失败</div>';
    }
}

// 扫描磁带功能
document.addEventListener('DOMContentLoaded', function() {
    // 页面加载时加载数据（先加载列表再加载统计）
    loadTapeList().then(() => {
        loadTapeStatistics();
    });
    
    // 筛选器事件监听
    document.getElementById('statusFilter').addEventListener('change', filterTapeList);
    document.getElementById('locationFilter').addEventListener('change', filterTapeList);
    document.getElementById('healthFilter').addEventListener('change', filterTapeList);
    document.getElementById('searchInput').addEventListener('input', filterTapeList);
    document.getElementById('searchBtn').addEventListener('click', filterTapeList);
    
    // 监听模态框显示事件，执行扫描
    const scanModal = document.getElementById('scanTapeModal');
    if (scanModal) {
        scanModal.addEventListener('show.bs.modal', async function() {
            const modalBody = this.querySelector('.modal-body');
            modalBody.innerHTML = '<p>正在扫描磁带设备...</p><div class="progress"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div></div>';
            
            try {
                const response = await fetch('/api/system/tape/scan');
                const result = await response.json();
                
                if (result.success && result.devices && result.devices.length > 0) {
                    let html = '<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>检测到 ' + result.devices.length + ' 个磁带设备</div>';
                    html += '<div class="list-group mt-3">';
                    result.devices.forEach(device => {
                        html += '<div class="list-group-item">';
                        html += '<div class="d-flex w-100 justify-content-between align-items-start mb-2"><h6 class="mb-0"><i class="bi bi-server me-1"></i>' + (device.vendor || 'Unknown') + ' ' + (device.model || 'Unknown') + '</h6>';
                        if (device.is_ibm_lto && device.lto_generation) {
                            html += '<span class="badge bg-info">LTO-' + device.lto_generation + '</span>';
                        }
                        html += '</div>';
                        html += '<div class="row g-2 mt-2">';
                        html += '<div class="col-md-6"><small class="text-muted"><i class="bi bi-geo-alt me-1"></i>路径:</small><br><code>' + (device.path || '') + '</code></div>';
                        if (device.serial && device.serial !== 'Unknown') {
                            html += '<div class="col-md-6"><small class="text-muted"><i class="bi bi-upc-scan me-1"></i>序列号:</small><br><strong>' + device.serial + '</strong></div>';
                        }
                        html += '</div>';
                        if (device.native_capacity) {
                            const tb = (device.native_capacity / (1024 ** 4)).toFixed(1);
                            html += '<div class="mt-2"><small class="text-muted"><i class="bi bi-hdd me-1"></i>原生容量: <strong>' + tb + ' TB</strong></small></div>';
                        }
                        if (device.scsi_bus || device.scsi_target_id !== undefined) {
                            html += '<div class="mt-1"><small class="text-muted"><i class="bi bi-diagram-3 me-1"></i>SCSI: ';
                            if (device.scsi_bus !== 'Unknown') html += 'Bus ' + device.scsi_bus;
                            if (device.scsi_target_id !== 'Unknown') html += ', Target ' + device.scsi_target_id;
                            if (device.scsi_lun !== 'Unknown') html += ', LUN ' + device.scsi_lun;
                            html += '</small></div>';
                        }
                        if (device.is_ibm_lto) {
                            html += '<div class="mt-2">';
                            html += '<span class="badge bg-success me-1">IBM LTO</span>';
                            if (device.supports_worm) html += '<span class="badge bg-primary me-1">WORM</span>';
                            if (device.supports_encryption) html += '<span class="badge bg-secondary me-1">加密</span>';
                            html += '</div>';
                        }
                        html += '<div class="mt-2">';
                        if (device.status === 'online') {
                            html += '<span class="badge bg-success"><i class="bi bi-circle-fill"></i> 在线</span>';
                        } else {
                            html += '<span class="badge bg-danger"><i class="bi bi-circle"></i> 离线</span>';
                        }
                        html += '</div>';
                        html += '</div>';
                    });
                    html += '</div>';
                    modalBody.innerHTML = html;
                } else {
                    modalBody.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle me-2"></i>未检测到磁带设备</div>';
                }
            } catch (error) {
                modalBody.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle me-2"></i>扫描失败: ' + error.message + '</div>';
            }
        });
    }
    
    // 生成序列号
    const generateSerialBtn = document.getElementById('generateSerialBtn');
    if (generateSerialBtn) {
        generateSerialBtn.addEventListener('click', function() {
            // 生成基于时间戳的序列号
            const prefix = 'STK';
            const timestamp = Date.now().toString();
            const serial = prefix + timestamp.substring(timestamp.length - 9);
            document.getElementById('tapeSerial').value = serial;
        });
    }
    
    // 从磁带机扫描信息
    const scanForAddTapeBtn = document.getElementById('scanForAddTapeBtn');
    if (scanForAddTapeBtn) {
        scanForAddTapeBtn.addEventListener('click', async function() {
            const btn = this;
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise spinner me-1"></i>扫描中...';
            
            try {
                const response = await fetch('/api/system/tape/scan');
                const result = await response.json();
                
                if (result.success && result.devices && result.devices.length > 0) {
                    // 使用第一个设备的信息填充表单
                    const device = result.devices[0];
                    
                    // 如果有LTO信息，自动选择类型和容量
                    if (device.is_ibm_lto && device.lto_generation) {
                        const ltoGen = device.lto_generation;
                        const tapeTypeValue = `LTO-${ltoGen}`;
                        document.getElementById('tapeType').value = tapeTypeValue;
                        
                        // 根据LTO代数设置容量
                        const capacityMap = {
                            9: '18TB',
                            8: '12TB',
                            7: '6TB',
                            6: '2.5TB',
                            5: '1.5TB'
                        };
                        if (capacityMap[ltoGen]) {
                            const capacityValue = capacityMap[ltoGen];
                            document.getElementById('tapeCapacity').value = capacityValue;
                        }
                    }
                    
                    // 生成磁带标签（基于当前日期和索引）
                    const now = new Date();
                    const dateStr = now.getFullYear().toString().substring(2) + 
                                   String(now.getMonth() + 1).padStart(2, '0') + 
                                   String(now.getDate()).padStart(2, '0');
                    const randomPart = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                    document.getElementById('tapeLabel').value = `TAP${dateStr}${randomPart}`;
                    
                    // 生成序列号
                    const prefix = 'STK';
                    const timestamp = Date.now().toString();
                    const serial = prefix + timestamp.substring(timestamp.length - 9);
                    document.getElementById('tapeSerial').value = serial;
                    
                    alert('✅ 扫描成功，已自动填充信息');
                } else {
                    alert('⚠️ 未检测到磁带设备');
                }
            } catch (error) {
                alert('❌ 扫描失败：' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        });
    }
    
    // 读取磁带标签
    const readTapeLabelBtn = document.getElementById('readTapeLabelBtn');
    if (readTapeLabelBtn) {
        readTapeLabelBtn.addEventListener('click', async function() {
            const btn = this;
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise spinner me-1"></i>读取中...';
            
            try {
                const response = await fetch('/api/tape/read-label');
                const result = await response.json();
                
                const infoDiv = document.getElementById('tapeLabelInfo');
                const infoText = document.getElementById('tapeLabelInfoText');
                
                if (result.success && result.metadata) {
                    const metadata = result.metadata;
                    
                    // 填充表单
                    if (metadata.tape_id) {
                        document.getElementById('tapeLabel').value = metadata.tape_id;
                    }
                    if (metadata.serial_number) {
                        document.getElementById('tapeSerial').value = metadata.serial_number;
                    }
                    if (metadata.created_date) {
                        const createdDate = new Date(metadata.created_date);
                        const expiryDate = new Date(metadata.expiry_date);
                        const daysUntilExpiry = Math.floor((expiryDate - new Date()) / (1000 * 60 * 60 * 24));
                        
                        let statusText = '从磁带读取到的信息: ';
                        if (daysUntilExpiry > 0) {
                            statusText += `创建日期: ${createdDate.toLocaleDateString()}, 距离过期还有 ${daysUntilExpiry} 天`;
                            infoDiv.className = 'alert alert-success mb-3';
                        } else {
                            statusText += `创建日期: ${createdDate.toLocaleDateString()}, 磁带已过期，需要擦除`;
                            infoDiv.className = 'alert alert-danger mb-3';
                        }
                        infoText.textContent = statusText;
                        infoDiv.classList.remove('d-none');
                    } else {
                        infoText.textContent = '读取到磁带标签，但无过期信息';
                        infoDiv.className = 'alert alert-warning mb-3';
                        infoDiv.classList.remove('d-none');
                    }
                    
                    // 检查是否在数据库中存在
                    if (metadata.tape_id) {
                        const checkResponse = await fetch(`/api/tape/check/${metadata.tape_id}`);
                        const checkResult = await checkResponse.json();
                        
                        if (checkResult.exists) {
                            infoText.textContent += ' (数据库中已存在此磁带记录)';
                        }
                    }
                } else {
                    infoText.textContent = '未检测到磁带标签或磁带为空';
                    infoDiv.className = 'alert alert-warning mb-3';
                    infoDiv.classList.remove('d-none');
                }
            } catch (error) {
                document.getElementById('tapeLabelInfoText').textContent = '读取标签失败: ' + error.message;
                document.getElementById('tapeLabelInfo').className = 'alert alert-danger mb-3';
                document.getElementById('tapeLabelInfo').classList.remove('d-none');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        });
    }
    
    // 确认添加磁带
    const confirmAddTapeBtn = document.getElementById('confirmAddTapeBtn');
    if (confirmAddTapeBtn) {
        confirmAddTapeBtn.addEventListener('click', async function() {
            const btn = this;
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise spinner me-2"></i>添加中...';
            
            try {
                // 获取表单数据
                const tapeLabel = document.getElementById('tapeLabel').value;
                const tapeSerial = document.getElementById('tapeSerial').value;
                const tapeType = document.getElementById('tapeType').value;
                const tapeCapacity = document.getElementById('tapeCapacity').value;
                const tapeLocation = document.getElementById('tapeLocation').value;
                const tapeRemark = document.getElementById('tapeRemark').value;
                
                // 验证必填字段
                if (!tapeLabel || !tapeSerial || !tapeType || !tapeCapacity) {
                    alert('❌ 请填写所有必填字段');
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                    return;
                }
                
                // 从类型中提取代数 (LTO-9 -> 9)
                const generation = parseInt(tapeType.replace('LTO-', ''));
                
                // 从容量中提取GB (18TB -> 18)
                const capacityGB = parseInt(tapeCapacity.replace('TB', ''));
                
                // 构建请求数据
                const requestData = {
                    tape_id: tapeLabel,  // 使用label作为tape_id
                    label: tapeLabel,
                    serial_number: tapeSerial,
                    media_type: 'LTO',
                    generation: generation,
                    capacity_gb: capacityGB,
                    location: tapeLocation,
                    notes: tapeRemark,
                    retention_months: 6
                };
                
                // 发送创建请求
                const response = await fetch('/api/tape/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ ' + result.message);
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addTapeModal'));
                    modal.hide();
                    // 清空表单
                    document.getElementById('tapeLabel').value = '';
                    document.getElementById('tapeSerial').value = '';
                    document.getElementById('tapeType').value = '';
                    document.getElementById('tapeCapacity').value = '';
                    document.getElementById('tapeLocation').value = '';
                    document.getElementById('tapeRemark').value = '';
                    // 刷新列表和统计
                    loadTapeList().then(() => {
                        loadTapeStatistics();
                    });
                } else {
                    alert('❌ 添加失败：' + result.message);
                }
            } catch (error) {
                alert('❌ 添加失败：' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        });
    }
});

// 显示磁带详情
async function showTapeDetails(tapeId) {
    const tape = allTapesData.find(t => t.tape_id === tapeId);
    if (!tape) {
        alert('找不到磁带信息');
        return;
    }
    
    // 容量格式化
    const formatBytes = (bytes) => {
        if (bytes >= 1024 ** 4) return (bytes / (1024 ** 4)).toFixed(2) + ' TB';
        if (bytes >= 1024 ** 3) return (bytes / (1024 ** 3)).toFixed(2) + ' GB';
        if (bytes >= 1024 ** 2) return (bytes / (1024 ** 2)).toFixed(2) + ' MB';
        return bytes + ' B';
    };
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="fw-bold">基本信息</h6>
                <table class="table table-sm table-borderless">
                    <tr><td class="text-muted" style="width: 40%;">磁带ID:</td><td>${tape.tape_id}</td></tr>
                    <tr><td class="text-muted">标签:</td><td>${tape.label}</td></tr>
                    <tr><td class="text-muted">序列号:</td><td>${tape.serial_number || 'N/A'}</td></tr>
                    <tr><td class="text-muted">类型:</td><td>LTO-${tape.generation}</td></tr>
                    <tr><td class="text-muted">状态:</td><td><span class="badge bg-${tape.status === 'available' ? 'success' : tape.status === 'in_use' ? 'primary' : 'danger'}">${tape.status}</span></td></tr>
                    <tr><td class="text-muted">位置:</td><td>${tape.location || 'N/A'}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="fw-bold">容量信息</h6>
                <table class="table table-sm table-borderless">
                    <tr><td class="text-muted" style="width: 40%;">总容量:</td><td>${formatBytes(tape.capacity_bytes)}</td></tr>
                    <tr><td class="text-muted">已使用:</td><td>${formatBytes(tape.used_bytes)}</td></tr>
                    <tr><td class="text-muted">可用:</td><td>${formatBytes(tape.capacity_bytes - tape.used_bytes)}</td></tr>
                    <tr><td class="text-muted">使用率:</td><td>${tape.usage_percent.toFixed(2)}%</td></tr>
                    <tr><td class="text-muted">保留月数:</td><td>${tape.retention_months}</td></tr>
                    <tr><td class="text-muted">健康分数:</td><td>${tape.health_score}/100</td></tr>
                </table>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-6">
                <h6 class="fw-bold">使用统计</h6>
                <table class="table table-sm table-borderless">
                    <tr><td class="text-muted" style="width: 40%;">写入次数:</td><td>${tape.write_count}</td></tr>
                    <tr><td class="text-muted">读取次数:</td><td>${tape.read_count}</td></tr>
                    <tr><td class="text-muted">加载次数:</td><td>${tape.load_count}</td></tr>
                    <tr><td class="text-muted">备份集:</td><td>${tape.backup_set_count}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="fw-bold">时间信息</h6>
                <table class="table table-sm table-borderless">
                    <tr><td class="text-muted" style="width: 40%;">首次使用:</td><td>${tape.first_use_date ? new Date(tape.first_use_date).toLocaleString() : 'N/A'}</td></tr>
                    <tr><td class="text-muted">最后擦除:</td><td>${tape.last_erase_date ? new Date(tape.last_erase_date).toLocaleString() : 'N/A'}</td></tr>
                    <tr><td class="text-muted">过期时间:</td><td>${tape.expiry_date ? new Date(tape.expiry_date).toLocaleString() : 'N/A'}</td></tr>
                </table>
            </div>
        </div>
        ${tape.notes ? `<div class="row mt-3"><div class="col-12"><h6 class="fw-bold">备注</h6><p class="text-muted">${tape.notes}</p></div></div>` : ''}
    `;
    
    // 显示详情模态框
    const modal = new bootstrap.Modal(document.getElementById('tapeDetailsModal'));
    document.getElementById('tapeDetailsModalBody').innerHTML = html;
    modal.show();
}

// 编辑磁带
function editTape(tapeId) {
    const tape = allTapesData.find(t => t.tape_id === tapeId);
    if (!tape) {
        alert('找不到磁带信息');
        return;
    }
    
    alert(`编辑磁带功能开发中: ${tapeId}`);
}
</script>

<!-- 磁带详情模态框 -->
<div class="modal fade" id="tapeDetailsModal" tabindex="-1" data-bs-backdrop="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">磁带详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="tapeDetailsModalBody">
                <!-- 详情内容将动态加载 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}