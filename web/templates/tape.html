{% extends "base.html" %}

{% block title %}{{ app_name }} - 磁带管理{% endblock %}

{% block extra_css %}
<style>
.tape-card {
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
}
.tape-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.tape-available { border-left-color: #28a745; }
.tape-in-use { border-left-color: #007bff; }
.tape-full { border-left-color: #dc3545; }
.tape-expired { border-left-color: #6c757d; }
.tape-maintenance { border-left-color: #ffc107; }

.health-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}
.health-excellent { background-color: #28a745; }
.health-good { background-color: #17a2b8; }
.health-warning { background-color: #ffc107; }
.health-critical { background-color: #dc3545; }
.health-unknown { background-color: #6c757d; }
</style>
{% endblock %}

{% block content %}
<div class="console-panel">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="mb-0">
            <i class="bi bi-database me-2"></i>磁带管理
        </h5>
        <div>
            <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#scanTapeModal">
                <i class="bi bi-search me-2"></i>扫描磁带
            </button>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTapeModal">
                <i class="bi bi-plus-circle me-2"></i>添加磁带
            </button>
        </div>
    </div>

    <!-- 统计信息 -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="service-card">
                <div class="card-body text-center">
                    <div class="ai-icon mb-2">
                        <i class="bi bi-collection"></i>
                    </div>
                    <h3 class="mb-0" id="statTotalTapes">-</h3>
                    <small class="text-secondary">总磁带数</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="service-card">
                <div class="card-body text-center">
                    <div class="ai-icon mb-2">
                        <i class="bi bi-circle"></i>
                    </div>
                    <h3 class="mb-0" id="statAvailableTapes">-</h3>
                    <small class="text-secondary">可用</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="service-card">
                <div class="card-body text-center">
                    <div class="ai-icon mb-2">
                        <i class="bi bi-play-circle"></i>
                    </div>
                    <h3 class="mb-0" id="statInUseTapes">-</h3>
                    <small class="text-secondary">使用中</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="service-card">
                <div class="card-body text-center">
                    <div class="ai-icon mb-2">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                    <h3 class="mb-0" id="statFullTapes">-</h3>
                    <small class="text-secondary">已满</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="service-card">
                <div class="card-body text-center">
                    <div class="ai-icon mb-2">
                        <i class="bi bi-clock"></i>
                    </div>
                    <h3 class="mb-0" id="statExpiredTapes">-</h3>
                    <small class="text-secondary">已过期</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="service-card">
                <div class="card-body text-center">
                    <div class="ai-icon mb-2">
                        <i class="bi bi-x-circle"></i>
                    </div>
                    <h3 class="mb-0" id="statErrorTapes">-</h3>
                    <small class="text-secondary">故障</small>
                </div>
            </div>
        </div>
    </div>

    <!-- 筛选和搜索 -->
    <div class="row mb-4">
        <div class="col">
            <div class="service-card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <select class="form-select" id="statusFilter">
                                <option value="">所有状态</option>
                                <option value="available">可用</option>
                                <option value="in_use">使用中</option>
                                <option value="full">已满</option>
                                <option value="expired">已过期</option>
                                <option value="maintenance">维护中</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="locationFilter">
                                <option value="">所有位置</option>
                                <option value="drive-1">驱动器 1</option>
                                <option value="drive-2">驱动器 2</option>
                                <option value="storage">存储柜</option>
                                <option value="offsite">外部存储</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="healthFilter">
                                <option value="">所有健康状态</option>
                                <option value="excellent">优秀</option>
                                <option value="good">良好</option>
                                <option value="warning">警告</option>
                                <option value="critical">严重</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="searchInput" placeholder="搜索磁带标签、序列号或备注...">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary w-100" id="searchBtn">
                                <i class="bi bi-search me-1"></i>搜索
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 磁带列表 -->
    <div class="row">
        <div class="col-12">
            <div class="service-card">
                <div class="card-body">
                    <div class="row" id="tapeListContainer">
                        <!-- 磁带卡片将在这里动态生成 -->
                        <div class="col-12 text-center text-muted py-4">
                            <i class="bi bi-arrow-clockwise spinner"></i> 加载中...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 磁带操作历史 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="service-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history me-2"></i>
                        磁带操作历史
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>磁带</th>
                                    <th>操作</th>
                                    <th>用户</th>
                                    <th>状态</th>
                                    <th>备注</th>
                                </tr>
                            </thead>
                            <tbody id="tapeHistoryTableBody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">加载中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 扫描磁带模态框 -->
<div class="modal fade" id="scanTapeModal" tabindex="-1" data-bs-backdrop="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">扫描磁带设备</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>正在扫描磁带设备...</p>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加/编辑磁带模态框 -->
<div class="modal fade" id="addTapeModal" tabindex="-1" data-bs-backdrop="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTapeModalTitle">添加新磁带</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-outline-info" id="scanForAddTapeBtn">
                            <i class="bi bi-search me-1"></i>从磁带机扫描信息（包含读取磁带标签）
                        </button>
                    </div>
                    <div id="tapeLabelInfo" class="alert alert-light d-none mb-3">
                        <small><i class="bi bi-info-circle me-1"></i><span id="tapeLabelInfoText"></span></small>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">创建年月</label>
                            <select class="form-select" id="tapeMonth">
                                <option value="01">1月</option>
                                <option value="02">2月</option>
                                <option value="03">3月</option>
                                <option value="04">4月</option>
                                <option value="05">5月</option>
                                <option value="06">6月</option>
                                <option value="07">7月</option>
                                <option value="08">8月</option>
                                <option value="09">9月</option>
                                <option value="10">10月</option>
                                <option value="11">11月</option>
                                <option value="12">12月</option>
                            </select>
                            <small class="text-muted">默认为当前月</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">磁带标签</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="tapeLabel" placeholder="TAP001" required>
                                <button type="button" class="btn btn-outline-secondary" id="generateLabelBtn" title="生成标签">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">序列号</label>
                            <input type="text" class="form-control" id="tapeSerial" placeholder="STK123456789" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">磁带类型</label>
                            <select class="form-select" id="tapeType" required>
                                <option value="">选择类型</option>
                                <option value="LTO-9">LTO-9</option>
                                <option value="LTO-8">LTO-8</option>
                                <option value="LTO-7">LTO-7</option>
                                <option value="LTO-6">LTO-6</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">容量</label>
                            <select class="form-select" id="tapeCapacity" required>
                                <option value="">选择容量</option>
                                <option value="18TB">18TB (LTO-9)</option>
                                <option value="12TB">12TB (LTO-8)</option>
                                <option value="6TB">6TB (LTO-7)</option>
                                <option value="2.5TB">2.5TB (LTO-6)</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">位置</label>
                            <input type="text" class="form-control" id="tapeLocation" value="机房" placeholder="机房">
                    </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">备注</label>
                        <textarea class="form-control" rows="3" id="tapeRemark" placeholder="可选的备注信息"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmAddTapeBtn">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 扫描结果模态框 -->
<div class="modal fade" id="scanResultModal" tabindex="-1" data-bs-backdrop="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">磁带设备扫描结果</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="scanResultBody">
                <p>正在扫描...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="applyScanResultBtn" data-bs-dismiss="modal" disabled>应用信息</button>
            </div>
        </div>
    </div>
</div>

<script>
// 重置磁带表单状态
function resetTapeForm() {
    // 清空表单
    document.getElementById('tapeLabel').value = '';
    document.getElementById('tapeSerial').value = '';
    document.getElementById('tapeType').value = '';
    document.getElementById('tapeCapacity').value = '';
    document.getElementById('tapeLocation').value = '';
    document.getElementById('tapeRemark').value = '';
    
    // 重置月份为当前月
    const now = new Date();
    const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
    document.getElementById('tapeMonth').value = currentMonth;
    
    // 恢复表单状态
    document.getElementById('tapeLabel').readOnly = false;
    document.getElementById('tapeLabel').disabled = false;
    document.getElementById('tapeMonth').disabled = false;
    document.getElementById('scanForAddTapeBtn').style.display = '';
    document.getElementById('generateLabelBtn').style.display = '';
    document.getElementById('generateLabelBtn').disabled = false;
    
    // 重置模态框标题和按钮文本
    document.getElementById('addTapeModalTitle').textContent = '添加新磁带';
    document.getElementById('confirmAddTapeBtn').textContent = '保存';
    
    // 重置编辑模式标记
    const modal = document.getElementById('addTapeModal');
    modal.dataset.editMode = 'false';
    modal.dataset.labelFromTape = 'false';
    delete modal.dataset.editTapeId;
    
    // 隐藏标签信息区域
    document.getElementById('tapeLabelInfo').classList.add('d-none');
}

// 加载磁带数据
async function loadTapeStatistics() {
    try {
        const response = await fetch('/api/tape/inventory');
        const result = await response.json();
        
        if (result) {
            document.getElementById('statTotalTapes').textContent = result.total_tapes || 0;
            document.getElementById('statAvailableTapes').textContent = result.available_tapes || 0;
            document.getElementById('statInUseTapes').textContent = result.in_use_tapes || 0;
            
            // 使用allTapesData统计已满和故障磁带
            const fullTapes = allTapesData.filter(t => t.status === 'full').length;
            document.getElementById('statFullTapes').textContent = fullTapes;
            
            document.getElementById('statExpiredTapes').textContent = result.expired_tapes || 0;
            
            const errorTapes = allTapesData.filter(t => t.status === 'error').length;
            document.getElementById('statErrorTapes').textContent = errorTapes;
        }
    } catch (error) {
        console.error('加载磁带统计失败:', error);
    }
}

// 加载磁带操作历史
async function loadTapeHistory() {
    try {
        const tbody = document.getElementById('tapeHistoryTableBody');
        if (!tbody) return;
        
        // 显示加载中
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">加载中...</td></tr>';
        
        const response = await fetch('/api/tape/history?limit=50&offset=0');
        const result = await response.json();
        
        if (result && result.success && result.history && result.history.length > 0) {
            tbody.innerHTML = '';
            
            result.history.forEach(log => {
                // 格式化时间
                const time = log.time ? new Date(log.time).toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }) : 'N/A';
                
                // 磁带ID显示
                const tapeBadge = log.tape_id ? `<span class="badge bg-secondary">${log.tape_id}</span>` : '<span class="text-muted">-</span>';
                
                // 操作名称
                const operation = log.operation || '操作';
                
                // 用户名
                const username = log.username || 'system';
                
                // 状态徽章
                const statusBadge = log.success 
                    ? '<span class="badge bg-success">成功</span>' 
                    : '<span class="badge bg-danger">失败</span>';
                
                // 备注信息
                const message = log.message || '';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${time}</td>
                    <td>${tapeBadge}</td>
                    <td>${operation}</td>
                    <td>${username}</td>
                    <td>${statusBadge}</td>
                    <td>${message}</td>
                `;
                tbody.appendChild(row);
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">暂无操作历史</td></tr>';
        }
    } catch (error) {
        console.error('加载磁带操作历史失败:', error);
        const tbody = document.getElementById('tapeHistoryTableBody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">加载失败: ' + error.message + '</td></tr>';
        }
    }
}

// 存储所有磁带数据用于筛选
let allTapesData = [];

// 生成磁带标签和序列号的辅助函数
function generateTapeLabel() {
    const selectedMonth = document.getElementById('tapeMonth').value;
    const now = new Date();
    const month = selectedMonth || String(now.getMonth() + 1).padStart(2, '0');
    const year = now.getFullYear().toString().substring(2);
    const day = String(now.getDate()).padStart(2, '0');
    const dateStr = year + month + day;
    const randomPart = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    return `TAP${dateStr}${randomPart}`;
}

// 生成UUID v4（使用浏览器原生API或降级方案）
function generateUUID() {
    // 优先使用浏览器原生的 crypto.randomUUID() API
    if (typeof crypto !== 'undefined' && crypto.randomUUID) {
        return crypto.randomUUID();
    }
    // 降级方案：手动生成UUID v4
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

function generateTapeSerial() {
    // 使用UUID生成序列号，去掉横线并转换为大写
    return generateUUID().replace(/-/g, '').toUpperCase();
}

// 筛选和搜索磁带列表
function filterTapeList() {
    const container = document.getElementById('tapeListContainer');
    const statusFilter = document.getElementById('statusFilter').value;
    const locationFilter = document.getElementById('locationFilter').value;
    const healthFilter = document.getElementById('healthFilter').value;
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    
    let filteredTapes = allTapesData;
    
    // 状态筛选
    if (statusFilter) {
        filteredTapes = filteredTapes.filter(t => t.status === statusFilter);
    }
    
    // 位置筛选
    if (locationFilter) {
        filteredTapes = filteredTapes.filter(t => 
            t.location && t.location.toLowerCase().includes(locationFilter.toLowerCase())
        );
    }
    
    // 健康状态筛选
    if (healthFilter) {
        const healthMap = {
            'excellent': (score) => score >= 80,
            'good': (score) => score >= 60 && score < 80,
            'warning': (score) => score >= 40 && score < 60,
            'critical': (score) => score < 40
        };
        if (healthMap[healthFilter]) {
            filteredTapes = filteredTapes.filter(t => healthMap[healthFilter](t.health_score));
        }
    }
    
    // 搜索筛选
    if (searchInput) {
        filteredTapes = filteredTapes.filter(t => 
            t.tape_id.toLowerCase().includes(searchInput) ||
            (t.serial_number && t.serial_number.toLowerCase().includes(searchInput)) ||
            (t.location && t.location.toLowerCase().includes(searchInput)) ||
            (t.notes && t.notes.toLowerCase().includes(searchInput))
        );
    }
    
    // 渲染筛选后的列表
    renderTapeList(filteredTapes);
}

// 渲染磁带列表
function renderTapeList(tapes) {
    const container = document.getElementById('tapeListContainer');
    
    if (tapes.length > 0) {
        container.innerHTML = '';
        
        tapes.forEach(tape => {
            // 状态样式（支持大小写）
            const statusConfig = {
                'AVAILABLE': {class: 'success', text: '可用'},
                'available': {class: 'success', text: '可用'},
                'IN_USE': {class: 'primary', text: '使用中'},
                'in_use': {class: 'primary', text: '使用中'},
                'FULL': {class: 'danger', text: '已满'},
                'full': {class: 'danger', text: '已满'},
                'EXPIRED': {class: 'secondary', text: '已过期'},
                'expired': {class: 'secondary', text: '已过期'},
                'ERROR': {class: 'danger', text: '故障'},
                'error': {class: 'danger', text: '故障'},
                'MAINTENANCE': {class: 'warning', text: '维护中'},
                'maintenance': {class: 'warning', text: '维护中'},
                'NEW': {class: 'info', text: '新建'},
                'new': {class: 'info', text: '新建'}
            };
            const status = statusConfig[tape.status] || {class: 'secondary', text: tape.status};
            
            // 健康状态
            const getHealthIndicator = (score) => {
                if (!score && score !== 0) score = 100;  // 默认100分
                if (score >= 80) return '<span class="health-indicator health-excellent"></span>优秀';
                if (score >= 60) return '<span class="health-indicator health-good"></span>良好';
                if (score >= 40) return '<span class="health-indicator health-warning"></span>警告';
                return '<span class="health-indicator health-critical"></span>严重';
            };
            
            // 容量格式化
            const formatBytes = (bytes) => {
                if (bytes >= 1024 ** 4) return (bytes / (1024 ** 4)).toFixed(1) + ' TB';
                if (bytes >= 1024 ** 3) return (bytes / (1024 ** 3)).toFixed(1) + ' GB';
                if (bytes >= 1024 ** 2) return (bytes / (1024 ** 2)).toFixed(1) + ' MB';
                return bytes + ' B';
            };
            
            // 进度条颜色
            const getProgressColor = (percent) => {
                if (percent >= 90) return 'danger';
                if (percent >= 70) return 'warning';
                return 'success';
            };
            
            const cardHtml = `
                <div class="col-lg-3 col-md-3 col-sm-6 mb-3">
                    <div class="service-card tape-${tape.status}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="card-title mb-0">${tape.label || tape.tape_id}</h6>
                                    <small class="text-muted">磁带ID: ${tape.tape_id} | 序列号: ${tape.serial_number || 'N/A'}</small>
                                </div>
                                <span class="badge bg-${status.class}">${status.text}</span>
                            </div>
                            <div class="mb-2">
                                ${getHealthIndicator(tape.health_score)}
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">类型: </small>
                                <span>LTO-${tape.generation} / ${formatBytes(tape.capacity_bytes)}</span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">容量: </small>
                                <span>${formatBytes(tape.used_bytes)} / ${formatBytes(tape.capacity_bytes)} ${tape.usage_percent.toFixed(1)}%</span>
                            </div>
                            <div class="mb-2">
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-${getProgressColor(tape.usage_percent)}" style="width: ${tape.usage_percent}%"></div>
                                </div>
                            </div>
                            ${tape.location ? `<div class="mb-2">
                                <small class="text-muted">位置: </small>
                                <span>${tape.location}</span>
                            </div>` : ''}
                            ${tape.first_use_date ? `<div class="mb-2">
                                <small class="text-muted">首次使用: </small>
                                <span>${new Date(tape.first_use_date).toLocaleDateString()}</span>
                            </div>` : ''}
                            ${tape.expiry_date ? `<div class="mb-2">
                                <small class="text-muted">过期时间: </small>
                                <span>${new Date(tape.expiry_date).toLocaleDateString()}</span>
                            </div>` : ''}
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-sm btn-outline-primary" data-tape-id="${tape.tape_id}" onclick="showTapeDetails('${tape.tape_id}')">
                                    <i class="bi bi-info-circle"></i> 详情
                                </button>
                                <button class="btn btn-sm btn-outline-warning" data-tape-id="${tape.tape_id}" onclick="editTape('${tape.tape_id}')">
                                    <i class="bi bi-pencil"></i> 编辑
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', cardHtml);
        });
    } else {
        container.innerHTML = '<div class="col-12 text-center text-muted py-4">暂无磁带</div>';
    }
}

// 加载磁带列表
async function loadTapeList() {
    try {
        const response = await fetch('/api/tape/list');
        const result = await response.json();
        
        if (result.success && result.tapes) {
            allTapesData = result.tapes;
            filterTapeList();
        } else {
            document.getElementById('tapeListContainer').innerHTML = '<div class="col-12 text-center text-muted py-4">暂无磁带</div>';
        }
    } catch (error) {
        console.error('加载磁带列表失败:', error);
        document.getElementById('tapeListContainer').innerHTML = '<div class="col-12 text-center text-danger py-4">加载失败</div>';
    }
}

// 扫描磁带功能
document.addEventListener('DOMContentLoaded', function() {
    // 页面加载时加载数据（先加载列表再加载统计）
    loadTapeList().then(() => {
        loadTapeStatistics();
        loadTapeHistory();  // 加载操作历史
    });
    
    // 筛选器事件监听
    document.getElementById('statusFilter').addEventListener('change', filterTapeList);
    document.getElementById('locationFilter').addEventListener('change', filterTapeList);
    document.getElementById('healthFilter').addEventListener('change', filterTapeList);
    document.getElementById('searchInput').addEventListener('input', filterTapeList);
    document.getElementById('searchBtn').addEventListener('click', filterTapeList);
    
    // 监听模态框显示事件，执行扫描
    const scanModal = document.getElementById('scanTapeModal');
    if (scanModal) {
        scanModal.addEventListener('show.bs.modal', async function() {
            const modalBody = this.querySelector('.modal-body');
            modalBody.innerHTML = '<p>正在扫描磁带设备...</p><div class="progress"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div></div>';
            
            try {
                const response = await fetch('/api/system/tape/scan');
                const result = await response.json();
                
                if (result.success && result.devices && result.devices.length > 0) {
                    let html = '<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>检测到 ' + result.devices.length + ' 个磁带设备</div>';
                    html += '<div class="list-group mt-3">';
                    result.devices.forEach(device => {
                        html += '<div class="list-group-item">';
                        html += '<div class="d-flex w-100 justify-content-between align-items-start mb-2"><h6 class="mb-0"><i class="bi bi-server me-1"></i>' + (device.vendor || 'Unknown') + ' ' + (device.model || 'Unknown') + '</h6>';
                        if (device.is_ibm_lto && device.lto_generation) {
                            html += '<span class="badge bg-info">LTO-' + device.lto_generation + '</span>';
                        }
                        html += '</div>';
                        html += '<div class="row g-2 mt-2">';
                        html += '<div class="col-md-6"><small class="text-muted"><i class="bi bi-geo-alt me-1"></i>路径:</small><br><code>' + (device.path || '') + '</code></div>';
                        if (device.serial && device.serial !== 'Unknown') {
                            html += '<div class="col-md-6"><small class="text-muted"><i class="bi bi-upc-scan me-1"></i>序列号:</small><br><strong>' + device.serial + '</strong></div>';
                        }
                        html += '</div>';
                        if (device.native_capacity) {
                            const tb = (device.native_capacity / (1024 ** 4)).toFixed(1);
                            html += '<div class="mt-2"><small class="text-muted"><i class="bi bi-hdd me-1"></i>原生容量: <strong>' + tb + ' TB</strong></small></div>';
                        }
                        if (device.scsi_bus || device.scsi_target_id !== undefined) {
                            html += '<div class="mt-1"><small class="text-muted"><i class="bi bi-diagram-3 me-1"></i>SCSI: ';
                            if (device.scsi_bus !== 'Unknown') html += 'Bus ' + device.scsi_bus;
                            if (device.scsi_target_id !== 'Unknown') html += ', Target ' + device.scsi_target_id;
                            if (device.scsi_lun !== 'Unknown') html += ', LUN ' + device.scsi_lun;
                            html += '</small></div>';
                        }
                        if (device.is_ibm_lto) {
                            html += '<div class="mt-2">';
                            html += '<span class="badge bg-success me-1">IBM LTO</span>';
                            if (device.supports_worm) html += '<span class="badge bg-primary me-1">WORM</span>';
                            if (device.supports_encryption) html += '<span class="badge bg-secondary me-1">加密</span>';
                            html += '</div>';
                        }
                        html += '<div class="mt-2">';
                        if (device.status === 'online') {
                            html += '<span class="badge bg-success"><i class="bi bi-circle-fill"></i> 在线</span>';
                        } else {
                            html += '<span class="badge bg-danger"><i class="bi bi-circle"></i> 离线</span>';
                        }
                        html += '</div>';
                        html += '</div>';
                    });
                    html += '</div>';
                    modalBody.innerHTML = html;
                } else {
                    modalBody.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle me-2"></i>未检测到磁带设备</div>';
                }
            } catch (error) {
                modalBody.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle me-2"></i>扫描失败: ' + error.message + '</div>';
            }
        });
    }
    
    // 初始化月份下拉框为当前月并添加change监听
    const tapeMonthSelect = document.getElementById('tapeMonth');
    if (tapeMonthSelect) {
        const now = new Date();
        const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
        tapeMonthSelect.value = currentMonth;
        
        // 月份选择改变时自动刷新标签（但不刷新序列号，因为序列号可能是从扫描结果中生成的UUID）
        tapeMonthSelect.addEventListener('change', function() {
            // 如果标签不是只读（不是从磁带读取的），才自动刷新标签
            const tapeLabelInput = document.getElementById('tapeLabel');
            if (!tapeLabelInput.readOnly && tapeLabelInput.value) {
                tapeLabelInput.value = generateTapeLabel();
            }
            // 注意：不自动刷新序列号，因为序列号可能是从扫描结果中生成的UUID
        });
    }
    
    // 生成磁带标签
    const generateLabelBtn = document.getElementById('generateLabelBtn');
    if (generateLabelBtn) {
        generateLabelBtn.addEventListener('click', function() {
            const tapeLabelInput = document.getElementById('tapeLabel');
            // 只有标签不是只读时才允许生成
            if (!tapeLabelInput.readOnly) {
                tapeLabelInput.value = generateTapeLabel();
            }
        });
    }
    
    // 从磁带机扫描信息（包含读取磁带标签）
    const scanForAddTapeBtn = document.getElementById('scanForAddTapeBtn');
    if (scanForAddTapeBtn) {
        scanForAddTapeBtn.addEventListener('click', async function() {
            const btn = this;
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise spinner me-1"></i>扫描中...';
            
            const scanResultModal = new bootstrap.Modal(document.getElementById('scanResultModal'));
            const scanResultBody = document.getElementById('scanResultBody');
            const applyScanResultBtn = document.getElementById('applyScanResultBtn');
            
            // 重置状态
            window.lastScanResult = null;
            window.lastTapeLabel = null;
            applyScanResultBtn.disabled = true;
            
            // 显示扫描中状态
            scanResultBody.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">扫描中...</span>
                    </div>
                    <p>正在扫描磁带设备并读取磁带标签...</p>
                </div>
            `;
            scanResultModal.show();
            
            try {
                // 并行执行设备扫描和读取磁带标签
                const [scanResponse, labelResponse] = await Promise.allSettled([
                    fetch('/api/system/tape/scan'),
                    fetch('/api/tape/read-label')
                ]);
                
                let device = null;
                let labelResult = null;
                
                // 处理设备扫描结果
                if (scanResponse.status === 'fulfilled') {
                    const scanResult = await scanResponse.value.json();
                    if (scanResult.success && scanResult.devices && scanResult.devices.length > 0) {
                        device = scanResult.devices[0];
                        window.lastScanResult = device;
                    }
                }
                
                // 处理磁带标签读取结果
                if (labelResponse.status === 'fulfilled') {
                    labelResult = await labelResponse.value.json();
                    if (labelResult.success && labelResult.metadata) {
                        window.lastTapeLabel = labelResult.metadata;
                    }
                }
                
                // 生成扫描结果HTML
                let html = '';
                
                // 设备信息部分
                if (device) {
                    // 设备信息标题（放在信息上面）
                    html += '<div class="alert alert-info mb-2"><i class="bi bi-info-circle me-2"></i><strong>设备信息</strong></div>';
                    
                    // 关键信息显示在标题下方
                    if (device.vendor) {
                        html += `<div class="mb-2"><strong>厂商:</strong> ${device.vendor}</div>`;
                    }
                    if (device.model) {
                        html += `<div class="mb-2"><strong>型号:</strong> ${device.model}</div>`;
                    }
                    if (device.product) {
                        html += `<div class="mb-2"><strong>产品:</strong> ${device.product}</div>`;
                    }
                    
                    // 详细信息的表格
                    html += '<div class="table-responsive mb-3"><table class="table table-sm table-bordered">';
                    html += '<tbody>';
                    
                    if (device.serial && device.serial !== 'Unknown') html += `<tr><th style="width: 30%;">设备序列号:</th><td>${device.serial}</td></tr>`;
                    
                    if (device.is_ibm_lto && device.lto_generation) {
                        html += `<tr><th>设备类型:</th><td><span class="badge bg-info">IBM LTO-${device.lto_generation}</span></td></tr>`;
                        const capacityMap = {9: '18TB', 8: '12TB', 7: '6TB', 6: '2.5TB', 5: '1.5TB'};
                        if (capacityMap[device.lto_generation]) {
                            html += `<tr><th>建议容量:</th><td>${capacityMap[device.lto_generation]}</td></tr>`;
                        }
                    } else if (device.model && device.model.includes('ULT3580')) {
                        html += `<tr><th>设备信息:</th><td><span class="badge bg-warning">IBM磁带设备（待识别代数）</span></td></tr>`;
                    }
                    
                    if (device.native_capacity) {
                        const tb = (device.native_capacity / (1024 ** 4)).toFixed(1);
                        html += `<tr><th>原生容量:</th><td>${tb} TB</td></tr>`;
                    }
                    
                    if (device.path) html += `<tr><th>设备路径:</th><td><code class="bg-dark text-light px-2 py-1 rounded" style="font-size: 0.875em;">${device.path}</code></td></tr>`;
                    
                    html += '</tbody></table></div>';
                } else {
                    html += '<div class="alert alert-warning mb-3"><i class="bi bi-exclamation-triangle me-2"></i>未检测到磁带设备</div>';
                }
                
                // 磁带标签信息部分
                if (labelResult && labelResult.success && labelResult.metadata) {
                    const metadata = labelResult.metadata;
                    
                    // 从后端API获取UUID序列号（使用Python uuid.uuid4()）
                    // 使用HEX格式：全大写无连字符，32字符，如 59EAACB9564949FD93A232AF4C0F804F
                    let generatedSerial = null;
                    try {
                        const uuidResponse = await fetch('/api/tape/generate-uuid');
                        if (!uuidResponse.ok) {
                            throw new Error(`HTTP ${uuidResponse.status}: ${uuidResponse.statusText}`);
                        }
                        const uuidResult = await uuidResponse.json();
                        console.log('UUID API响应:', uuidResult);
                        
                        // 优先使用serial_number字段（HEX格式：全大写无连字符）
                        if (uuidResult && uuidResult.success && uuidResult.serial_number) {
                            generatedSerial = uuidResult.serial_number;
                        } else if (uuidResult && uuidResult.uuid && uuidResult.uuid.hex_upper) {
                            // 降级：如果serial_number不存在，使用hex_upper
                            generatedSerial = uuidResult.uuid.hex_upper;
                        } else {
                            throw new Error('UUID API返回格式不正确: ' + JSON.stringify(uuidResult));
                        }
                    } catch (e) {
                        console.error('从后端获取UUID失败，使用前端生成:', e);
                        // 降级方案：使用前端生成的UUID
                        generatedSerial = generateTapeSerial();
                    }
                    
                    // 存储生成的序列号供后续使用
                    window.generatedTapeSerial = generatedSerial;
                    
                    html += '<div class="alert alert-success mb-3"><i class="bi bi-check-circle me-2"></i>成功读取磁带信息！</div>';
                    
                    // 磁带信息标题（放在磁带标签上面）
                    html += '<div class="alert alert-info mb-2"><i class="bi bi-info-circle me-2"></i><strong>磁带信息</strong></div>';
                    
                    // 关键信息显示在标题下方（与磁带标签和序列号对齐）
                    if (metadata.tape_id) {
                        html += `<div class="mb-2"><strong>磁带标签:</strong> ${metadata.tape_id}</div>`;
                    }
                    if (generatedSerial) {
                        html += `<div class="mb-2"><strong>序列号:</strong> ${generatedSerial}</div>`;
                    }
                    if (metadata.created_date) {
                        const createdDate = new Date(metadata.created_date);
                        html += `<div class="mb-2"><strong>创建日期:</strong> ${createdDate.getFullYear()}年${createdDate.getMonth() + 1}月</div>`;
                    }
                    
                    // 详细信息的表格
                    html += '<div class="table-responsive mb-3"><table class="table table-sm table-bordered">';
                    html += '<tbody>';
                    
                    if (metadata.serial_number) {
                        html += `<tr><th style="width: 30%;">标签序列号:</th><td>${metadata.serial_number}</td></tr>`;
                    }
                    if (metadata.expiry_date) {
                        const expiryDate = new Date(metadata.expiry_date);
                        const now = new Date();
                        const expiryYear = expiryDate.getFullYear();
                        const expiryMonth = expiryDate.getMonth();
                        const currentYear = now.getFullYear();
                        const currentMonth = now.getMonth();
                        const isExpired = (currentYear > expiryYear) || (currentYear === expiryYear && currentMonth >= expiryMonth);
                        
                        html += `<tr><th>过期日期:</th><td>${expiryYear}年${expiryMonth + 1}月`;
                        if (isExpired) {
                            html += ' <span class="badge bg-danger">已过期</span>';
                        } else {
                            const yearDiff = expiryYear - currentYear;
                            const monthDiff = expiryMonth - currentMonth;
                            html += ` <span class="badge bg-success">有效</span>`;
                        }
                        html += `</td></tr>`;
                    }
                    
                    html += '</tbody></table></div>';
                    
                    // 检查是否在数据库中存在
                    if (metadata.tape_id) {
                        try {
                            const checkResponse = await fetch(`/api/tape/check/${metadata.tape_id}`);
                            const checkResult = await checkResponse.json();
                            
                            if (checkResult.exists) {
                                html += '<div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>数据库中已存在此磁带记录</div>';
                            }
                        } catch (e) {
                            console.error('检查磁带存在性失败:', e);
                        }
                    }
                    
                    // 启用"应用信息"按钮（只有获得磁带标签后才启用）
                    applyScanResultBtn.disabled = false;
                } else {
                    html += '<div class="alert alert-warning mb-2"><i class="bi bi-exclamation-triangle me-2"></i>未检测到磁带标签或磁带为空</div>';
                    // 若存在设备信息，则仍允许应用以填充其他信息（类型/容量/路径等）
                    if (device) {
                        html += '<div class="alert alert-info mb-3"><i class="bi bi-info-circle me-2"></i>已获取设备信息，可应用以自动填写类型、容量和设备路径</div>';
                        applyScanResultBtn.disabled = false;
                    } else {
                        applyScanResultBtn.disabled = true;
                    }
                }
                
                scanResultBody.innerHTML = html;
                
            } catch (error) {
                scanResultBody.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle me-2"></i>扫描失败: ${error.message}</div>`;
                applyScanResultBtn.disabled = true;
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        });
    }
    
    // 应用扫描结果到表单
    const applyScanResultBtn = document.getElementById('applyScanResultBtn');
    if (applyScanResultBtn) {
        applyScanResultBtn.addEventListener('click', function() {
            const device = window.lastScanResult;
            const tapeLabel = window.lastTapeLabel;
            const modal = document.getElementById('addTapeModal');
            
            // 优先使用从磁带标签读取的信息
            if (tapeLabel && tapeLabel.tape_id) {
                // 填充磁带标签（从磁带读取，不可编辑）
                const tapeLabelInput = document.getElementById('tapeLabel');
                tapeLabelInput.value = tapeLabel.tape_id;
                tapeLabelInput.readOnly = true;
                tapeLabelInput.disabled = false;  // 保持可查看但不可编辑
                
                // 禁用月份选择和生成标签按钮（标签来自磁带，不可修改）
                document.getElementById('tapeMonth').disabled = true;
                document.getElementById('generateLabelBtn').disabled = true;
                
                // 标记标签来自磁带
                modal.dataset.labelFromTape = 'true';
                
                // 优先使用生成的UUID序列号
                if (window.generatedTapeSerial) {
                    document.getElementById('tapeSerial').value = window.generatedTapeSerial;
                }
                
                // 保存生成的序列号，供后续使用
                const savedGeneratedSerial = window.generatedTapeSerial;
                
                // 检查数据库中是否存在此磁带
                if (tapeLabel.tape_id) {
                    fetch(`/api/tape/check/${tapeLabel.tape_id}`)
                        .then(response => response.json())
                        .then(checkResult => {
                            if (checkResult.exists) {
                                // 数据库中存在：更新模式
                                modal.dataset.editMode = 'true';
                                modal.dataset.editTapeId = tapeLabel.tape_id;
                                document.getElementById('addTapeModalTitle').textContent = '更新磁带信息';
                                document.getElementById('confirmAddTapeBtn').textContent = '更新';
                                
                                // 从数据库获取完整信息
                                return fetch(`/api/tape/show/${tapeLabel.tape_id}`)
                                    .then(response => response.json())
                                    .then(detailResult => {
                                        if (detailResult.tape) {
                                            const tape = detailResult.tape;
                                            // 填充其他字段（其他字段可编辑）
                                            if (tape.media_type && tape.generation) {
                                                document.getElementById('tapeType').value = `${tape.media_type}-${tape.generation}`;
                                            }
                                            if (tape.capacity_bytes) {
                                                const tb = Math.round((tape.capacity_bytes / (1024 ** 4)) * 10) / 10;
                                                document.getElementById('tapeCapacity').value = `${tb}TB`;
                                            }
                                            if (tape.location) {
                                                document.getElementById('tapeLocation').value = tape.location;
                                            }
                                            if (tape.notes) {
                                                document.getElementById('tapeRemark').value = tape.notes;
                                            }
                                            // 优先使用生成的UUID序列号
                                            if (savedGeneratedSerial) {
                                                document.getElementById('tapeSerial').value = savedGeneratedSerial;
                                            } else if (tape.serial_number) {
                                                document.getElementById('tapeSerial').value = tape.serial_number;
                                            } else {
                                                document.getElementById('tapeSerial').value = generateTapeSerial();
                                            }
                                        }
                                        // 在异步操作完成后清空缓存
                                        cleanupScanCache();
                                    })
                                    .catch(e => {
                                        console.error('获取磁带详情失败:', e);
                                        cleanupScanCache();
                                    });
                            } else {
                                // 数据库不存在：创建模式（但标签来自磁带，不可编辑）
                                modal.dataset.editMode = 'false';
                                delete modal.dataset.editTapeId;
                                document.getElementById('addTapeModalTitle').textContent = '添加新磁带（标签来自磁带）';
                                document.getElementById('confirmAddTapeBtn').textContent = '保存';
                                
                                // 使用扫描到的信息填充其他字段
                                fillFormFromScan(device, tapeLabel);
                                cleanupScanCache();
                            }
                        })
                        .catch(e => {
                            console.error('检查磁带存在性失败:', e);
                            // 出错时也设置为创建模式，但标签不可编辑
                            modal.dataset.editMode = 'false';
                            delete modal.dataset.editTapeId;
                            document.getElementById('addTapeModalTitle').textContent = '添加新磁带（标签来自磁带）';
                            document.getElementById('confirmAddTapeBtn').textContent = '保存';
                            fillFormFromScan(device, tapeLabel);
                            cleanupScanCache();
                        });
                } else {
                    fillFormFromScan(device, tapeLabel);
                    cleanupScanCache();
                }
            } else if (device) {
                // 没有磁带标签，但有设备信息，使用设备信息填充（正常添加模式）
                modal.dataset.editMode = 'false';
                modal.dataset.labelFromTape = 'false';
                delete modal.dataset.editTapeId;
                document.getElementById('tapeLabel').readOnly = false;
                document.getElementById('tapeLabel').disabled = false;
                document.getElementById('tapeMonth').disabled = false;
                document.getElementById('generateLabelBtn').disabled = false;
                document.getElementById('addTapeModalTitle').textContent = '添加新磁带';
                document.getElementById('confirmAddTapeBtn').textContent = '保存';
                fillFormFromScan(device, null);
                cleanupScanCache();
            }
            
            // 清理扫描结果缓存的辅助函数
            function cleanupScanCache() {
                delete window.lastScanResult;
                delete window.lastTapeLabel;
                delete window.generatedTapeSerial;
            }
        });
    }
    
    // 从扫描结果填充表单的辅助函数
    function fillFormFromScan(device, tapeLabel) {
        // 如果有LTO信息，自动选择类型和容量
        if (device && device.is_ibm_lto && device.lto_generation) {
            const ltoGen = device.lto_generation;
            const tapeTypeValue = `LTO-${ltoGen}`;
            const tapeTypeSelect = document.getElementById('tapeType');
            if (tapeTypeSelect) {
                tapeTypeSelect.value = tapeTypeValue;
            }
            
            // 根据LTO代数设置容量
            const capacityMap = {9: '18TB', 8: '12TB', 7: '6TB', 6: '2.5TB', 5: '1.5TB'};
            if (capacityMap[ltoGen]) {
                const tapeCapacitySelect = document.getElementById('tapeCapacity');
                if (tapeCapacitySelect) {
                    tapeCapacitySelect.value = capacityMap[ltoGen];
                }
            }
        }
        
        // 如果没有磁带标签，生成新的标签
        if (!tapeLabel || !tapeLabel.tape_id) {
            document.getElementById('tapeLabel').value = generateTapeLabel();
        }
        
        // 序列号：优先使用生成的UUID（如果已设置），其次使用标签中的，最后生成新的
        // 注意：如果序列号字段已经有值（可能是从扫描结果中应用的UUID），则不再覆盖
        const currentSerial = document.getElementById('tapeSerial').value;
        if (!currentSerial) {
            // 只有当序列号字段为空时，才进行填充
            if (window.generatedTapeSerial) {
                document.getElementById('tapeSerial').value = window.generatedTapeSerial;
            } else if (tapeLabel && tapeLabel.serial_number) {
                document.getElementById('tapeSerial').value = tapeLabel.serial_number;
            } else {
                document.getElementById('tapeSerial').value = generateTapeSerial();
            }
        } else if (window.generatedTapeSerial && currentSerial !== window.generatedTapeSerial) {
            // 如果字段有值但不同于生成的UUID，优先使用生成的UUID
            document.getElementById('tapeSerial').value = window.generatedTapeSerial;
        }
    }
    
    
    // 确认添加磁带
    const confirmAddTapeBtn = document.getElementById('confirmAddTapeBtn');
    if (confirmAddTapeBtn) {
        confirmAddTapeBtn.addEventListener('click', async function() {
            const btn = this;
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            
            try {
                // 获取表单数据
                const tapeLabel = document.getElementById('tapeLabel').value;
                const tapeSerial = document.getElementById('tapeSerial').value;
                const tapeType = document.getElementById('tapeType').value;
                const tapeCapacity = document.getElementById('tapeCapacity').value;
                const tapeLocation = document.getElementById('tapeLocation').value;
                const tapeRemark = document.getElementById('tapeRemark').value;
                
                // 验证必填字段
                if (!tapeLabel || !tapeSerial || !tapeType || !tapeCapacity) {
                    alert('❌ 请填写所有必填字段');
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                    return;
                }
                
                // 从类型中提取代数 (LTO-9 -> 9)
                const generation = parseInt(tapeType.replace('LTO-', ''));
                
                // 检查是否为编辑模式
                const modal = document.getElementById('addTapeModal');
                const isEditMode = modal.dataset.editMode === 'true';
                const labelFromTape = modal.dataset.labelFromTape === 'true';
                
                // 如果标签来自磁带且数据库中不存在，也需要检查是否存在
                if (labelFromTape && !isEditMode) {
                    // 标签来自磁带，检查数据库中是否存在该标签
                    try {
                        const checkResponse = await fetch(`/api/tape/check/${tapeLabel}`);
                        const checkResult = await checkResponse.json();
                        
                        if (checkResult.exists) {
                            // 数据库中存在，使用更新模式
                            btn.innerHTML = '<i class="bi bi-arrow-clockwise spinner me-2"></i>更新中...';
                            const tapeId = tapeLabel;  // tape_id就是标签
                            
                            // 从容量中提取并转换为GB (18TB -> 18432GB)
                            const capacityValue = parseInt(tapeCapacity.replace('TB', ''));
                            const capacityGB = capacityValue * 1024;  // TB转GB
                            
                            // 构建请求数据
                            const requestData = {
                                serial_number: tapeSerial,
                                media_type: 'LTO',
                                generation: generation,
                                capacity_gb: capacityGB,
                                location: tapeLocation,
                                notes: tapeRemark
                            };
                            
                            // 发送更新请求
                            const response = await fetch(`/api/tape/update/${tapeId}`, {
                                method: 'PUT',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify(requestData)
                            });
                            
                            const result = await response.json();
                            
                            if (result.success) {
                                alert('✅ ' + result.message);
                                // 关闭模态框
                                const modalInstance = bootstrap.Modal.getInstance(modal);
                                modalInstance.hide();
                                // 重置编辑模式标记
                                modal.dataset.editMode = 'false';
                                modal.dataset.labelFromTape = 'false';
                                delete modal.dataset.editTapeId;
                                // 重置表单状态
                                resetTapeForm();
                                // 刷新列表和统计
                                loadTapeList().then(() => {
                                    loadTapeStatistics();
                                    loadTapeHistory();  // 刷新操作历史
                                });
                            } else {
                                alert('❌ 更新失败：' + result.message);
                            }
                            btn.disabled = false;
                            btn.innerHTML = originalHtml;
                            return;
                        }
                    } catch (e) {
                        console.error('检查磁带存在性失败:', e);
                        // 继续执行创建流程
                    }
                }
                
                if (isEditMode) {
                    // 编辑模式：使用PUT请求更新
                    btn.innerHTML = '<i class="bi bi-arrow-clockwise spinner me-2"></i>更新中...';
                    const tapeId = modal.dataset.editTapeId;
                    
                    // 从容量中提取并转换为GB (18TB -> 18432GB)
                    const capacityValue = parseInt(tapeCapacity.replace('TB', ''));
                    const capacityGB = capacityValue * 1024;  // TB转GB
                    
                    // 构建请求数据
                    const requestData = {
                        serial_number: tapeSerial,
                        media_type: 'LTO',
                        generation: generation,
                        capacity_gb: capacityGB,
                        location: tapeLocation,
                        notes: tapeRemark
                    };
                    
                    // 发送更新请求
                    const response = await fetch(`/api/tape/update/${tapeId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(requestData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('✅ ' + result.message);
                        // 关闭模态框
                        const modalInstance = bootstrap.Modal.getInstance(modal);
                        modalInstance.hide();
                        // 重置编辑模式标记
                        modal.dataset.editMode = 'false';
                        delete modal.dataset.editTapeId;
                        // 重置表单状态
                        resetTapeForm();
                        // 刷新列表和统计
                        loadTapeList().then(() => {
                            loadTapeStatistics();
                            loadTapeHistory();  // 刷新操作历史
                        });
                    } else {
                        alert('❌ 更新失败：' + result.message);
                    }
                } else {
                    // 添加模式：使用POST请求创建
                    btn.innerHTML = '<i class="bi bi-arrow-clockwise spinner me-2"></i>添加中...';
                    
                    // 从容量中提取并转换为GB (18TB -> 18432GB)
                    const capacityValue = parseInt(tapeCapacity.replace('TB', ''));
                    const capacityGB = capacityValue * 1024;  // TB转GB
                    
                    // 获取选中的月份和年份
                    const selectedMonth = document.getElementById('tapeMonth').value;
                    const now = new Date();
                    const year = now.getFullYear();  // 当前年份
                    
                    // 构建请求数据
                    const requestData = {
                        tape_id: tapeLabel,  // 使用label作为tape_id
                        label: tapeLabel,
                        serial_number: tapeSerial,
                        media_type: 'LTO',
                        generation: generation,
                        capacity_gb: capacityGB,
                        location: tapeLocation,
                        notes: tapeRemark,
                        retention_months: 6,
                        create_year: year,   // 创建年份
                        create_month: parseInt(selectedMonth)  // 创建月份
                    };
                    
                    // 发送创建请求
                    const response = await fetch('/api/tape/create', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(requestData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('✅ ' + result.message);
                        // 关闭模态框
                        const modalInstance = bootstrap.Modal.getInstance(modal);
                        modalInstance.hide();
                        // 重置表单状态
                        resetTapeForm();
                        // 刷新列表和统计
                        loadTapeList().then(() => {
                            loadTapeStatistics();
                            loadTapeHistory();  // 刷新操作历史
                        });
                    } else {
                        alert('❌ 添加失败：' + result.message);
                    }
                }
            } catch (error) {
                alert('❌ 添加失败：' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        });
    }
});

// 显示磁带详情
async function showTapeDetails(tapeId) {
    const tape = allTapesData.find(t => t.tape_id === tapeId);
    if (!tape) {
        alert('找不到磁带信息');
        return;
    }
    
    // 容量格式化
    const formatBytes = (bytes) => {
        if (bytes >= 1024 ** 4) return (bytes / (1024 ** 4)).toFixed(2) + ' TB';
        if (bytes >= 1024 ** 3) return (bytes / (1024 ** 3)).toFixed(2) + ' GB';
        if (bytes >= 1024 ** 2) return (bytes / (1024 ** 2)).toFixed(2) + ' MB';
        return bytes + ' B';
    };
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="fw-bold">基本信息</h6>
                <table class="table table-sm table-borderless">
                    <tr><td class="text-muted" style="width: 40%;">磁带ID:</td><td>${tape.tape_id}</td></tr>
                    <tr><td class="text-muted">标签:</td><td>${tape.label}</td></tr>
                    <tr><td class="text-muted">序列号:</td><td>${tape.serial_number || 'N/A'}</td></tr>
                    <tr><td class="text-muted">类型:</td><td>LTO-${tape.generation}</td></tr>
                    <tr><td class="text-muted">状态:</td><td><span class="badge bg-${tape.status === 'available' ? 'success' : tape.status === 'in_use' ? 'primary' : 'danger'}">${tape.status}</span></td></tr>
                    <tr><td class="text-muted">位置:</td><td>${tape.location || 'N/A'}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="fw-bold">容量信息</h6>
                <table class="table table-sm table-borderless">
                    <tr><td class="text-muted" style="width: 40%;">总容量:</td><td>${formatBytes(tape.capacity_bytes)}</td></tr>
                    <tr><td class="text-muted">已使用:</td><td>${formatBytes(tape.used_bytes)}</td></tr>
                    <tr><td class="text-muted">可用:</td><td>${formatBytes(tape.capacity_bytes - tape.used_bytes)}</td></tr>
                    <tr><td class="text-muted">使用率:</td><td>${tape.usage_percent.toFixed(2)}%</td></tr>
                    <tr><td class="text-muted">保留月数:</td><td>${tape.retention_months}</td></tr>
                    <tr><td class="text-muted">健康分数:</td><td>${tape.health_score}/100</td></tr>
                </table>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-6">
                <h6 class="fw-bold">使用统计</h6>
                <table class="table table-sm table-borderless">
                    <tr><td class="text-muted" style="width: 40%;">写入次数:</td><td>${tape.write_count}</td></tr>
                    <tr><td class="text-muted">读取次数:</td><td>${tape.read_count}</td></tr>
                    <tr><td class="text-muted">加载次数:</td><td>${tape.load_count}</td></tr>
                    <tr><td class="text-muted">备份集:</td><td>${tape.backup_set_count}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="fw-bold">时间信息</h6>
                <table class="table table-sm table-borderless">
                    <tr><td class="text-muted" style="width: 40%;">首次使用:</td><td>${tape.first_use_date ? new Date(tape.first_use_date).toLocaleString() : 'N/A'}</td></tr>
                    <tr><td class="text-muted">最后擦除:</td><td>${tape.last_erase_date ? new Date(tape.last_erase_date).toLocaleString() : 'N/A'}</td></tr>
                    <tr><td class="text-muted">过期时间:</td><td>${tape.expiry_date ? new Date(tape.expiry_date).toLocaleString() : 'N/A'}</td></tr>
                </table>
            </div>
        </div>
        ${tape.notes ? `<div class="row mt-3"><div class="col-12"><h6 class="fw-bold">备注</h6><p class="text-muted">${tape.notes}</p></div></div>` : ''}
    `;
    
    // 显示详情模态框
    const modal = new bootstrap.Modal(document.getElementById('tapeDetailsModal'));
    document.getElementById('tapeDetailsModalBody').innerHTML = html;
    modal.show();
}

// 编辑磁带
function editTape(tapeId) {
    const tape = allTapesData.find(t => t.tape_id === tapeId);
    if (!tape) {
        alert('找不到磁带信息');
        return;
    }
    
    // 设置模态框标题
    document.getElementById('addTapeModalTitle').textContent = '编辑磁带';
    
    // 禁用磁带ID和标签编辑（主键不允许修改）
    document.getElementById('tapeLabel').readOnly = true;
    
    // 隐藏扫描和读取标签按钮（编辑模式不需要）
    document.getElementById('scanForAddTapeBtn').style.display = 'none';
    document.getElementById('readTapeLabelBtn').style.display = 'none';
    
    // 填充表单数据
    document.getElementById('tapeLabel').value = tape.tape_id;
    document.getElementById('tapeSerial').value = tape.serial_number || '';
    document.getElementById('tapeType').value = `LTO-${tape.generation}`;
    
    // 容量从GB转TB显示
    const capacityTB = Math.round(tape.capacity_bytes / (1024 ** 4));
    document.getElementById('tapeCapacity').value = `${capacityTB}TB`;
    
    document.getElementById('tapeLocation').value = tape.location || '';
    document.getElementById('tapeRemark').value = tape.notes || '';
    
    // 月份下拉条不适用编辑模式
    document.getElementById('tapeMonth').disabled = true;
    document.getElementById('generateLabelBtn').style.display = 'none';
    
    // 设置编辑模式标记
    document.getElementById('addTapeModal').dataset.editMode = 'true';
    document.getElementById('addTapeModal').dataset.editTapeId = tapeId;
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('addTapeModal'));
    modal.show();
}
</script>

<!-- 磁带详情模态框 -->
<div class="modal fade" id="tapeDetailsModal" tabindex="-1" data-bs-backdrop="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">磁带详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="tapeDetailsModalBody">
                <!-- 详情内容将动态加载 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}