# 文件移动流程说明

## 概述

本文档详细说明备份系统中文件从压缩完成到移动到磁带机的完整流程。

## 完整流程

### 阶段1：压缩完成 → temp目录

**位置**：`backup/compressor.py` - `compress_file_group()`

1. 文件组压缩完成
2. 压缩文件保存到：`temp/compress/temp/{backup_set.set_id}/backup_xxx.tar.gz`
3. 压缩函数返回文件路径

**日志示例**：
```
[压缩] 压缩任务已提交到线程池，等待完成...
[PGZip] PGZip压缩完成: 1637 个文件成功, 压缩包大小: 12.37 GB
压缩函数返回的文件路径: E:\app\TAF\temp\compress\temp\2025-11_000001\backup_xxx.tar.gz
```

### 阶段2：temp目录 → final目录（后台任务，不阻塞）

**位置**：`backup/compressor.py` - `move_file_to_final_background()`

1. 创建后台异步任务 `move_file_to_final_background()`
2. 使用 `asyncio.create_task()` 启动，不等待完成
3. 文件从 `temp/compress/temp/` 移动到 `temp/compress/final/`
4. 移动完成后记录日志和更新数据库状态

**关键特性**：
- **非阻塞**：压缩循环立即继续，不等待文件移动完成
- **后台执行**：文件移动在独立的异步任务中执行
- **错误处理**：移动失败记录错误，但不影响压缩循环

**日志示例**：
```
[文件移动] 已启动后台任务移动文件，压缩循环继续执行，不等待移动完成
[文件移动] 后台任务：开始移动文件到正式目录: backup_xxx.tar.gz
[文件移动] 源路径: E:\app\TAF\temp\compress\temp\2025-11_000001\backup_xxx.tar.gz
[文件移动] 目标路径: temp\compress\final\2025-11_000001\backup_xxx.tar.gz
[文件移动] 后台任务：文件已移动到正式目录: temp\compress\final\2025-11_000001\backup_xxx.tar.gz
[关键阶段] 文件已移动到正式目录] backup_xxx.tar.gz，大小: 12.37 GB
```

### 阶段3：等待文件移动到final目录 → 加入移动队列（后台任务）

**位置**：`backup/backup_engine.py` - `add_to_move_queue_background()`

1. 创建后台异步任务 `add_to_move_queue_background()`
2. **等待文件出现在final目录**（最多等待30秒）
3. 检查文件是否存在：`os.path.exists(file_path)`
4. 如果文件存在，调用 `tape_file_mover.add_file()` 加入队列
5. 记录关键阶段日志

**关键特性**：
- **等待机制**：最多等待30秒，每秒检查一次文件是否存在
- **超时处理**：如果30秒后文件仍未出现，记录警告并返回
- **非阻塞**：压缩循环不等待此任务完成

**日志示例**：
```
[文件移动] 已启动后台任务等待文件移动完成并加入队列，压缩循环继续执行
[文件移动] 文件已移动到final目录: E:\app\TAF\temp\compress\final\2025-11_000001\backup_xxx.tar.gz
[关键阶段] 写入磁带中...] 文件组 1
[文件移动] 文件已成功加入移动队列: E:\app\TAF\temp\compress\final\2025-11_000001\backup_xxx.tar.gz
[关键阶段] 加入移动队列] 文件组 1，等待移动到磁带机
```

### 阶段4：移动队列处理 → 移动到磁带机

**位置**：`backup/tape_file_mover.py` - `_process_move_task()`

1. `TapeFileMover` 工作线程从队列中取出任务
2. 调用 `TapeHandler.write_to_tape_drive()` 复制文件到磁带机
3. 文件复制到：`O:\{backup_set.set_id}\backup_xxx.tar.gz`
4. 移动完成后调用回调函数
5. 删除final目录中的源文件

**关键特性**：
- **顺序执行**：磁带机操作必须顺序执行，队列确保这一点
- **单线程处理**：使用独立的工作线程顺序处理队列中的文件
- **错误处理**：移动失败记录错误，但不影响后续文件

**日志示例**：
```
文件已加入移动队列: backup_xxx.tar.gz (队列大小: 1)
开始移动文件到磁带机: backup_xxx.tar.gz (大小: 13293513336 字节)
准备复制文件到磁带机: E:\app\TAF\temp\compress\final\2025-11_000001\backup_xxx.tar.gz
正在复制文件到磁带机: E:\app\TAF\temp\compress\final\2025-11_000001\backup_xxx.tar.gz -> O:\2025-11_000001\backup_xxx.tar.gz
文件移动成功: backup_xxx.tar.gz -> 2025-11_000001\backup_xxx.tar.gz (耗时: 131.51秒)
任务状态更新为: 写入磁带
文件已成功移动到磁带机: 2025-11_000001\backup_xxx.tar.gz
[关键阶段] 文件已移动到磁带机] backup_xxx.tar.gz (文件组 1)
```

## 流程图

```
压缩完成
    ↓
文件在 temp/compress/temp/{set_id}/backup_xxx.tar.gz
    ↓
[后台任务1] 移动文件到 final 目录（不阻塞）
    ├─ temp/compress/temp/ → temp/compress/final/
    └─ 记录日志和更新数据库状态
    ↓
[后台任务2] 等待文件出现在 final 目录（最多30秒）
    ├─ 检查文件是否存在
    └─ 如果存在，加入移动队列
    ↓
文件在 temp/compress/final/{set_id}/backup_xxx.tar.gz
    ↓
[移动队列] TapeFileMover 工作线程处理
    ├─ 从队列中取出任务
    └─ 复制文件到磁带机
    ↓
文件在 O:\{set_id}\backup_xxx.tar.gz
    ↓
删除 final 目录中的源文件
    ↓
移动完成，调用回调函数
```

## 关键设计点

### 1. 并行执行

- **压缩和文件移动并行**：压缩完成后立即启动后台任务移动文件，压缩循环继续处理下一个文件组
- **文件移动和队列加入并行**：文件移动到final目录和加入移动队列都是后台任务，互不阻塞

### 2. 非阻塞设计

- 所有文件移动操作都是异步的，使用 `asyncio.create_task()` 启动
- 压缩循环不会被文件移动操作阻塞
- 可以同时处理多个文件组的压缩和移动

### 3. 错误处理

- 文件移动失败不会影响压缩循环
- 队列加入失败会记录警告，但不会中断流程
- 磁带机移动失败会记录错误，但会继续处理队列中的下一个文件

### 4. 状态跟踪

- 每个阶段都有详细的日志记录
- 关键阶段会更新数据库状态
- 可以通过日志追踪文件的完整移动路径

## 配置说明

### 相关配置项

- `BACKUP_COMPRESS_DIR`: 压缩文件临时目录（默认：`temp/compress`）
- `COMPRESS_DIRECTLY_TO_TAPE`: 是否直接压缩到磁带（默认：`True`）

### 目录结构

```
temp/compress/
├── temp/              # 压缩临时目录
│   └── {set_id}/
│       └── backup_xxx.tar.gz
└── final/             # 压缩完成后的正式目录
    └── {set_id}/
        └── backup_xxx.tar.gz
```

## 性能优化

1. **并行处理**：压缩和文件移动可以同时进行
2. **队列机制**：磁带机操作通过队列顺序执行，避免冲突
3. **异步操作**：所有I/O操作都是异步的，不阻塞主循环
4. **后台任务**：文件移动在后台执行，不影响压缩性能

## 故障排查

### 文件未移动到final目录

**检查点**：
1. 查看日志中是否有 `[文件移动] 后台任务：开始移动文件到正式目录` 的日志
2. 检查是否有 `[文件移动] 后台任务：移动文件到正式目录失败` 的错误
3. 检查文件是否实际存在于temp目录

### 文件未加入移动队列

**检查点**：
1. 查看日志中是否有 `[文件移动] 已启动后台任务等待文件移动完成并加入队列` 的日志
2. 检查是否有 `[文件移动] 等待超时，文件仍未移动到final目录` 的警告
3. 检查文件是否实际存在于final目录

### 文件未移动到磁带机

**检查点**：
1. 查看日志中是否有 `文件已加入移动队列` 的日志
2. 检查是否有 `开始移动文件到磁带机` 的日志
3. 检查是否有 `文件移动成功` 或 `文件移动失败` 的日志
4. 检查磁带机是否正常挂载（盘符O:\是否存在）

## 相关文件

- `backup/compressor.py`: 压缩和文件移动逻辑
- `backup/backup_engine.py`: 备份引擎，管理文件移动队列
- `backup/tape_file_mover.py`: 磁带文件移动队列管理器
- `backup/tape_handler.py`: 磁带操作处理

