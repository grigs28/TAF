# 企业级磁带备份系统 - 配置管理说明
Enterprise Tape Backup System - Configuration Management Guide

## 🔧 配置管理工具

系统提供了专用的配置管理工具 `config_manager.py`，用于方便地管理系统配置。

### 📋 使用方法

```bash
python config_manager.py <command> [arguments]
```

### 🎯 可用命令

#### 1. 显示配置状态
```bash
python config_manager.py show
# 或
python config_manager.py status
```

显示所有配置项的当前状态，包括：
- 基础配置（应用名称、版本等）
- Web服务配置（地址、端口等）
- 数据库配置（主机、端口、用户等）
- 磁带配置（驱动器、块大小等）
- 钉钉通知配置（API地址、密钥等）
- 备份配置（保留策略、压缩级别等）

#### 2. 交互式配置设置
```bash
python config_manager.py setup
```

启动交互式配置向导，引导用户设置关键配置项：
- Web服务地址和端口
- 数据库连接参数
- 钉钉通知配置
- 磁带驱动器配置

#### 3. 配置验证
```bash
python config_manager.py validate
```

验证当前配置的有效性，检查：
- 必需配置项是否存在
- 端口号是否在有效范围
- 安全密钥是否满足要求
- 文件路径是否存在

#### 4. 获取配置项
```bash
python config_manager.py get <key>
```

获取指定配置项的值：
```bash
python config_manager.py get WEB_PORT
python config_manager.py get DB_HOST
python config_manager.py get SECRET_KEY
```

#### 5. 设置配置项
```bash
python config_manager.py set <key> <value>
```

设置指定配置项的值：
```bash
python config_manager.py set WEB_PORT 8081
python config_manager.py set DEBUG true
python config_manager.py set LOG_LEVEL DEBUG
```

#### 6. 重置配置
```bash
python config_manager.py reset
```

将配置重置为默认值（从 .env.sample 复制）。

### 📁 配置文件

#### .env 文件
这是系统的主要配置文件，包含所有可配置的参数。文件按功能分组：

**应用基础配置**
- `APP_NAME`: 应用名称
- `APP_VERSION`: 应用版本
- `DEBUG`: 调试模式
- `ENVIRONMENT`: 运行环境

**Web服务配置**
- `WEB_HOST`: Web服务监听地址
- `WEB_PORT`: Web服务监听端口
- `WEB_WORKERS`: 工作进程数
- `CORS_ORIGINS`: 跨域允许的源

**数据库配置**
- `DATABASE_URL`: 数据库连接URL
- `DB_HOST`: 数据库主机
- `DB_PORT`: 数据库端口
- `DB_USER`: 数据库用户
- `DB_PASSWORD`: 数据库密码
- `DB_DATABASE`: 数据库名称

**磁带设备配置**
- `TAPE_DRIVE_LETTER`: Windows磁带驱动器盘符
- `TAPE_DEVICE_PATH`: Linux磁带设备路径
- `DEFAULT_BLOCK_SIZE`: 默认块大小
- `MAX_VOLUME_SIZE`: 最大卷大小

**钉钉通知配置**
- `DINGTALK_API_URL`: 钉钉API地址
- `DINGTALK_API_KEY`: 钉钉API密钥
- `DINGTALK_DEFAULT_PHONE`: 默认通知手机号

**备份配置**
- `DEFAULT_RETENTION_MONTHS`: 默认保留月数
- `AUTO_ERASE_EXPIRED`: 自动擦除过期磁带
- `COMPRESSION_LEVEL`: 压缩级别

**日志配置**
- `LOG_LEVEL`: 日志级别
- `LOG_FILE`: 日志文件路径

### 🔒 安全配置建议

1. **SECRET_KEY**
   ```bash
   # 生成强密钥
   python -c "import secrets; print(secrets.token_urlsafe(32))"
   ```

2. **数据库密码**
   - 使用强密码
   - 定期更换
   - 避免在代码中硬编码

3. **钉钉API密钥**
   - 定期轮换
   - 限制权限范围
   - 监控使用情况

### 🌐 网络配置

#### 端口配置
- Web服务默认端口: 8080
- 可修改为其他端口避免冲突
- 生产环境建议使用反向代理

#### 防火墙配置
```bash
# 开放Web服务端口（Linux）
sudo ufw allow 8080

# 或使用iptables
sudo iptables -A INPUT -p tcp --dport 8080 -j ACCEPT
```

### 🗄️ 数据库配置

#### openGauss连接示例
```ini
DATABASE_URL=opengauss://username:password@host:port/database
DB_HOST=192.168.0.20
DB_PORT=5560
DB_USER=grigs
DB_PASSWORD=Slnwg123$
DB_DATABASE=taf_claude_2
```

#### 连接池配置
```ini
DB_POOL_SIZE=10
DB_MAX_OVERFLOW=20
DB_POOL_TIMEOUT=30
DB_POOL_RECYCLE=3600
```

### 📱 钉钉通知配置

#### API配置
```ini
DINGTALK_API_URL=http://192.168.0.20:5555
DINGTALK_API_KEY=sk-dingtalk-api-2024-001
DINGTALK_DEFAULT_PHONE=13293513336
```

#### 通知事件配置
```ini
NOTIFY_BACKUP_SUCCESS=true
NOTIFY_BACKUP_FAILED=true
NOTIFY_TAPE_CHANGE=true
NOTIFY_SYSTEM_ERROR=true
```

### 📼 磁带设备配置

#### Windows配置
```ini
TAPE_DRIVE_LETTER=o
TAPE_DRIVE_PATH=o:\
```

#### Linux配置
```ini
TAPE_DEVICE_PATH=/dev/nst0
TAPE_DEVICE_PATH_ALT=/dev/st0
```

#### 磁带操作参数
```ini
DEFAULT_BLOCK_SIZE=262144
MAX_VOLUME_SIZE=322122547200
TAPE_TIMEOUT=300
TAPE_RETRY_COUNT=3
```

### 🔄 备份策略配置

#### 保留策略
```ini
DEFAULT_RETENTION_MONTHS=6
AUTO_ERASE_EXPIRED=true
```

#### 定时任务配置
```ini
MONTHLY_BACKUP_CRON=0 2 1 * *
WEEKLY_BACKUP_CRON=0 3 * * 0
DAILY_BACKUP_CRON=0 4 * * *
RETENTION_CHECK_CRON=0 3 * * *
```

### 📝 日志配置

#### 日志级别
- `DEBUG`: 详细调试信息
- `INFO`: 一般信息（推荐）
- `WARNING`: 警告信息
- `ERROR`: 错误信息
- `CRITICAL`: 严重错误

#### 日志文件配置
```ini
LOG_FILE=logs/application.log
LOG_MAX_SIZE=104857600
LOG_BACKUP_COUNT=30
LOG_ROTATION=midnight
```

### 🔧 故障排除

#### 配置文件问题
```bash
# 检查配置文件语法
python config_manager.py validate

# 重置为默认配置
python config_manager.py reset
```

#### 权限问题
```bash
# 确保配置文件可读
ls -la .env

# 修复权限
chmod 600 .env
```

#### 编码问题
```bash
# Windows控制台编码
chcp 65001

# 或使用PowerShell
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
```

### 🚀 快速配置指南

#### 1. 开发环境
```bash
# 使用配置向导
python config_manager.py setup

# 或手动设置关键配置
python config_manager.py set DEBUG true
python config_manager.py set LOG_LEVEL DEBUG
python config_manager.py set WEB_PORT 8080
```

#### 2. 生产环境
```bash
# 使用配置向导
python config_manager.py setup

# 验证配置
python config_manager.py validate

# 查看配置状态
python config_manager.py show
```

#### 3. Docker部署
```bash
# 设置环境变量
export DATABASE_URL=opengauss://user:pass@host:port/db
export SECRET_KEY=your-secret-key
export DINGTALK_API_KEY=your-api-key

# 启动容器
docker run -d -p 8080:8080 enterprise-tape-backup
```

### 📞 技术支持

如遇配置问题：

1. 查看配置验证结果
2. 检查日志文件
3. 使用配置工具排查
4. 查阅本文档
5. 联系技术支持

---

**企业级磁带备份系统配置管理**
版本: v1.0.0
更新时间: 2024-10-31