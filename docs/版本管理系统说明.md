# 版本管理系统说明

## 概述

本文档说明版本管理系统的配置和使用方法。

## 功能特性

### 1. 版本号管理

- **当前版本**: v0.0.1
- **版本格式**: Semantic Versioning (MAJOR.MINOR.PATCH)
- **版本位置**:
  - `config/settings.py`: `APP_VERSION`
  - `setup.py`: `version`参数
  - `README.md`: 版本历史
  - `CHANGELOG.md`: 详细更新日志

### 2. 数据库文件管理

#### 旧配置
- **旧路径**: `backup_system.db` (根目录)
- **问题**: 根目录文件混乱，不利于管理

#### 新配置
- **新路径**: `data/taf_backup.db`
- **优势**:
  - 统一的数据文件管理
  - 清晰的目录结构
  - 便于备份和迁移

#### 配置文件更新
- `.env`: 已更新数据库路径
- `.env.sample`: 已更新模板
- `config/settings.py`: 新增 `DATA_DIR` 和 `SQLITE_DB_FILE`
- `.gitignore`: 已忽略 `data/taf_backup.db`

### 3. CHANGELOG 系统

#### 文件位置
- `CHANGELOG.md`: 项目根目录

#### 格式
遵循 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/) 标准格式

#### 更新规则
- 每个版本一个章节
- 按分类组织（新增、修复、改进、移除）
- 包含日期和版本号

### 4. UI版本显示

#### 版本显示位置
1. **页脚**: 所有页面底部显示版本号
2. **系统设置**: "关于系统"标签页显示版本详情

#### 版本链接功能
- 点击版本号可弹出 CHANGELOG 模态框
- 实时加载最新更新日志
- 支持 Markdown 渲染
- 带滚动条，便于查看长日志

### 5. API接口

#### GET /api/system/version
获取版本信息和CHANGELOG

**响应示例**:
```json
{
  "version": "0.0.1",
  "app_name": "企业级磁带备份系统",
  "changelog": "# 更新日志\n\n..."
}
```

#### GET /api/system/info
获取系统信息（包含版本号）

**响应示例**:
```json
{
  "app_name": "企业级磁带备份系统",
  "version": "0.0.1",
  "python_version": "3.8+",
  "platform": "Windows/openEuler",
  "database": "openGauss",
  "compression": "7-Zip SDK"
}
```

## 使用指南

### 更新版本号

1. **修改代码版本**:
   ```bash
   # 编辑 config/settings.py
   APP_VERSION: str = "0.0.2"  # 或新的版本号
   ```

2. **更新 setup.py**:
   ```bash
   # 编辑 setup.py
   version="0.0.2"
   ```

3. **更新 CHANGELOG.md**:
   ```markdown
   ## [0.0.2] - 2024-11-02
   
   ### 新增
   - 新功能1
   - 新功能2
   
   ### 修复
   - 修复了问题1
   ```

4. **更新 README.md**:
   ```markdown
   ## 版本历史
   
   - v0.0.2 - 最新版本
     - 新功能描述
   - v0.0.1 - 初始版本
     - 基础功能
   ```

### 查看版本信息

#### 通过Web界面
1. 访问: http://localhost:8080
2. 点击页脚或"系统设置"中的版本号
3. 查看弹出的CHANGELOG

#### 通过API
```bash
# 获取版本信息
curl http://localhost:8080/api/system/version

# 获取系统信息（包含版本）
curl http://localhost:8080/api/system/info
```

### 迁移数据库文件

如果从旧版本升级到包含 `data/` 目录的新版本：

#### 方式1: 手动迁移
```bash
# Windows
if exist backup_system.db move backup_system.db data\taf_backup.db

# Linux/Mac
mv backup_system.db data/taf_backup.db
```

#### 方式2: 重新初始化
```bash
# 删除旧文件
rm backup_system.db

# 系统会自动在 data/ 目录创建新数据库
python main.py
```

## 技术实现

### 前端实现

#### Markdown渲染
使用 [Marked.js](https://github.com/markedjs/marked) 渲染CHANGELOG

```html
<!-- base.html -->
<script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
```

#### JavaScript代码
```javascript
// web/static/js/main.js
async function loadChangelog() {
    const response = await fetch('/api/system/version');
    const data = await response.json();
    const contentDiv = document.getElementById('changelog-content');
    contentDiv.innerHTML = marked.parse(data.changelog);
}
```

### 后端实现

#### API接口
```python
# web/api/system.py
@router.get("/version")
async def get_version():
    settings = get_settings()
    changelog_path = Path("CHANGELOG.md")
    
    with open(changelog_path, "r", encoding="utf-8") as f:
        changelog_content = f.read()
    
    return {
        "version": settings.APP_VERSION,
        "app_name": settings.APP_NAME,
        "changelog": changelog_content
    }
```

### 样式定制

#### CSS样式
```css
/* web/static/css/main.css */
#changelog-content {
    max-height: 500px;
    overflow-y: auto;
}

#version-link {
    cursor: pointer;
    transition: color 0.2s;
}

#version-link:hover {
    color: #007bff !important;
}
```

## 目录结构

```
TAF/
├── data/                        # 数据目录（新增）
│   └── taf_backup.db           # SQLite数据库文件
├── config/
│   └── settings.py             # 配置设置（版本号）
├── web/
│   ├── static/
│   │   ├── css/
│   │   │   └── main.css        # 样式文件
│   │   └── js/
│   │       └── main.js         # JavaScript文件
│   ├── api/
│   │   └── system.py           # API接口
│   └── templates/
│       ├── base.html           # 基础模板（版本显示）
│       └── system.html         # 系统设置页面
├── CHANGELOG.md                # 更新日志
├── README.md                   # 项目说明（版本历史）
├── setup.py                    # 安装配置（版本号）
└── .env                        # 环境变量（数据库路径）
```

## 最佳实践

### 1. 版本号命名规范
- 使用语义化版本控制
- `MAJOR`: 不兼容的API修改
- `MINOR`: 向后兼容的功能性新增
- `PATCH`: 向后兼容的问题修正

### 2. CHANGELOG更新
- 每次发布新版本都要更新
- 按用户视角描述变更
- 区分新增、修复、改进、移除
- 包含完整的日期

### 3. 数据库迁移
- 升级前备份数据库
- 测试新版本兼容性
- 提供迁移脚本或说明

### 4. UI体验
- 版本号清晰可见
- 点击便捷查看更新日志
- 样式统一美观
- 响应式设计

## 故障排除

### 问题1: 版本API返回404
**原因**: API路由未正确注册  
**解决**: 检查 `web/app.py` 中的路由注册

### 问题2: CHANGELOG无法加载
**原因**: 文件路径或编码问题  
**解决**: 确认 `CHANGELOG.md` 存在且UTF-8编码

### 问题3: Markdown渲染失败
**原因**: Marked.js未正确加载  
**解决**: 检查CDN链接和网络连接

### 问题4: 数据库文件路径错误
**原因**: `data/` 目录不存在  
**解决**: 创建目录并检查权限

```bash
# Windows
mkdir data

# Linux/Mac
mkdir -p data
chmod 755 data
```

## 更新记录

- **2024-11-01**: 实现版本管理系统
  - 新增版本号管理和显示
  - 新增CHANGELOG模态框
  - 新增数据库文件迁移到data目录
  - 新增版本API接口

