企业级磁带备份系统 - 完整开发提示词
你是“企业级磁带备份系统”首席架构师，需一次性输出可直接运行的完整工程骨架
记住：启动命令： conda activate taf ; python .\main.py ，tests放测试程序。docs放文本
网上搜索研究IBM ULT3580-HH9 SCSI磁带机的操作、发现方法，完善本程序磁带设备部分

🎯 核心需求概述
项目基本信息
主程序: main.py 在根目录

开发语言: Python，简体中文界面

Web管理: 基于Web的系统管理界面

数据库: openGauss

运行环境: Windows + openEuler 双平台支持

压缩方式: 7-Zip SDK级别接口，3GB/包

通知系统: 钉钉API通知（成功、失败、换盘）

关键配置
python
DB_CONFIG = {
    'host': '192.168.0.20',
    'port': 5560,
    'user': 'grigs',
    'password': 'Slnwg123$',
    'database': 'taf_codex_1'
}
📁 完整目录结构参考
根目录/
├── main.py                 # 主程序入口
├── mcp/                    # 核心备份模块
├── tests/                  # 测试程序目录
├── docs/                   # 文档目录
├── web/                    # Web界面模块
├── backup/                 # 备份处理模块
├── recovery/               # 恢复处理模块
├── tape/                   # 磁带驱动模块
├── config/                 # 配置管理模块
└── utils/                  # 工具类模块
🔧 环境配置说明
环境变量配置 (.env、.env.sample)
ini
# 数据库配置（可配置）
DATABASE_URL=opengauss://grigs:Slnwg123$@192.168.0.20:5560/taf_cursor
DB_POOL_SIZE=10
DB_MAX_OVERFLOW=20

# 安全配置（可配置）
SECRET_KEY=your-jwt-secret-key
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# 磁带配置（可配置）
TAPE_DRIVE_LETTER=o
DEFAULT_BLOCK_SIZE=262144
MAX_VOLUME_SIZE=322122547200

# 压缩配置（7-Zip SDK）（可配置）
COMPRESSION_LEVEL=9
SOLID_BLOCK_SIZE=67108864
MAX_FILE_SIZE=3221225472

# 计划任务配置（可配置）
SCHEDULER_ENABLED=true
MONTHLY_BACKUP_CRON=0 2 1 * *    # 每月1号02:00
RETENTION_CHECK_CRON=0 3 * * *   # 每天03:00

# 钉钉通知配置（可配置）
默认 API Key: `sk-dingtalk-api-2024-001`
### 标准消息发送
http://192.168.0.20:5555

**接口地址**: `POST /api/v1/messages/send`

**请求头**:
```
Content-Type: application/json
Authorization: Bearer sk-dingtalk-api-2024-001
```

**请求体**:
```json
{
    "phone": "13293513336",
    "title": "消息标题",
    "content": "消息内容",
    "message_type": "markdown"
}
```

**参数说明**:
- `phone`: 手机号（必填）
- `title`: 消息标题（必填）
- `content`: 消息内容（必填）
- `message_type`: 消息类型（可选，默认: markdown）
  - `text`: 纯文本
  - `markdown`: Markdown格式（推荐）
  - `action_card`: ActionCard格式

**响应示例**:
```json
{
    "success": true,
    "message": "消息发送成功",
    "user_id": "101753494523696248",
    "task_id": "api_task_1730256000000",
    "details": {
        "phone": "13293513336",
        "title": "消息标题",
        "content": "消息内容"
    }
}
```

### 批量消息发送

**接口地址**: `POST /api/v1/messages/batch`

**请求体**:
```json
{
    "phones": ["13293513336", "13800138000"],
    "title": "批量消息",
    "content": "这是一条批量发送的消息",
    "message_type": "markdown"
}
```

### 查询任务状态

**接口地址**: `GET /api/v1/tasks/{task_id}`

**响应示例**:
```json
{
    "success": true,
    "message": "查询成功",
    "task_id": "api_task_1730256000000",
    "status": "completed",
    "user_id": "101753494523696248",
    "phone": "13293513336",
    "title": "消息标题",
    "content": "消息内容"
}
```

### 获取消息记录

**接口地址**: `GET /api/v1/messages`

**查询参数**:
- `limit`: 每页数量（默认: 50）
- `offset`: 偏移量（默认: 0）
- `phone`: 手机号过滤（可选）

### 获取统计信息

**接口地址**: `GET /api/v1/statistics`

**响应示例**:
```json
{
    "success": true,
    "message": "查询成功",
    "total": 100,
    "success_count": 95,
    "failed_count": 5,
    "success_rate": 95.0,
    "recent_24h": {
        "total": 20,
        "success": 19,
        "failed": 1,
        "success_rate": 95.0
    },
    "api_usage": {
        "total_requests": 120,
        "successful_requests": 115,
        "failed_requests": 5
    }
}
```

### 健康检查

**接口地址**: `GET /api/v1/health`

**响应示例**:
```json
{
    "status": "healthy",
    "timestamp": "2024-10-30 04:20:00",
    "version": "1.0.0",
    "uptime": 3600.5
}

# 日志配置
LOG_LEVEL=INFO
LOG_FILE=logs/application.log
关键log存数据库

# 系统配置
DEFAULT_RETENTION_MONTHS=6
AUTO_ERASE_EXPIRED=true
🎯 核心功能实现要求
1. 备份周期策略
6个月循环备份体系：

每月执行一次完整备份（Web界面可配置时间）

自动生成月度备份组（YYYY-MM格式）

保持6个活跃备份组循环

第7个月自动清理最旧备份组

2. 磁带生命周期管理
存活期配置：

默认6个月，Web界面可配置

自动标记过期磁带

备份前自动擦除过期磁带

擦除后重新投入备份池

3. 压缩策略(可配置)
智能分包压缩：

使用7-Zip SDK级别接口（非命令行）

单个包不超过3GB

小文件分组打包，大文件独立分块

LZMA2算法，最大压缩率

4. 通知系统
钉钉通知事件：

备份操作成功/失败

磁带更换提醒

系统异常告警

容量阈值预警

Web配置界面：

钉钉API配置（URL、Token）

接收人员管理（增删改查）

通知模板配置

测试发送功能

🖥️ 前端界面功能
页面功能详情
备份管理页面：

新建备份任务（源路径、参数配置）

实时进度监控（压缩、写入进度）

任务历史记录和统计

恢复管理页面：

6个月备份组时间轴浏览

文件树目录结构可视化

文件搜索（名称、类型、日期）

批量恢复操作界面

磁带位置明确提示

磁带管理页面：

磁带库存状态监控

健康度指标展示

存活期配置界面

手动擦除操作

系统设置页面：

钉钉API配置（支持测试）

接收人员表管理

版本信息显示和历史

系统参数配置

🔄 系统集成要求
跨平台兼容性
Windows环境：

SCSI通过Windows SPTI接口

列出磁带设备路径可选择

openEuler环境：

SCSI通过Linux sg_io接口

列出磁带设备路径可选择

数据库集成
openGauss配置：

连接池管理（同步+异步）

自动迁移脚本（Alembic）

事务性数据操作

计划任务系统
Celery任务类型：

月度完整备份任务

磁带存活期检查

过期磁带自动擦除

系统健康检查

📊 监控和日志
日志系统要求
日志类型：

操作日志（登录、备份、恢复、配置修改）

磁带操作日志（SCSI命令、状态）

系统运行日志

通知发送日志

存储方式：

文件存储（滚动日志）

数据库存储（关键操作）

实时Web界面查看

监控指标
性能监控：

备份/恢复速度

压缩比率

系统资源使用

磁带健康状态

🚀 部署和运维
启动流程
bash
# 1. 激活环境
conda activate taf

# 2. 启动服务
python main.py                    # 启动Web服务
celery -A celery_app worker       # 启动任务Worker
celery -A celery_app beat         # 启动计划任务
健康检查
数据库连接状态

磁带设备可用性

服务进程状态

存储空间监控

⚠️ 开发注意事项
强制要求
所有用户界面提示必须使用中文

代码内部变量使用英文

文档文件名使用中文

禁止使用TODO、FIXME等临时标记

技术规范
7-Zip必须使用SDK级别集成（py7zr）

磁带操作必须使用SCSI指令级

数据库操作必须事务性保证

错误处理必须完善并记录日志

6个月循环备份体系：
├── 每月执行一次完整备份，可web设置
├── 形成月度备份组（YYYY-MM格式）
├── 保持6个活跃备份组
└── 第7个月自动清理最旧备份组
1.3 数据生命周期
- 磁带存活期：6个月，可web设置
- 自动标记：在磁带创建标记文件
- 过期清理：超过存活期的磁带自动清空回收，备份前先清空超过存活期的磁带
- 循环使用：清空后的磁带重新投入备份池
测试要求
单元测试覆盖率>80%

集成测试覆盖主要业务流程

跨平台兼容性测试

性能压力测试

