# 压缩文件移动队列实现说明

## 概述

实现了压缩文件的异步移动机制，将压缩和移动操作解耦，提高备份效率。

## 实现功能

### 1. 目录结构

- **temp目录**：`temp/compress/temp/{backup_set.set_id}/`
  - 压缩时先将文件保存到这里
  - 压缩完成后移动到final目录

- **final目录**：`temp/compress/final/{backup_set.set_id}/`
  - 压缩完成后文件移动到这里
  - 等待移动到磁带机的队列

- **磁带机**：通过LTFS挂载的盘符（如 `O:\`）
  - 最终文件移动到这里

### 2. 文件移动队列管理器

**文件**：`backup/tape_file_mover.py`

**功能**：
- 维护一个文件移动队列
- 使用单线程顺序处理文件移动到磁带机
- 确保磁带机操作是串行的（磁带机只能顺序工作）
- 异步处理，不影响后续压缩工作

**主要方法**：
- `start()`: 启动移动队列工作线程
- `stop()`: 停止移动队列工作线程
- `add_file()`: 添加文件到移动队列
- `get_queue_size()`: 获取队列大小
- `is_processing()`: 检查是否正在处理任务

### 3. 压缩流程修改

**文件**：`backup/compressor.py`

**修改内容**：
- 压缩时先保存到 `temp/compress/temp/` 目录
- 压缩完成后，将文件移动到 `temp/compress/final/` 目录
- 返回final目录中的文件路径

### 4. 备份引擎集成

**文件**：`backup/backup_engine.py`

**修改内容**：
- 初始化时创建temp和final目录
- 初始化文件移动队列管理器并启动
- 压缩完成后，将文件加入移动队列而不是直接移动
- 系统关闭时停止文件移动队列管理器

## 工作流程

```
1. 压缩文件组
   ↓
2. 文件保存到 temp/compress/temp/{set_id}/backup_xxx.7z
   ↓
3. 压缩完成
   ↓
4. 文件移动到 temp/compress/final/{set_id}/backup_xxx.7z
   ↓
5. 文件加入移动队列
   ↓
6. 后台线程顺序处理队列中的文件
   ↓
7. 移动到磁带机 O:\{set_id}\backup_xxx.7z
   ↓
8. 删除final目录中的源文件
```

## 关键特性

1. **异步处理**：文件移动在后台线程中进行，不影响压缩工作
2. **顺序执行**：磁带机操作必须顺序执行，队列管理器确保这一点
3. **错误处理**：移动失败会记录日志，但不影响后续文件
4. **资源管理**：系统关闭时会停止队列管理器，等待队列中的任务完成

## 配置

相关配置项在 `config/settings.py` 中：
- `BACKUP_COMPRESS_DIR`: 压缩文件临时目录（默认：`temp/compress`）

实际目录结构：
- `temp/compress/temp/` - 压缩临时目录
- `temp/compress/final/` - 压缩完成后的正式目录

## 注意事项

1. **磁带机顺序工作**：队列管理器确保文件一个接一个移动到磁带机，不能并行
2. **文件路径**：压缩完成后返回的是final目录中的路径
3. **数据库记录**：文件信息在加入队列时保存到数据库，使用final目录路径
4. **移动完成后**：文件移动到磁带机后，final目录中的源文件会被删除

