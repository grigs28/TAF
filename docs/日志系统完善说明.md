# 日志系统完善说明

## 一、概述

本次完善了企业级磁带备份系统的日志系统，实现了完备的日志记录功能，包括登录、修改、备份、恢复、磁带操作等各类操作的分类记录。

## 二、完善内容

### 2.1 日志模型扩展

#### OperationType 枚举扩展
增加了以下操作类型：
- **用户操作**：LOGIN, LOGOUT, REGISTER, PASSWORD_CHANGE, PERMISSION_CHANGE
- **备份恢复操作**：BACKUP, BACKUP_START, BACKUP_COMPLETE, BACKUP_CANCEL, RECOVERY, RECOVERY_START, RECOVERY_COMPLETE, RECOVERY_CANCEL
- **磁带操作**：TAPE_LOAD, TAPE_UNLOAD, TAPE_WRITE, TAPE_READ, TAPE_ERASE, TAPE_REWIND, TAPE_VERIFY, TAPE_FORMAT, TAPE_CLEAN, TAPE_CREATE, TAPE_UPDATE, TAPE_DELETE
- **配置操作**：CONFIG, CONFIG_UPDATE, CONFIG_DELETE
- **计划任务操作**：SCHEDULED_TASK_CREATE, SCHEDULED_TASK_UPDATE, SCHEDULED_TASK_DELETE, SCHEDULED_TASK_EXECUTE, SCHEDULED_TASK_ENABLE, SCHEDULED_TASK_DISABLE

#### LogCategory 枚举扩展
增加了以下日志分类：
- TAPE_OPERATION：磁带操作日志
- AUTHENTICATION：认证日志（登录、登出）
- CONFIGURATION：配置日志
- SCHEDULED_TASK：计划任务日志

### 2.2 数据库字段完善

为所有日志表添加了索引，提高查询效率：

#### SystemLog 表索引
- `idx_system_log_time`: 按时间查询
- `idx_system_log_level_category`: 按级别和分类查询
- `idx_system_log_user_id`: 按用户ID查询
- `idx_system_log_task_id`: 按任务ID查询
- `idx_system_log_category_time`: 按分类和时间查询

#### OperationLog 表索引
- `idx_operation_log_time`: 按操作时间查询
- `idx_operation_log_user_time`: 按用户和时间查询
- `idx_operation_log_type_time`: 按操作类型和时间查询
- `idx_operation_log_resource`: 按资源类型和ID查询
- `idx_operation_log_success_time`: 按成功状态和时间查询
- `idx_operation_log_ip_time`: 按IP地址和时间查询

#### ErrorLog 表索引
- `idx_error_log_time`: 按错误时间查询
- `idx_error_log_level_time`: 按错误级别和时间查询
- `idx_error_log_resolved_time`: 按解决状态和时间查询
- `idx_error_log_code`: 按错误代码查询
- `idx_error_log_category_time`: 按分类和时间查询

#### AuditLog 表索引
- `idx_audit_log_time`: 按事件时间查询
- `idx_audit_log_actor_time`: 按操作者和时间查询
- `idx_audit_log_type_time`: 按审计类型和时间查询
- `idx_audit_log_object`: 按对象类型和ID查询
- `idx_audit_log_result_time`: 按结果和时间查询
- `idx_audit_log_ip_time`: 按IP地址和时间查询

### 2.3 日志服务类（LogService）

创建了统一的日志服务类 `utils/log_service.py`，提供以下功能：

#### 核心方法
1. **log_system()**: 记录系统日志
2. **log_operation()**: 记录操作日志
3. **log_error()**: 记录错误日志
4. **log_audit()**: 记录审计日志

#### 便捷方法
1. **log_login()**: 记录登录操作（同时记录操作日志和审计日志）
2. **log_logout()**: 记录登出操作
3. **log_backup()**: 记录备份操作
4. **log_recovery()**: 记录恢复操作
5. **log_tape_operation()**: 记录磁带操作

#### 装饰器
- `log_operation_decorator`: 操作日志装饰器，自动记录函数执行时间和结果

### 2.4 日志中间件完善

完善了 `web/middleware/logging_middleware.py`，实现了：

1. **自动记录HTTP请求**：记录所有API请求到操作日志表
2. **请求信息记录**：记录请求方法、URL、参数、请求体、响应状态、响应体
3. **性能监控**：记录请求处理时间
4. **错误记录**：记录请求处理失败的错误信息
5. **操作类型识别**：根据路径自动识别操作类型（登录、备份、恢复、磁带操作等）
6. **用户信息记录**：尝试从JWT token中解析用户ID（待完善）

### 2.5 关键操作点日志记录

在以下关键操作点添加了日志记录：

#### 用户操作
- **登录** (`web/api/user.py`)
  - 记录登录成功/失败
  - 记录IP地址、User-Agent
  - 同时记录操作日志和审计日志
  
- **登出** (`web/api/user.py`)
  - 记录登出操作
  - 记录IP地址、User-Agent

#### 备份操作
- **备份开始** (`backup/backup_engine.py`)
  - 记录备份任务开始
  - 记录任务ID、用户ID
  
- **备份完成** (`backup/backup_engine.py`)
  - 记录备份成功/失败
  - 记录备份统计信息（文件数、大小、耗时、磁带ID）

#### 恢复操作
- **恢复开始** (`recovery/recovery_engine.py`)
  - 记录恢复任务开始
  - 记录备份集ID
  
- **恢复完成** (`recovery/recovery_engine.py`)
  - 记录恢复成功/失败
  - 记录恢复统计信息（文件数、大小、耗时）

#### 磁带操作
- **加载磁带** (`tape/tape_manager.py`)
  - 记录加载成功/失败
  - 记录磁带ID、错误信息
  
- **卸载磁带** (`tape/tape_manager.py`)
  - 记录卸载成功
  - 记录磁带ID

## 三、日志分类说明

### 3.1 什么存数据库

根据磁带操作日志的最佳实践，以下内容存储在数据库中：

#### 必须存储（数据库）
1. **操作日志（OperationLog）**
   - 所有用户操作（登录、登出、创建、更新、删除等）
   - 操作时间、用户ID、IP地址、操作类型、操作结果
   - 请求和响应信息（方法、URL、参数、状态码）
   - 变更信息（修改前后值、变更字段）

2. **系统日志（SystemLog）**
   - 重要系统事件（备份开始、备份完成、恢复开始、恢复完成）
   - 错误和异常信息
   - 性能指标（处理时间、内存使用、CPU使用率）

3. **审计日志（AuditLog）**
   - 安全相关操作（登录、登出、权限变更）
   - 合规要求的操作记录
   - 敏感数据访问记录

4. **错误日志（ErrorLog）**
   - 系统错误和异常
   - 错误堆栈跟踪
   - 错误解决状态

#### 可以存储在文件
1. **详细调试日志**：DEBUG级别的详细日志
2. **高频操作日志**：如每次文件读写、每次SCSI命令（可配置是否存储到数据库）
3. **历史归档日志**：超过保留期的日志可以归档到文件或磁带

### 3.2 日志存储规划

#### 数据库存储策略
- **操作日志**：保留最近6个月
- **系统日志**：保留最近3个月
- **审计日志**：保留最近2年（合规要求）
- **错误日志**：保留最近1年

#### 日志归档策略
- 定期将超过保留期的日志导出到文件或磁带
- 已解决的错误日志可以归档
- 审计日志必须长期保留，归档到离线存储

#### 索引优化
- 所有日志表都添加了时间索引，支持按时间范围查询
- 添加了用户ID、操作类型等常用查询字段的索引
- 支持按分类、级别等维度查询

## 四、数据库初始化

### 4.1 表结构
所有日志表在数据库初始化时会自动创建，包括：
- `system_logs`: 系统日志表
- `operation_logs`: 操作日志表
- `error_logs`: 错误日志表
- `audit_logs`: 审计日志表

### 4.2 索引创建
所有索引在表创建时自动创建，无需手动执行SQL。

### 4.3 枚举类型
所有枚举类型（LogLevel, LogCategory, OperationType, ErrorLevel）在数据库初始化时自动创建。

## 五、使用示例

### 5.1 记录登录日志
```python
from utils.log_service import log_service
from models.system_log import OperationType

await log_service.log_login(
    user_id=1,
    success=True,
    ip_address="192.168.1.100",
    user_agent="Mozilla/5.0..."
)
```

### 5.2 记录备份操作
```python
await log_service.log_backup(
    task_id="backup_20241103_001",
    operation_type=OperationType.BACKUP_START,
    user_id=1,
    success=True
)

await log_service.log_backup(
    task_id="backup_20241103_001",
    operation_type=OperationType.BACKUP_COMPLETE,
    user_id=1,
    tape_id="TAPE001",
    success=True,
    details={
        'total_files': 1000,
        'processed_files': 1000,
        'total_bytes': 1024000000,
        'processed_bytes': 1024000000
    }
)
```

### 5.3 记录磁带操作
```python
await log_service.log_tape_operation(
    tape_id="TAPE001",
    operation_type=OperationType.TAPE_LOAD,
    user_id=1,
    success=True
)
```

### 5.4 记录操作日志
```python
await log_service.log_operation(
    operation_type=OperationType.UPDATE,
    resource_type="tape",
    resource_id="TAPE001",
    operation_name="更新磁带信息",
    user_id=1,
    success=True,
    old_values={"status": "AVAILABLE"},
    new_values={"status": "IN_USE"}
)
```

## 六、查询日志

### 6.1 查询操作日志
```sql
-- 查询最近的操作日志
SELECT * FROM operation_logs 
WHERE operation_time >= NOW() - INTERVAL '7 days'
ORDER BY operation_time DESC;

-- 查询特定用户的操作日志
SELECT * FROM operation_logs 
WHERE user_id = 1 
AND operation_time >= NOW() - INTERVAL '30 days'
ORDER BY operation_time DESC;

-- 查询备份操作日志
SELECT * FROM operation_logs 
WHERE operation_type IN ('backup_start', 'backup_complete')
ORDER BY operation_time DESC;
```

### 6.2 查询系统日志
```sql
-- 查询错误日志
SELECT * FROM system_logs 
WHERE log_level = 'error'
AND log_time >= NOW() - INTERVAL '24 hours'
ORDER BY log_time DESC;

-- 查询备份相关的系统日志
SELECT * FROM system_logs 
WHERE category = 'backup'
ORDER BY log_time DESC;
```

### 6.3 查询审计日志
```sql
-- 查询登录审计日志
SELECT * FROM audit_logs 
WHERE audit_type = 'authentication'
AND event_time >= NOW() - INTERVAL '30 days'
ORDER BY event_time DESC;
```

## 七、后续优化建议

1. **日志查询API**：提供RESTful API接口，方便前端查询和展示日志
2. **日志统计报表**：提供日志统计分析功能（操作次数、错误频率、用户活跃度等）
3. **日志告警**：对重要错误和异常操作发送告警通知
4. **日志导出**：支持将日志导出为Excel、CSV等格式
5. **日志可视化**：提供日志可视化看板，实时展示系统运行状态
6. **日志压缩**：对历史日志进行压缩，减少存储空间
7. **分布式日志**：如果系统部署在多个节点，考虑使用ELK等分布式日志系统

## 八、总结

本次完善实现了完备的日志系统，包括：

✅ **完整的日志分类**：登录、修改、备份、恢复、磁带操作等
✅ **完善的数据库设计**：字段齐全、索引优化、注释完整
✅ **统一的日志服务**：提供便捷的日志记录接口
✅ **自动化的日志记录**：中间件自动记录HTTP请求
✅ **关键操作点覆盖**：在登录、备份、恢复、磁带操作等关键点都添加了日志记录
✅ **数据库初始化**：表结构和索引在初始化时自动创建

系统现在具备了完善的日志记录能力，可以满足审计、故障排查、性能分析等需求。

---

*文档生成时间: 2024-11-03*  
*版本: 1.0*

