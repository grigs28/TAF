# 数据库配置功能说明

## 概述

系统提供了完善的Web界面数据库配置功能，支持多种数据库类型，包括SQLite、PostgreSQL、openGauss和MySQL。

## 功能特性

### 1. 多数据库类型支持
- **SQLite**: 轻量级本地数据库，适合小型部署
- **PostgreSQL**: 开源关系型数据库
- **openGauss**: 华为开源企业级数据库（推荐）
- **MySQL**: 流行的开源数据库

### 2. 配置管理
- 可视化配置界面
- 实时连接测试
- 自动保存配置到 `.env` 文件
- 配置验证和错误提示

### 3. 状态监控
- 实时连接状态显示
- 连接池使用情况
- 自动刷新状态（每30秒）

## 使用说明

### 访问配置界面

1. 启动系统：
   ```bash
   conda activate taf
   python .\main.py
   ```

2. 打开浏览器访问：http://localhost:8080

3. 进入"系统设置" → "数据库"选项卡

### 配置步骤

#### SQLite配置

1. 选择"SQLite"作为数据库类型
2. 输入数据库文件路径（例如：`./backup_system.db`）
3. 配置连接池大小和最大溢出数
4. 点击"测试连接"验证配置
5. 点击"保存配置"保存设置

#### PostgreSQL/openGauss配置

1. 选择"PostgreSQL"或"openGauss"作为数据库类型
2. 填写连接信息：
   - 数据库主机：例如 `192.168.0.20`
   - 数据库端口：例如 `5560`
   - 数据库名称：例如 `taf_codex_1`
   - 用户名：例如 `grigs`
   - 密码：输入数据库密码
3. 配置连接池大小和最大溢出数
4. 点击"测试连接"验证配置
5. 点击"保存配置"保存设置

#### MySQL配置

1. 选择"MySQL"作为数据库类型
2. 填写连接信息（格式与PostgreSQL相同）
3. 配置连接池和测试连接
4. 保存配置

### 连接池配置

- **连接池大小**: 系统维护的基本连接数（建议10-20）
- **最大溢出**: 超出连接池后可创建的最大额外连接数（建议20-50）

根据系统负载和并发访问量调整这些参数。

## API接口

### 获取数据库配置

```
GET /api/system/database/config
```

**响应示例**:
```json
{
    "db_type": "opengauss",
    "db_host": "192.168.0.20",
    "db_port": 5560,
    "db_user": "grigs",
    "db_database": "taf_codex_1",
    "pool_size": 10,
    "max_overflow": 20
}
```

### 测试数据库连接

```
POST /api/system/database/test
Content-Type: application/json

{
    "db_type": "opengauss",
    "db_host": "192.168.0.20",
    "db_port": 5560,
    "db_user": "grigs",
    "db_password": "your_password",
    "db_database": "taf_codex_1",
    "pool_size": 10,
    "max_overflow": 20
}
```

**响应示例**:
```json
{
    "success": true,
    "message": "数据库连接测试成功",
    "db_type": "opengauss"
}
```

### 更新数据库配置

```
PUT /api/system/database/config
Content-Type: application/json

{
    "db_type": "opengauss",
    "db_host": "192.168.0.20",
    "db_port": 5560,
    "db_user": "grigs",
    "db_password": "your_password",
    "db_database": "taf_codex_1",
    "pool_size": 10,
    "max_overflow": 20
}
```

### 获取数据库状态

```
GET /api/system/database/status
```

**响应示例**:
```json
{
    "status": "online",
    "db_type": "openGauss",
    "pool_size": 10,
    "max_overflow": 20
}
```

## 配置文件

配置会保存到 `.env` 文件中：

```ini
DATABASE_URL=opengauss://grigs:Slnwg123$@192.168.0.20:5560/taf_codex_1
DB_HOST=192.168.0.20
DB_PORT=5560
DB_USER=grigs
DB_PASSWORD=Slnwg123$
DB_DATABASE=taf_codex_1
DB_POOL_SIZE=10
DB_MAX_OVERFLOW=20
```

## 注意事项

1. **重启生效**: 修改数据库配置后需要重启系统才能生效
2. **密码安全**: 配置界面中密码字段已加密显示
3. **连接测试**: 保存前建议先测试连接，确保配置正确
4. **备份数据**: 切换数据库前请先备份现有数据
5. **权限要求**: 确保数据库用户有足够的权限创建表和执行操作

## 故障排除

### 连接失败

1. 检查数据库服务是否运行
2. 验证网络连接是否正常
3. 确认防火墙规则允许访问
4. 检查用户名和密码是否正确
5. 查看系统日志获取详细错误信息

### 权限错误

确保数据库用户有以下权限：
- CREATE（创建数据库和表）
- ALTER（修改表结构）
- INSERT、UPDATE、DELETE（数据操作）
- SELECT（查询数据）

### 连接池错误

如果遇到连接池相关错误：
1. 检查 `pool_size` 和 `max_overflow` 设置
2. 增加连接池大小
3. 检查数据库最大连接数限制
4. 优化应用程序的数据库使用模式

## 技术支持

如遇到问题，请：
1. 查看系统日志文件：`logs/application.log`
2. 检查错误日志：`logs/error.log`
3. 运行健康检查：`GET /api/system/health`
4. 联系技术支持团队

---

**企业级磁带备份系统**
版本：v1.0.0
更新时间：2024-11-01

