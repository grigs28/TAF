# 磁带格式化检测逻辑

## 概述

系统使用多种方式检测磁带是否已格式化，按优先级从高到低依次尝试。

## 检测命令和方法

### 1. 主要方法：ITDT `checkltfsreadiness` 命令

**命令格式：**
```bash
itdt.exe -f \\.\tape0 checkltfsreadiness
# 或带参数
itdt.exe -f \\.\tape0 checkltfsreadiness -forcedataoverwrite
```

**实现位置：**
- `tape/itdt_interface.py` → `check_ltfs_readiness()`
- `tape/tape_operations.py` → `_is_tape_formatted()`

**判断逻辑：**

1. **命令成功执行 + 输出包含格式化关键词** → 已格式化
   - 关键词：`ready`、`formatted`、`ltfs ready`、`ltfs is ready`、`ltfs support`
   - 排除否定词：`not ready`、`not formatted`、`not supported`

2. **命令成功执行 + 输出包含否定词** → 未格式化
   - 关键词：`not ready`、`not formatted`、`not supported`

3. **命令失败 + 错误信息包含格式化相关提示** → 未格式化
   - 检查 stderr 中是否包含：`not formatted`、`not ready`、`not supported`

4. **其他情况** → 未格式化（默认）

**检测流程：**
```
1. 尝试使用 -forcedataoverwrite 参数
   ↓ (失败)
2. 尝试不使用 -forcedataoverwrite 参数
   ↓ (失败)
3. 回退到检查标签文件
```

**代码示例：**
```python
# 第一次尝试（带参数）
is_formatted = await self.itdt_interface.check_ltfs_readiness(force_data_overwrite=True)

# 如果失败，第二次尝试（不带参数）
if not is_formatted:
    is_formatted = await self.itdt_interface.check_ltfs_readiness(force_data_overwrite=False)
```

---

### 2. 辅助方法：ITDT `tapeusage` 命令（推断）

**命令格式：**
```bash
itdt.exe -f \\.\tape0 tapeusage
```

**实现位置：**
- `tape/itdt_interface.py` → `tape_usage()`

**判断逻辑：**

1. **命令成功执行** → 已格式化
   - 如果能成功获取统计信息，说明磁带已格式化且可用
   - `Result: PASSED` 且 `Code: OK` → 已格式化

2. **命令失败 + 错误信息包含格式化相关提示** → 未格式化
   - 检查错误信息中是否包含：`not formatted`、`not ready`、`mount` 等

3. **其他情况** → 无法确定（`None`）

**返回值：**
```python
{
    "thread_count": 7,
    "data_sets_read": 294,
    "data_sets_written": 218,
    # ... 其他统计信息
    "health_score": 100,
    "result": "PASSED",
    "code": "OK",
    "is_formatted": True  # 推断的格式化状态
}
```

---

### 3. 回退方案：读取标签文件

**文件路径：**
```
Windows: O:\.TAPE_LABEL.txt
```

**实现位置：**
- `tape/tape_operations.py` → `_read_tape_label()`

**判断逻辑：**

- **标签文件存在且不为空** → 已格式化
  - 能读取到标签内容，说明磁带已格式化

- **标签文件不存在或为空** → 未格式化（或无法确定）
  - 如果 ITDT 检测失败，回退到此方法
  - 如果标签文件存在，认为已格式化
  - 如果标签文件不存在，返回 `False`

---

## 完整检测流程

```
开始检测
    ↓
1. 使用 checkltfsreadiness（带参数）
    ↓ (失败)
2. 使用 checkltfsreadiness（不带参数）
    ↓ (失败)
3. 回退：检查标签文件 .TAPE_LABEL.txt
    ↓ (失败)
返回 False（未格式化）
```

---

## API 端点

### `/api/tape/operations/check-format`

**检测逻辑：**
1. 优先使用 ITDT `checkltfsreadiness` 命令
2. 同时尝试读取标签文件（用于获取标签信息）
3. 综合判断格式化状态

**返回结果：**
```json
{
    "success": true,
    "formatted": true,  // 或 false
    "metadata": {
        "tape_id": "TAP251103313",
        "label": "TAP251103313",
        "created_date": "2025-11-03",
        "serial_number": "10WT036260"
    },
    "message": "磁带已格式化，标签: TAP251103313"
}
```

---

## 设备路径处理

**Windows 系统：**
- 默认使用：`\\.\tape0`
- 自动转换：`\\.\scsi0` → `\\.\Tape0`
- 自动清理：移除路径末尾的冒号（如果有）

**Linux 系统：**
- 默认使用：`/dev/IBMtape0`

**代码位置：**
- `tape/itdt_interface.py` → `_resolve_device()`

---

## 使用场景

### 1. 添加磁带时
- 位置：`web/api/tape/crud.py` → `create_tape()`
- 逻辑：先检测格式化状态，只有已格式化才允许添加

### 2. 格式化检查 API
- 位置：`web/api/tape/operations.py` → `check_tape_format()`
- 逻辑：综合使用 ITDT 命令和标签文件检测

### 3. 磁带健康检测
- 位置：`web/api/tape/device.py` → `check_tape_health()`
- 逻辑：使用 `tapeusage` 命令，同时推断格式化状态

---

## 注意事项

1. **优先级**：`checkltfsreadiness` > 标签文件检查
2. **参数尝试**：先尝试 `-forcedataoverwrite`，失败后尝试不带参数
3. **错误处理**：如果 ITDT 命令失败，回退到标签文件检查
4. **设备路径**：Windows 下优先使用 `\\.\Tape0` 格式
5. **标签文件**：仅在 ITDT 检测失败时作为回退方案使用

---

## 相关代码文件

- `tape/itdt_interface.py` - ITDT 命令封装
- `tape/tape_operations.py` - 磁带操作（包含格式化检测）
- `web/api/tape/operations.py` - 格式化检查 API
- `web/api/tape/crud.py` - 创建磁带时的格式化检测
- `web/api/tape/device.py` - 健康检测（包含格式化推断）

