# 磁带写入操作流程和故障诊断

## 一、失败原因分析

### 1.1 当前失败的具体原因

从日志分析，失败的根本原因是：

**无法找到有效的DOS设备路径**

```
无法找到有效的DOS设备路径，使用DeviceID: SCSI\SEQUENTIAL&VEN_IBM&PROD_ULT3580-HH9\5&23894D7F&0&001800
（注意：此路径可能无法直接用于IO操作）
```

**问题链：**
1. ✅ 文件扫描成功（52481个文件）
2. ❌ 无法找到有效的DOS设备路径（`\\.\TAPE0`等）
3. ❌ 使用DeviceID作为fallback路径
4. ❌ DeviceID无法直接用于SCSI IO操作
5. ❌ `test_unit_ready()`失败，因为无法打开设备
6. ❌ 等待30秒后设备仍未就绪
7. ❌ 加载磁带失败

### 1.2 为什么DeviceID无法用于IO操作？

**DeviceID格式：**
```
SCSI\SEQUENTIAL&VEN_IBM&PROD_ULT3580-HH9\5&23894D7F&0&001800
```

这是一个**设备标识符**，用于：
- WMI查询设备信息
- 注册表查找设备配置
- 设备管理器显示

但**不能直接用于**：
- 文件系统操作（`CreateFile`）
- SCSI命令发送
- 设备IO操作

**有效的DOS设备路径格式：**
```
\\.\TAPE0
\\.\TAPE1
\\.\PHYSICALDRIVE0  (不推荐，可能误匹配硬盘)
```

### 1.3 可能的原因

1. **设备驱动未正确加载**
   - Windows未创建TAPE设备符号链接
   - 设备管理器显示设备但无法访问

2. **设备被其他进程占用**
   - 其他备份软件正在使用
   - 系统服务占用设备

3. **权限问题**
   - 运行服务的账户没有管理员权限
   - 无法访问SCSI直通接口

4. **设备物理状态**
   - 磁带未加载到驱动器
   - 设备未就绪（需要预热）
   - 设备故障

5. **路径查找逻辑问题**
   - 扫描范围不够（当前只测试TAPE0-9）
   - 大小写敏感问题
   - 设备路径不在标准位置

## 二、写入磁带所需的完整操作步骤

### 2.1 操作流程图

```
开始
  │
  ├─> 1. 初始化SCSI接口
  │     ├─> 初始化Windows SPTI
  │     └─> 加载kernel32.dll
  │
  ├─> 2. 扫描磁带设备
  │     ├─> 通过WMI查询Win32_TapeDrive
  │     ├─> 找到有效的DOS设备路径（\\.\TAPE0）
  │     └─> 验证设备类型（INQUIRY命令）
  │
  ├─> 3. 检查设备就绪
  │     ├─> TEST UNIT READY命令
  │     ├─> 如果失败，重试（最多30秒）
  │     └─> 检查设备状态（磁带是否加载）
  │
  ├─> 4. 倒带（REWIND）
  │     ├─> 发送REWIND命令（0x01）
  │     └─> 等待倒带完成
  │
  ├─> 5. 读取磁带标签（可选）
  │     ├─> 读取.TAPE_LABEL.txt文件
  │     └─> 或读取磁带头元数据
  │
  ├─> 6. 擦除磁带（如果是完整备份）
  │     ├─> 备份标签（如果存在）
  │     ├─> 倒带到开始
  │     ├─> 发送ERASE命令（0x19）
  │     ├─> 等待擦除完成
  │     └─> 写回标签（如果存在）
  │
  ├─> 7. 写入数据
  │     ├─> 循环处理每个文件/数据块：
  │     │     ├─> 压缩文件（可选）
  │     │     ├─> 分块写入：
  │     │     │     ├─> WRITE(16)命令（0x8A）
  │     │     │     ├─> 写入数据块
  │     │     │     └─> 验证写入成功
  │     │     └─> 写入文件标记（FILEMARK，0x10）
  │     └─> 同步写入（SYNCHRONIZE CACHE，0x35）
  │
  ├─> 8. 写入磁带标签（如果不存在）
  │     ├─> 倒带到开始
  │     ├─> 写入.TAPE_LABEL.txt文件
  │     └─> 或写入磁带头元数据
  │
  ├─> 9. 最终倒带
  │     └─> REWIND命令
  │
  └─> 10. 完成
        ├─> 更新数据库记录
        └─> 发送通知
```

### 2.2 详细操作步骤

#### 步骤1：初始化SCSI接口

```python
# 初始化Windows SPTI
self.kernel32 = windll.kernel32
self.create_file = self.kernel32.CreateFileW
self.device_io_control = self.kernel32.DeviceIoControl
```

#### 步骤2：找到有效的DOS设备路径

**关键步骤：**
1. 通过WMI查询`Win32_TapeDrive`
2. 尝试打开`\\.\TAPE0`到`\\.\TAPE9`
3. 发送INQUIRY命令验证设备类型（type=1为磁带）
4. 如果找到，保存路径用于后续操作

**当前问题：** 这一步失败了，导致后续所有操作无法进行。

#### 步骤3：检查设备就绪（TEST UNIT READY）

```python
# CDB: [0x00, 0x00, 0x00, 0x00, 0x00, 0x00]
# 如果设备未就绪，返回错误：
# - 0x02: NOT READY
# - 0x04: UNIT ATTENTION
```

**需要重试：**
- 等待设备预热（最多30秒）
- 检查磁带是否已加载
- 检查设备是否被占用

#### 步骤4：倒带（REWIND）

```python
# CDB: [0x01, 0x00, 0x00, 0x00, 0x00, 0x00]
# 将磁带倒回到开始位置（BOT - Beginning of Tape）
```

#### 步骤5：读取磁带标签（可选）

```python
# 如果使用LTFS文件系统：
# 1. 挂载LTFS文件系统
# 2. 读取.TAPE_LABEL.txt文件
# 3. 解析标签信息

# 如果使用原始SCSI：
# 1. 读取第一个数据块（block 0）
# 2. 解析标签元数据
```

#### 步骤6：擦除磁带（完整备份）

```python
# CDB: [0x19, 0x00, 0x00, 0x00, 0x00, 0x00]
# ERASE命令会擦除整个磁带
# 注意：需要先备份标签（如果存在）
```

#### 步骤7：写入数据

**写入单个数据块：**
```python
# WRITE(16)命令 - 支持64位LBA
cdb = bytes([
    0x8A,  # WRITE(16)
    0x00,  # 保护位
    # ... LBA地址（8字节）
    # ... 块数（4字节）
    0x00   # 控制
])
```

**写入文件标记：**
```python
# WRITE FILEMARK(16)命令
cdb = bytes([
    0x80,  # WRITE FILEMARK(16)
    0x00,  # 保护位
    0x00,  # 文件标记数高位
    0x01,  # 文件标记数低位（1个）
    # ... 其他参数
])
```

**同步写入：**
```python
# SYNCHRONIZE CACHE命令
# 确保数据真正写入到磁带
cdb = bytes([0x35, 0x00, 0x00, 0x00, 0x00, 0x00])
```

#### 步骤8：写入磁带标签

**如果使用LTFS：**
```python
# 1. 倒带到开始
# 2. 创建.TAPE_LABEL.txt文件
# 3. 写入标签信息
# 4. 设置文件属性（隐藏）
```

**如果使用原始SCSI：**
```python
# 1. 倒带到开始
# 2. 构造标签数据块
# 3. 写入第一个数据块（block 0）
```

#### 步骤9：最终倒带

```python
# REWIND命令，将磁带倒回到开始位置
# 便于下次读取
```

## 三、诊断和解决方案

### 3.1 诊断步骤

#### 1. 检查设备管理器

```powershell
# 打开设备管理器
devmgmt.msc

# 查看：
# - "磁带驱动器"下是否有IBM ULT3580-HH9
# - 设备状态是否正常（没有黄色感叹号）
# - 设备属性中是否有错误信息
```

#### 2. 检查设备路径是否存在

```powershell
# 尝试手动打开设备
# 需要管理员权限
$handle = [System.IO.File]::Open("\\\.\TAPE0", "Open", "ReadWrite")
$handle.Close()
```

#### 3. 检查设备是否被占用

```powershell
# 查看是否有其他进程使用磁带设备
Get-Process | Where-Object {$_.Path -like "*tape*"}
```

#### 4. 检查设备权限

```powershell
# 检查当前用户是否有SCSI直通权限
# 需要管理员权限才能访问SCSI设备
```

#### 5. 检查设备日志

```powershell
# 查看Windows事件查看器
eventvwr.msc

# 查看：
# - 系统日志中的SCSI相关错误
# - 应用程序日志中的磁带设备错误
```

### 3.2 解决方案

#### 方案1：修复设备路径查找

**问题：** 当前代码无法找到有效的DOS路径

**解决：**
1. 扩展扫描范围（TAPE0-9已实现）
2. 尝试从注册表查询（已实现）
3. 尝试从WMI DevicePath属性获取（已实现）
4. **新增：** 使用SetupAPI查询设备实例路径
5. **新增：** 查询所有TAPE设备，然后匹配DeviceID

#### 方案2：手动配置设备路径

**如果自动查找失败，可以：**
1. 手动在配置文件中指定设备路径
2. 通过设备管理器查看实际路径
3. 在系统设置中配置

#### 方案3：检查设备驱动

**如果设备路径不存在：**
1. 重新安装磁带设备驱动
2. 更新驱动程序
3. 检查Windows是否识别设备

#### 方案4：检查设备状态

**如果设备未就绪：**
1. 确保磁带已物理加载到驱动器
2. 等待设备预热（最多30秒）
3. 检查设备是否有错误指示灯
4. 查看设备固件状态

#### 方案5：权限问题

**如果权限不足：**
1. 确保运行服务的账户有管理员权限
2. 检查SCSI直通权限设置
3. 在Windows安全策略中允许SCSI访问

### 3.3 代码改进建议

#### 1. 增强设备路径查找

```python
async def _find_tape_device_path(self, device_id: str) -> Optional[str]:
    """查找磁带设备的DOS路径"""
    # 方法1：尝试标准路径（TAPE0-9）
    for tape_num in range(10):
        path = f"\\\\.\\TAPE{tape_num}"
        if await self._verify_tape_device(path, device_id):
            return path
    
    # 方法2：从注册表查询
    path = await self._get_dos_path_from_registry(device_id)
    if path:
        return path
    
    # 方法3：使用SetupAPI查询
    path = await self._get_path_from_setupapi(device_id)
    if path:
        return path
    
    # 方法4：扫描所有TAPE设备并匹配
    path = await self._scan_and_match_device(device_id)
    if path:
        return path
    
    return None
```

#### 2. 改进错误处理

```python
async def load_tape(self, tape_cartridge: TapeCartridge) -> bool:
    """加载磁带"""
    try:
        # 1. 检查设备路径是否有效
        if not self.scsi_interface.current_device_path:
            logger.error("未找到有效的设备路径，无法加载磁带")
            logger.error("请检查：")
            logger.error("  1. 设备驱动是否正确安装")
            logger.error("  2. 设备是否被其他进程占用")
            logger.error("  3. 运行服务的账户是否有管理员权限")
            return False
        
        # 2. 检查设备就绪
        if not await self._wait_for_tape_ready():
            logger.error("设备未就绪，可能原因：")
            logger.error("  1. 磁带未加载到驱动器")
            logger.error("  2. 设备需要预热（等待30秒）")
            logger.error("  3. 设备故障或忙")
            return False
        
        # 3. 继续后续操作...
        
    except Exception as e:
        logger.error(f"加载磁带失败: {str(e)}")
        logger.error(f"错误详情: {traceback.format_exc()}")
        return False
```

#### 3. 添加设备状态检查

```python
async def check_device_status(self) -> Dict[str, Any]:
    """检查设备状态"""
    status = {
        'device_found': False,
        'path_valid': False,
        'device_ready': False,
        'tape_loaded': False,
        'errors': []
    }
    
    # 检查设备是否找到
    devices = await self.scsi_interface.scan_tape_devices()
    if devices:
        status['device_found'] = True
        status['device_count'] = len(devices)
    
    # 检查路径是否有效
    if self.scsi_interface.current_device_path:
        status['path_valid'] = True
        status['device_path'] = self.scsi_interface.current_device_path
    
    # 检查设备就绪
    if await self.scsi_interface.test_unit_ready():
        status['device_ready'] = True
    
    # 检查磁带是否加载
    # 通过LOAD POINTER命令检查
    # ...
    
    return status
```

## 四、总结

### 4.1 当前问题

**根本原因：** 无法找到有效的DOS设备路径，导致所有SCSI操作失败

**影响：** 整个备份流程无法继续，因为无法与磁带设备通信

### 4.2 写入磁带所需的关键步骤

1. ✅ **找到有效的DOS设备路径**（当前失败）
2. ✅ **打开设备**（需要有效路径）
3. ✅ **检查设备就绪**（TEST UNIT READY）
4. ✅ **倒带**（REWIND）
5. ✅ **写入数据**（WRITE）
6. ✅ **写入文件标记**（FILEMARK）
7. ✅ **同步写入**（SYNCHRONIZE CACHE）
8. ✅ **写入标签**（可选）

### 4.3 下一步行动

1. **立即诊断：**
   - 检查设备管理器中的设备状态
   - 尝试手动打开`\\.\TAPE0`路径
   - 查看Windows事件日志

2. **代码改进：**
   - 增强设备路径查找逻辑
   - 添加更详细的错误信息
   - 实现设备状态检查功能

3. **配置检查：**
   - 确认运行服务的账户权限
   - 检查设备驱动是否正确安装
   - 确认设备未被其他进程占用

