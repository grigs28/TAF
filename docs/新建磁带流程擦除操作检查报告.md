# æ–°å»ºç£å¸¦æµç¨‹æ“¦é™¤æ“ä½œæ£€æŸ¥æŠ¥å‘Š

## æ£€æŸ¥æ—¶é—´
2025-11-10

## æ£€æŸ¥èŒƒå›´
1. `web/api/tape/crud.py` - `create_tape` å‡½æ•°
2. `web/api/scheduler.py` - `_check_and_format_tape_if_needed` å’Œ `_format_tape_and_add_to_database` å‡½æ•°
3. `utils/tape_tools.py` - `format_tape_ltfs` å’Œ `erase_tape_itdt` å‡½æ•°

## æ£€æŸ¥ç»“æœ

### âœ… æ²¡æœ‰æ˜¾å¼è°ƒç”¨æ“¦é™¤æ“ä½œ

åœ¨æ•´ä¸ªæ–°å»ºç£å¸¦æµç¨‹ä¸­ï¼Œ**æ²¡æœ‰å‘ç°ä»»ä½•æ˜¾å¼è°ƒç”¨ `erase_tape_itdt` æ–¹æ³•çš„ä»£ç **ã€‚

### ğŸ“‹ æ–°å»ºç£å¸¦æµç¨‹åˆ†æ

#### 1. ç›´æ¥åˆ›å»ºç£å¸¦ï¼ˆ`create_tape` å‡½æ•°ï¼‰

**æµç¨‹ï¼š**
1. æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦å­˜åœ¨è¯¥å·æ ‡
2. ç”Ÿæˆåºåˆ—å·ï¼ˆTPMMNNæ ¼å¼ï¼‰
3. å¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰è¯¥å·æ ‡ï¼Œè°ƒç”¨ `format_tape_ltfs` è¿›è¡Œæ ¼å¼åŒ–
4. æ ¼å¼åŒ–æ“ä½œåœ¨åå°æ‰§è¡Œ

**å…³é”®ä»£ç ä½ç½®ï¼š**
- `web/api/tape/crud.py:271` - è°ƒç”¨ `format_tape_ltfs`
- `web/api/tape/crud.py:268` - `format_tape_background` åå°ä»»åŠ¡

**æ ¼å¼åŒ–å‘½ä»¤ï¼š**
```python
format_result = await tape_tools_manager.format_tape_ltfs(
    drive_letter=drive_letter,
    volume_label=final_label,
    serial=serial_param,
    eject_after=False
)
```

**å®é™…æ‰§è¡Œçš„å‘½ä»¤ï¼š**
```
LtfsCmdFormat.exe O /N:å·æ ‡ /S:åºåˆ—å·
```

#### 2. è®¡åˆ’ä»»åŠ¡ä¸­çš„æ ¼å¼åŒ–ï¼ˆ`scheduler.py`ï¼‰

**æµç¨‹ï¼š**
1. åˆ›å»ºè®¡åˆ’ä»»åŠ¡æ—¶ï¼Œå¦‚æœå¤‡ä»½ç›®æ ‡æ˜¯ç£å¸¦ï¼Œè°ƒç”¨ `_check_and_format_tape_if_needed`
2. `_check_and_format_tape_if_needed` è°ƒç”¨ `_format_tape_and_add_to_database`
3. `_format_tape_and_add_to_database` è°ƒç”¨ `format_tape_ltfs`

**å…³é”®ä»£ç ä½ç½®ï¼š**
- `web/api/scheduler.py:243` - è°ƒç”¨ `_check_and_format_tape_if_needed`
- `web/api/scheduler.py:416` - è°ƒç”¨ `format_tape_ltfs`

### âš ï¸ LTFSæ ¼å¼åŒ–æ“ä½œçš„è¡Œä¸º

**`format_tape_ltfs` ä½¿ç”¨çš„å·¥å…·ï¼š**
- `LtfsCmdFormat.exe` - IBM LTFSæ ¼å¼åŒ–å·¥å…·

**æ ¼å¼åŒ–æ“ä½œçš„å½±å“ï¼š**
1. **ä¼šåˆ›å»ºæ–°çš„æ–‡ä»¶ç³»ç»Ÿç»“æ„** - LTFSæ–‡ä»¶ç³»ç»Ÿä¼šè¢«é‡æ–°åˆ›å»º
2. **ä¼šæ¸…é™¤æ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®** - ç°æœ‰çš„ç›®å½•ç»“æ„ã€æ–‡ä»¶ç´¢å¼•ç­‰ä¼šè¢«æ¸…é™¤
3. **å¯èƒ½ä¸ä¼šç‰©ç†æ“¦é™¤æ•°æ®å—** - å–å†³äº `LtfsCmdFormat.exe` çš„å…·ä½“å®ç°
   - å¦‚æœåªæ˜¯å¿«é€Ÿæ ¼å¼åŒ–ï¼Œæ•°æ®å—å¯èƒ½ä»ç„¶å­˜åœ¨
   - å¦‚æœåŒ…å«å®‰å…¨æ ¼å¼åŒ–é€‰é¡¹ï¼Œå¯èƒ½ä¼šç‰©ç†æ“¦é™¤æ•°æ®

**é‡è¦è¯´æ˜ï¼š**
- LTFSæ ¼å¼åŒ–æ“ä½œ**ä¼šæ¸…é™¤æ–‡ä»¶ç³»ç»Ÿç»“æ„**ï¼Œä½¿å¾—æ—§æ•°æ®æ— æ³•é€šè¿‡æ–‡ä»¶ç³»ç»Ÿè®¿é—®
- ä½†**å¯èƒ½ä¸ä¼šç‰©ç†æ“¦é™¤æ•°æ®å—**ï¼Œè¿™æ„å‘³ç€ï¼š
  - æ—§æ•°æ®å¯èƒ½ä»ç„¶å­˜åœ¨äºç£å¸¦ä¸Š
  - ä½¿ç”¨æ•°æ®æ¢å¤å·¥å…·å¯èƒ½èƒ½å¤Ÿæ¢å¤æ—§æ•°æ®
  - å¦‚æœéœ€è¦å®Œå…¨æ“¦é™¤æ•°æ®ï¼Œåº”è¯¥å…ˆæ‰§è¡Œæ“¦é™¤æ“ä½œï¼Œå†æ‰§è¡Œæ ¼å¼åŒ–

### ğŸ” æ“¦é™¤æ“ä½œçš„ä½ç½®

**`erase_tape_itdt` æ–¹æ³•å­˜åœ¨ä½†æœªè¢«è°ƒç”¨ï¼š**
- ä½ç½®ï¼š`utils/tape_tools.py:236`
- åŠŸèƒ½ï¼šä½¿ç”¨ITDTå·¥å…·æ“¦é™¤ç£å¸¦ï¼ˆå¿«é€Ÿæˆ–å®Œå…¨æ“¦é™¤ï¼‰
- è°ƒç”¨ä½ç½®ï¼š
  - `web/api/tools.py:177` - ITDTå·¥å…·APIç«¯ç‚¹ï¼ˆæ‰‹åŠ¨è°ƒç”¨ï¼‰
  - `web/api/tape/operations.py:203` - ç£å¸¦æ“ä½œAPIç«¯ç‚¹ï¼ˆæ‰‹åŠ¨è°ƒç”¨ï¼‰
- **åœ¨æ–°å»ºç£å¸¦æµç¨‹ä¸­æœªè¢«è°ƒç”¨**

### ğŸ“Š æ€»ç»“

| æ“ä½œç±»å‹ | æ˜¯å¦æ‰§è¡Œ | ä½ç½® | è¯´æ˜ |
|---------|---------|------|------|
| æ˜¾å¼æ“¦é™¤ï¼ˆ`erase_tape_itdt`ï¼‰ | âŒ å¦ | æ–°å»ºæµç¨‹ä¸­æœªè°ƒç”¨ | ä»…åœ¨æ‰‹åŠ¨æ“ä½œæ—¶è°ƒç”¨ |
| LTFSæ ¼å¼åŒ–ï¼ˆ`format_tape_ltfs`ï¼‰ | âœ… æ˜¯ | `create_tape` å’Œ `scheduler.py` | ä¼šæ¸…é™¤æ–‡ä»¶ç³»ç»Ÿç»“æ„ï¼Œä½†å¯èƒ½ä¸ç‰©ç†æ“¦é™¤æ•°æ® |

### ğŸ’¡ å»ºè®®

1. **å¦‚æœéœ€è¦å®Œå…¨æ“¦é™¤æ•°æ®ï¼š**
   - åœ¨æ ¼å¼åŒ–ä¹‹å‰å…ˆè°ƒç”¨ `erase_tape_itdt` è¿›è¡Œå®Œå…¨æ“¦é™¤
   - æˆ–è€…åœ¨æ ¼å¼åŒ–æ—¶æ·»åŠ å®‰å…¨æ ¼å¼åŒ–é€‰é¡¹ï¼ˆå¦‚æœ `LtfsCmdFormat.exe` æ”¯æŒï¼‰

2. **å¦‚æœåªæ˜¯å¿«é€Ÿæ ¼å¼åŒ–ï¼š**
   - å½“å‰çš„å®ç°å·²ç»è¶³å¤Ÿï¼Œæ ¼å¼åŒ–ä¼šæ¸…é™¤æ–‡ä»¶ç³»ç»Ÿç»“æ„
   - æ—§æ•°æ®è™½ç„¶å¯èƒ½ä»ç„¶å­˜åœ¨ï¼Œä½†æ— æ³•é€šè¿‡æ–‡ä»¶ç³»ç»Ÿè®¿é—®

3. **å®‰å…¨è€ƒè™‘ï¼š**
   - å¦‚æœç£å¸¦åŒ…å«æ•æ„Ÿæ•°æ®ï¼Œå»ºè®®å…ˆæ‰§è¡Œå®Œå…¨æ“¦é™¤æ“ä½œ
   - å¯ä»¥åœ¨ `format_tape_ltfs` ä¸­æ·»åŠ å‚æ•°ï¼Œæ”¯æŒåœ¨æ ¼å¼åŒ–å‰å…ˆæ“¦é™¤

### ğŸ”§ ä»£ç ä¿®æ”¹å»ºè®®

å¦‚æœéœ€è¦æ·»åŠ æ“¦é™¤åŠŸèƒ½ï¼Œå¯ä»¥åœ¨ `format_tape_ltfs` ä¸­æ·»åŠ å¯é€‰å‚æ•°ï¼š

```python
async def format_tape_ltfs(
    self, 
    drive_letter: Optional[str] = None, 
    volume_label: Optional[str] = None,
    serial: Optional[str] = None, 
    eject_after: bool = False,
    erase_before_format: bool = False  # æ–°å¢å‚æ•°
) -> Dict[str, Any]:
    """æ ¼å¼åŒ–ç£å¸¦ä¸ºLTFSæ ¼å¼"""
    # å¦‚æœéœ€è¦ï¼Œå…ˆæ‰§è¡Œæ“¦é™¤æ“ä½œ
    if erase_before_format:
        logger.info("æ ¼å¼åŒ–å‰å…ˆæ‰§è¡Œæ“¦é™¤æ“ä½œ...")
        erase_result = await self.erase_tape_itdt(quick=False)
        if not erase_result.get("success"):
            return {
                "success": False,
                "error": "æ“¦é™¤æ“ä½œå¤±è´¥",
                "stderr": erase_result.get("stderr", "")
            }
    
    # ç»§ç»­æ ¼å¼åŒ–æ“ä½œ...
```

## ç»“è®º

**æ–°å»ºç£å¸¦æµç¨‹ä¸­æ²¡æœ‰æ˜¾å¼è°ƒç”¨æ“¦é™¤æ“ä½œ**ã€‚æ ¼å¼åŒ–æ“ä½œä¼šæ¸…é™¤æ–‡ä»¶ç³»ç»Ÿç»“æ„ï¼Œä½†å¯èƒ½ä¸ä¼šç‰©ç†æ“¦é™¤æ•°æ®å—ã€‚å¦‚æœéœ€è¦å®Œå…¨æ“¦é™¤æ•°æ®ï¼Œå»ºè®®åœ¨æ ¼å¼åŒ–å‰å…ˆæ‰§è¡Œæ“¦é™¤æ“ä½œã€‚

