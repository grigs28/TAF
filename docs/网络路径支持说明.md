# 网络路径（UNC路径）支持说明

## 功能概述

系统现在支持备份网络路径（UNC路径），包括：

1. **自动列出共享**：当指定 `\\192.168.0.79` 时，系统会自动列出该服务器的所有共享
2. **指定共享路径**：可以直接指定 `\\192.168.0.79\yz` 来备份特定共享
3. **路径验证**：创建备份任务时会验证网络路径的可访问性

## 使用方法

### 1. 备份服务器所有共享

在创建备份任务时，使用服务器地址（不带共享名）：

```
\\192.168.0.79
```

系统会自动：
- 列出该服务器的所有磁盘共享
- 为每个共享创建备份路径
- 依次备份所有共享

### 2. 备份指定共享

直接指定共享路径：

```
\\192.168.0.79\yz
```

系统会：
- 验证该共享路径是否存在
- 直接备份该共享下的所有文件

### 3. 混合使用

可以同时指定多个路径（包括本地路径和网络路径）：

```
C:\LocalFolder
\\192.168.0.79\yz
\\192.168.0.80\backup
```

## 技术实现

### 路径处理流程

1. **路径识别**：系统自动识别 UNC 路径格式（`\\server` 或 `\\server\share`）
2. **共享枚举**：如果只指定服务器，使用 Windows API (`win32net.NetShareEnum`) 列出所有共享
3. **路径展开**：将服务器路径展开为所有共享的完整路径列表
4. **路径验证**：验证每个路径是否可访问
5. **文件扫描**：使用 `pathlib.Path` 递归扫描所有文件

### 依赖要求

- **Windows 系统**：网络共享枚举功能仅在 Windows 上支持
- **pywin32**：用于访问 Windows API（已在 requirements.txt 中）
- **网络访问权限**：需要能够访问目标服务器的共享

### 错误处理

系统会处理以下常见错误：

- **权限不足**：如果无法访问共享列表，会给出明确的错误提示
- **网络不可达**：如果服务器无法访问，会记录警告日志
- **共享不存在**：如果指定的共享不存在，会在验证阶段报错

## 注意事项

1. **网络连接**：确保备份服务器能够访问目标网络路径
2. **访问权限**：需要具有访问目标共享的权限
3. **性能考虑**：网络路径的备份速度取决于网络带宽和延迟
4. **路径格式**：建议使用反斜杠格式（`\\server\share`），系统会自动规范化

## 示例

### 示例1：备份服务器所有共享

```python
# 创建备份任务
backup_task = await backup_engine.create_backup_task(
    task_name="网络备份-192.168.0.79",
    source_paths=["\\\\192.168.0.79"],
    task_type=BackupTaskType.FULL
)
```

### 示例2：备份指定共享

```python
# 创建备份任务
backup_task = await backup_engine.create_backup_task(
    task_name="网络备份-yz共享",
    source_paths=["\\\\192.168.0.79\\yz"],
    task_type=BackupTaskType.FULL
)
```

### 示例3：混合路径

```python
# 创建备份任务
backup_task = await backup_engine.create_backup_task(
    task_name="混合备份",
    source_paths=[
        "C:\\LocalData",
        "\\\\192.168.0.79\\yz",
        "\\\\192.168.0.80\\backup"
    ],
    task_type=BackupTaskType.FULL
)
```

## 日志输出

系统会记录以下日志信息：

- 路径展开信息：`路径已展开，共 X 个路径`
- UNC 路径检测：`检测到 UNC 路径，规范化后: \\server\share`
- 共享枚举结果：`在服务器 X.X.X.X 上找到 X 个共享`
- 错误信息：详细的错误提示和警告

## 故障排除

### 问题1：无法列出共享

**可能原因**：
- 权限不足
- 网络不可达
- pywin32 未安装

**解决方法**：
- 检查网络连接
- 确认访问权限
- 安装 pywin32: `pip install pywin32`

### 问题2：路径验证失败

**可能原因**：
- 共享不存在
- 网络路径格式错误
- 访问权限不足

**解决方法**：
- 使用 Windows 资源管理器验证路径可访问性
- 检查路径格式是否正确
- 确认具有访问权限

### 问题3：文件扫描失败

**可能原因**：
- 网络中断
- 文件权限问题
- 路径格式问题

**解决方法**：
- 检查网络连接稳定性
- 确认文件访问权限
- 查看详细错误日志

