# 定时检查说明

本文档说明程序中启用的所有定时检查任务。

## 📋 定时检查概览

### 1. 计划任务调度器主循环

**位置**: `utils/scheduler/scheduler.py::TaskScheduler._scheduler_loop()`

**检查频率**: 每分钟检查一次（60秒）

**功能**:
- 检查数据库中所有启用的计划任务
- 当任务的下次执行时间到达时，自动执行任务
- 支持多种任务类型：备份、恢复、清理、健康检查、保留期检查等

**代码位置**:
```python
async def _scheduler_loop(self):
    """调度器主循环"""
    while self.running:
        try:
            current_time = datetime.now()
            
            # 检查每个任务
            for task_id, task_info in list(self.tasks.items()):
                if current_time >= task_info['next_run']:
                    # 执行任务（在后台执行，不阻塞）
                    execution_task = asyncio.create_task(task_info['execute_func']())
                    self._running_executions[task_id] = execution_task
                    # ...
            
            # 每分钟检查一次
            await asyncio.sleep(60)
```

---

### 2. 磁带状态监控循环

**位置**: `tape/tape_manager.py::TapeManager._monitoring_loop()`

**检查频率**: `TAPE_CHECK_INTERVAL`（默认：3600秒 = 1小时）

**配置项**: `config/settings.py::TAPE_CHECK_INTERVAL: int = 3600`

**功能**:
- 检查当前磁带的状态
- 监控磁带容量使用率
- 当容量使用率超过90%时，发送钉钉容量预警通知

**代码位置**:
```python
async def _monitoring_loop(self):
    """磁带监控循环"""
    while self._initialized:
        try:
            # 检查磁带状态
            if self.current_tape:
                tape_info = await self.get_tape_info()
                if tape_info:
                    # 检查容量预警
                    usage_percent = tape_info['usage_percent']
                    if usage_percent > 90:
                        # 发送容量预警通知
                        # ...
            
            # 等待下次检查
            await asyncio.sleep(self.settings.TAPE_CHECK_INTERVAL)
```

**启动条件**: 
- 仅在 `TAPE_CHECK_INTERVAL > 0` 时启动
- 在 `TapeManager.initialize()` 时自动启动

---

### 3. 系统默认计划任务

**位置**: `utils/scheduler/scheduler.py::BackupScheduler._register_default_tasks()`

**注意**: 这些是旧版调度器的默认任务，当前系统主要使用 `TaskScheduler`（从数据库加载任务）

#### 3.1 月度备份任务

**状态**: ⚠️ **已废弃**

**原因**: 
- 计划任务的执行时间由用户在Web界面设置时确定
- 不再使用默认配置的Cron表达式
- 用户可以通过Web界面创建计划任务，设置自定义的Cron表达式

**配置项**: `config/settings.py::MONTHLY_BACKUP_CRON`（已废弃，仅作参考）

**功能**: 执行月度完整备份任务（通过Web界面创建的计划任务实现）

**代码位置**: `utils/scheduler/scheduler.py::_execute_monthly_backup()`（已注释）

---

#### 3.2 保留期检查任务

**状态**: ⚠️ **已取消定时执行**

**原因**: 
- 备份开始前已经检查了保留期
- 改为在打开磁带管理页面时检查一次

**触发方式**: 
- 访问 `http://192.168.0.28:8081/tape` 时自动触发
- API接口: `GET /api/tape/list` 会自动执行保留期检查

**功能**: 
- 检查磁带保留期
- 标记过期磁带
- 如果 `AUTO_ERASE_EXPIRED=True`，自动擦除过期磁带

**代码位置**: 
- `web/api/tape/crud.py::list_tapes()` - 在获取磁带列表时调用
- `tape/tape_manager.py::check_retention_periods()` - 执行保留期检查

---

#### 3.3 系统健康检查任务

**Cron表达式**: `"0 */6 * * *"`（每6小时执行一次）

**功能**: 
- 检查数据库健康状态
- 检查磁带驱动器健康状态
- 检查磁盘空间（剩余空间需大于10%）
- 检查各项服务健康状态
- 发现异常时发送钉钉通知

**代码位置**: `utils/scheduler/scheduler.py::_execute_health_check()`

**检查项**:
- `_check_database_health()`: 数据库连接健康检查
- `_check_tape_drive_health()`: 磁带驱动器健康检查
- `_check_disk_space()`: 磁盘空间检查
- `_check_services_health()`: 服务健康检查

---

### 4. 计划任务动作处理器

**位置**: `utils/scheduler/action_handlers.py`

系统支持以下类型的计划任务，可通过Web界面创建和配置：

#### 4.1 备份任务（BACKUP）

**处理器**: `BackupActionHandler`

**功能**: 执行备份操作

**检查项**:
- 检查任务是否重复执行（按周期：日/周/月/年）
- 检查任务是否正在运行
- 检查备份目标路径和参数

---

#### 4.2 恢复任务（RECOVERY）

**处理器**: `RecoveryActionHandler`

**功能**: 执行恢复操作

---

#### 4.3 清理任务（CLEANUP）

**处理器**: `CleanupActionHandler`

**功能**: 执行清理操作

---

#### 4.4 健康检查任务（HEALTH_CHECK）

**处理器**: `HealthCheckActionHandler`

**功能**: 执行系统健康检查

**当前实现**: 返回成功状态（具体检查逻辑待实现）

---

#### 4.5 保留期检查任务（RETENTION_CHECK）

**处理器**: `RetentionCheckActionHandler`

**功能**: 检查磁带保留期

**当前实现**: 返回成功状态（具体检查逻辑待实现）

---

## ⚙️ 配置项汇总

| 配置项 | 默认值 | 说明 | 位置 |
|--------|--------|------|------|
| `SCHEDULER_ENABLED` | `True` | 是否启用计划任务调度器 | `config/settings.py` |
| `TAPE_CHECK_INTERVAL` | `3600` | 磁带状态检查间隔（秒） | `config/settings.py` |
| `HEALTH_CHECK_INTERVAL` | `300` | 健康检查间隔（秒，5分钟） | `config/settings.py` |
| `MONTHLY_BACKUP_CRON` | `"0 2 1 * *"` | 月度备份Cron表达式 | `config/settings.py` |
| `RETENTION_CHECK_CRON` | `"0 3 * * *"` | 保留期检查Cron表达式 | `config/settings.py` |
| `AUTO_ERASE_EXPIRED` | `True` | 是否自动擦除过期磁带 | `config/settings.py` |

---

## 🔄 定时检查流程图

```
系统启动
    │
    ├─> 初始化 TaskScheduler
    │   └─> 从数据库加载计划任务
    │       └─> 启动调度器主循环（每分钟检查一次）
    │
    ├─> 初始化 TapeManager
    │   └─> 启动磁带监控循环（每1小时检查一次）
    │
    └─> 启动Web服务
```

---

## 📝 注意事项

1. **调度器主循环**: 每分钟检查一次，这是最频繁的定时检查
2. **磁带监控循环**: 每小时检查一次，主要用于容量预警
3. **计划任务**: 所有计划任务都通过调度器主循环触发，执行频率由用户在Web界面创建任务时设置的Cron表达式决定
4. **保留期检查**: 已取消定时执行，改为在打开磁带管理页面时检查一次（`GET /api/tape/list`）
5. **健康检查间隔配置**: `HEALTH_CHECK_INTERVAL` 配置项当前未被使用，健康检查通过计划任务实现
6. **任务持久化**: 所有计划任务都存储在数据库中，系统重启后会自动加载
7. **默认任务**: `BackupScheduler` 的默认任务注册已废弃，所有任务通过Web界面创建

---

## 🛠️ 如何添加新的定时检查

1. **通过Web界面创建计划任务**:
   - 访问计划任务管理页面
   - 创建新任务，选择动作类型和Cron表达式
   - 任务会自动加入调度器

2. **在代码中添加新的动作处理器**:
   - 在 `utils/scheduler/action_handlers.py` 中添加新的处理器类
   - 在 `get_action_handler()` 函数中注册新处理器
   - 在 `models/scheduled_task.py` 中添加新的动作类型（如需要）

---

## 📊 检查频率总结

| 检查类型 | 频率 | 说明 |
|---------|------|------|
| 调度器主循环 | 每分钟 | 检查所有计划任务是否到达执行时间 |
| 磁带状态监控 | 每小时 | 检查当前磁带状态和容量预警 |
| 计划任务备份 | 按用户设置 | 用户在Web界面创建计划任务时设置Cron表达式 |
| 保留期检查 | 页面打开时 | 打开磁带管理页面（`/tape`）时检查一次 |
| 健康检查 | 每6小时 | 每6小时执行一次系统健康检查 |

---

**最后更新**: 2024-12-19

