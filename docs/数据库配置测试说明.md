# 数据库配置功能测试说明

## 测试环境准备

1. 确保系统已安装并运行
2. 访问 http://localhost:8080/system
3. 点击"数据库"选项卡

## 测试用例

### 1. 获取当前数据库配置

**操作步骤**：
- 打开系统设置页面的数据库选项卡
- 观察界面是否正确加载当前配置

**预期结果**：
- 数据库类型、连接参数、连接池配置正确显示
- 连接状态正常显示

### 2. 测试SQLite连接

**操作步骤**：
1. 选择"SQLite"作为数据库类型
2. 输入数据库路径：`./test_backup_system.db`
3. 点击"测试连接"按钮

**预期结果**：
- 显示"数据库连接测试成功！"
- SQLite数据库文件自动创建

### 3. 测试openGauss/PostgreSQL连接

**操作步骤**：
1. 选择"openGauss"或"PostgreSQL"作为数据库类型
2. 填写连接信息：
   - 主机：192.168.0.20
   - 端口：5560
   - 数据库：taf_codex_1
   - 用户名：grigs
   - 密码：Slnwg123$
3. 点击"测试连接"按钮

**预期结果**：
- 显示"数据库连接测试成功！"
- 连接状态更新为"已连接"

### 4. 测试连接失败处理

**操作步骤**：
1. 选择"openGauss"作为数据库类型
2. 填写错误的连接信息：
   - 主机：192.168.0.999（不存在的地址）
   - 其他参数正常
3. 点击"测试连接"按钮

**预期结果**：
- 显示错误提示信息
- 连接状态不更新

### 5. 保存配置

**操作步骤**：
1. 完成正确的数据库配置
2. 点击"保存配置"按钮

**预期结果**：
- 显示"数据库配置更新成功，需要重启系统生效"
- `.env` 文件中的配置已更新
- 配置信息正确保存

### 6. 配置切换测试

**操作步骤**：
1. 在SQLite和其他数据库类型之间切换
2. 观察配置表单是否正确切换

**预期结果**：
- SQLite显示路径输入框
- 其他类型显示主机、端口、用户等输入框
- 表单切换流畅无错误

### 7. 实时状态更新

**操作步骤**：
1. 切换到数据库选项卡
2. 等待30秒
3. 观察连接状态是否自动刷新

**预期结果**：
- 状态指示器正确显示（绿/红/黄）
- 状态文本正确更新
- 连接池信息正确显示

## API接口测试

### 1. 获取数据库配置

```bash
curl http://localhost:8080/api/system/database/config
```

**预期响应**：
```json
{
    "db_type": "opengauss",
    "db_host": "192.168.0.20",
    "db_port": 5560,
    "db_user": "grigs",
    "db_database": "taf_codex_1",
    "pool_size": 10,
    "max_overflow": 20
}
```

### 2. 测试数据库连接

```bash
curl -X POST http://localhost:8080/api/system/database/test \
  -H "Content-Type: application/json" \
  -d '{
    "db_type": "sqlite",
    "db_path": "./test.db",
    "pool_size": 10,
    "max_overflow": 20
  }'
```

**预期响应**：
```json
{
    "success": true,
    "message": "数据库连接测试成功",
    "db_type": "sqlite"
}
```

### 3. 获取数据库状态

```bash
curl http://localhost:8080/api/system/database/status
```

**预期响应**：
```json
{
    "status": "online",
    "db_type": "openGauss",
    "pool_size": 10,
    "max_overflow": 20
}
```

## 兼容性测试

### 数据库类型切换

测试在不同数据库类型之间切换时：
1. 配置是否正确保留
2. 表单是否正常切换
3. 是否有数据残留

### 浏览器兼容性

测试在以下浏览器中是否正常工作：
- Chrome/Edge（最新版本）
- Firefox（最新版本）
- Safari（如适用）

## 性能测试

1. **响应速度**：配置加载、测试连接、保存配置应在2秒内完成
2. **并发测试**：多个用户同时访问配置页面
3. **长时间运行**：状态自动刷新不出现内存泄漏

## 安全性测试

1. **密码加密**：界面中密码字段不显示明文
2. **配置验证**：输入验证防止恶意输入
3. **错误处理**：错误信息不泄露敏感信息

## 故障排除

### 常见问题

1. **配置不生效**
   - 检查是否重启系统
   - 检查 `.env` 文件是否正确写入
   - 查看系统日志

2. **测试连接失败**
   - 检查数据库服务是否运行
   - 检查网络连接
   - 验证用户名密码
   - 查看详细错误信息

3. **界面加载失败**
   - 检查浏览器控制台错误
   - 检查网络请求是否成功
   - 确认API服务正常运行

## 测试检查清单

- [ ] 获取数据库配置API正常工作
- [ ] SQLite连接测试成功
- [ ] PostgreSQL连接测试成功
- [ ] openGauss连接测试成功
- [ ] MySQL连接测试成功（如支持）
- [ ] 连接失败错误处理正确
- [ ] 配置保存功能正常
- [ ] 配置切换流畅
- [ ] 实时状态更新正常
- [ ] 密码字段正确加密
- [ ] 配置验证正常工作
- [ ] 浏览器兼容性良好
- [ ] 性能满足要求
- [ ] 文档完整准确

---

**企业级磁带备份系统**
版本：v1.0.0
更新时间：2024-11-01

