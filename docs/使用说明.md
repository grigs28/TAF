# 企业级磁带备份系统 - 使用说明
Enterprise Tape Backup System - User Guide

## 🚀 快速启动

### 1. 环境准备

确保您已安装：
- Python 3.8+
- conda 环境
- openGauss 数据库（可选，用于完整功能）

### 2. 安装依赖

```bash
# 激活conda环境
conda activate taf

# 安装依赖包
pip install -r requirements.txt
```

### 3. 启动系统

```bash
# 使用主程序启动系统
python main.py
```

### 4. 访问系统

打开浏览器访问：http://localhost:8080

## 📊 系统功能

### 核心特性

1. **🔄 6个月循环备份体系**
   - 每月自动执行完整备份
   - 保持6个活跃备份组循环
   - 第7个月自动清理最旧备份组

2. **💾 多策略备份**
   - 完整备份 (Full Backup)
   - 增量备份 (Incremental Backup)
   - 差异备份 (Differential Backup)
   - 月度备份 (Monthly Backup)

3. **🗜️ 7-Zip SDK压缩**
   - SDK级别集成（非命令行）
   - 单包不超过3GB
   - LZMA2算法，最大压缩率
   - 智能分包压缩

4. **📼 磁带生命周期管理**
   - 磁带存活期配置（默认6个月）
   - 自动标记过期磁带
   - 备份前自动擦除过期磁带
   - 擦除后重新投入备份池

5. **🌐 Web管理界面**
   - 现代化中文界面
   - 实时进度监控
   - 备份任务管理
   - 恢复操作界面
   - 磁带库存监控

6. **📱 钉钉通知集成**
   - 备份成功/失败通知
   - 磁带更换提醒
   - 系统异常告警
   - 容量阈值预警

## 🔧 配置说明

### 环境变量配置 (.env)

```bash
# 数据库配置
DATABASE_URL=opengauss://grigs:Slnwg123$@192.168.0.20:5560/taf_cursor
DB_POOL_SIZE=10
DB_MAX_OVERFLOW=20

# 磁带配置
TAPE_DRIVE_LETTER=o
DEFAULT_BLOCK_SIZE=262144
MAX_VOLUME_SIZE=322122547200

# 压缩配置
COMPRESSION_LEVEL=9
MAX_FILE_SIZE=3221225472

# 钉钉通知配置
DINGTALK_API_URL=http://192.168.0.20:5555
DINGTALK_API_KEY=sk-dingtalk-api-2024-001
DINGTALK_DEFAULT_PHONE=13293513336

# 系统配置
DEFAULT_RETENTION_MONTHS=6
AUTO_ERASE_EXPIRED=true
WEB_PORT=8080
```

### 数据库配置

系统支持 openGauss 数据库：

```sql
-- 创建数据库
CREATE DATABASE taf_codex_1;

-- 创建用户
CREATE USER grigs WITH PASSWORD 'Slnwg123$';

-- 授权
GRANT ALL PRIVILEGES ON DATABASE taf_codex_1 TO grigs;
```

## 📡 API接口

### 健康检查
```bash
GET http://localhost:8080/api/health
```

### 系统信息
```bash
GET http://localhost:8080/api/info
```

### 备份管理
```bash
# 创建备份任务
POST http://localhost:8080/api/backup/tasks

# 获取任务列表
GET http://localhost:8080/api/backup/tasks

# 获取任务状态
GET http://localhost:8080/api/backup/tasks/{task_id}
```

### 磁带管理
```bash
# 获取磁带库存
GET http://localhost:8080/api/tape/inventory

# 获取当前磁带信息
GET http://localhost:8080/api/tape/current

# 加载磁带
POST http://localhost:8080/api/tape/load
```

## 🖥️ Web界面功能

### 1. 首页仪表板
- 系统状态概览
- 备份任务统计
- 磁带使用情况
- 最近操作记录

### 2. 备份管理页面
- 新建备份任务
- 实时进度监控
- 任务历史记录
- 备份统计信息

### 3. 恢复管理页面
- 备份集时间轴浏览
- 文件树目录结构
- 文件搜索功能
- 批量恢复操作

### 4. 磁带管理页面
- 磁带库存状态
- 健康度指标展示
- 存活期配置
- 手动擦除操作

### 5. 系统设置页面
- 钉钉API配置
- 接收人员管理
- 版本信息显示
- 系统参数配置

## 🗂️ 目录结构

```
d:\app\TAF claude1\
├── main.py                 # 主程序入口
├── main_simple.py          # 简化启动版本
├── requirements.txt        # 项目依赖
├── .env                    # 环境配置
├── config/                 # 配置管理
├── models/                 # 数据模型
├── backup/                 # 备份处理
├── recovery/               # 恢复处理
├── tape/                   # 磁带驱动
├── web/                    # Web界面
├── utils/                  # 工具类
├── mcp/                    # 核心备份模块
├── tests/                  # 测试程序
├── docs/                   # 文档目录
└── logs/                   # 日志目录
```

## 🧪 测试

运行测试套件：

```bash
# 运行所有测试
pytest

# 运行特定模块测试
pytest tests/test_config.py
pytest tests/test_backup.py
pytest tests/test_tape.py

# 生成覆盖率报告
pytest --cov=.
```

## 📝 日志管理

系统日志位置：
- 应用日志：`logs/application.log`
- 错误日志：`logs/error.log`
- 系统日志：控制台输出

日志级别：
- DEBUG：详细调试信息
- INFO：一般信息
- WARNING：警告信息
- ERROR：错误信息
- CRITICAL：严重错误

## 🔍 故障排除

### 常见问题

1. **依赖安装失败**
   ```bash
   # 清理pip缓存
   pip cache purge

   # 重新安装
   pip install -r requirements.txt --force-reinstall
   ```

2. **数据库连接失败**
   - 检查openGauss服务状态
   - 验证连接参数
   - 确认网络连通性

3. **磁带设备无法识别**
   - 检查SCSI驱动器状态
   - 确认设备权限
   - 验证设备路径

4. **Web服务启动失败**
   ```bash
   # 检查端口占用
   netstat -ano | findstr :8080

   # 更换端口
   # 修改.env文件中的WEB_PORT=8081
   ```

5. **压缩失败**
   - 检查临时目录权限
   - 确认磁盘空间充足
   - 验证文件访问权限

### 系统监控

```bash
# 检查系统状态
curl http://localhost:8080/api/health

# 查看系统信息
curl http://localhost:8080/api/info

# 检查日志
tail -f logs/application.log
```

## 🚨 安全注意事项

1. **密码安全**
   - 修改默认密码
   - 使用强密码策略
   - 定期更换密码

2. **网络安全**
   - 限制访问IP
   - 使用HTTPS（生产环境）
   - 配置防火墙规则

3. **数据安全**
   - 启用数据加密
   - 定期备份数据库
   - 监控异常访问

## 📞 技术支持

如遇到问题，请：

1. 查看系统日志
2. 检查配置文件
3. 运行诊断脚本
4. 联系技术支持

---

**企业级磁带备份系统**
版本：v1.0.0
更新时间：2024-10-31

启动命令：`conda activate taf ; python main.py`
访问地址：http://localhost:8080