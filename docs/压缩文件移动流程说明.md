# å‹ç¼©æ–‡ä»¶ç§»åŠ¨æµç¨‹è¯´æ˜

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†ä¼ä¸šçº§ç£å¸¦å¤‡ä»½ç³»ç»Ÿä¸­å‹ç¼©æ–‡ä»¶çš„ç§»åŠ¨æµç¨‹ï¼ŒåŒ…æ‹¬ä»å‹ç¼©å®Œæˆåˆ°ç§»åŠ¨åˆ°ç£å¸¦æœºçš„å®Œæ•´è¿‡ç¨‹ã€‚

## æµç¨‹æ¶æ„

### é…ç½®æ§åˆ¶

é€šè¿‡ `COMPRESS_DIRECTLY_TO_TAPE` é…ç½®é¡¹æ§åˆ¶æ–‡ä»¶ç§»åŠ¨æµç¨‹ï¼š

```python
# config/settings.py
COMPRESS_DIRECTLY_TO_TAPE: bool = True  # æ˜¯å¦ç›´æ¥å‹ç¼©åˆ°ç£å¸¦æœºï¼ˆé»˜è®¤Trueï¼Œè·³è¿‡temp/finalç›®å½•ï¼‰
```

## ä¸¤ç§æµç¨‹æ¨¡å¼

### æ¨¡å¼1ï¼šç›´æ¥å‹ç¼©åˆ°ç£å¸¦æœºï¼ˆé»˜è®¤ï¼‰

**é…ç½®**: `COMPRESS_DIRECTLY_TO_TAPE = True`

**æµç¨‹**:
1. ç›´æ¥å‹ç¼©åˆ°ç£å¸¦æœºç›˜ç¬¦ï¼ˆå¦‚Oç›˜ï¼‰
2. è·³è¿‡tempå’Œfinalç›®å½•
3. å‹ç¼©å®Œæˆå³å­˜å‚¨åœ¨ç£å¸¦ä¸Š

**ä»£ç ä½ç½®**: `backup/compressor.py:790-796`

```python
if compress_directly_to_tape:
    # ç›´æ¥å‹ç¼©åˆ°ç£å¸¦æœºï¼ˆOç›˜ï¼‰ï¼Œä½†ä¸´æ—¶å·¥ä½œç›®å½•ä»åœ¨tempç›®å½•ä¸­ï¼ˆä¸åœ¨Oç›˜åˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼‰
    tape_drive = self.settings.TAPE_DRIVE_LETTER.upper() + ":\\"
    backup_dir = Path(tape_drive) / backup_set.set_id
    backup_dir.mkdir(parents=True, exist_ok=True)
    logger.info(f"ç›´æ¥å‹ç¼©åˆ°ç£å¸¦æœº: {backup_dir}ï¼Œä¸´æ—¶å·¥ä½œç›®å½•: {temp_dir}")
    # ç›´æ¥å‹ç¼©åˆ°ç£å¸¦æ—¶ï¼Œä¸éœ€è¦final_dir
    final_dir = None
```

### æ¨¡å¼2ï¼šé€šè¿‡Finalç›®å½•ç§»åŠ¨

**é…ç½®**: `COMPRESS_DIRECTLY_TO_TAPE = False`

**æµç¨‹**:
1. å‹ç¼©æ–‡ä»¶åˆ° `temp/compress/temp/{backup_set.set_id}/`
2. ç§»åŠ¨å‹ç¼©æ–‡ä»¶åˆ° `temp/compress/final/{backup_set.set_id}/`
3. å°†finalç›®å½•ä¸­çš„æ–‡ä»¶åŠ å…¥ç§»åŠ¨é˜Ÿåˆ—
4. é¡ºåºç§»åŠ¨æ–‡ä»¶åˆ°ç£å¸¦æœº

**ä»£ç ä½ç½®**: `backup/compressor.py:801-806`

```python
else:
    # å…ˆå‹ç¼©åˆ°tempç›®å½•ï¼Œå†ç§»åŠ¨åˆ°finalç›®å½•ï¼ˆåŸæœ‰æµç¨‹ï¼‰
    # finalç›®å½•ï¼šå‹ç¼©å®Œæˆåç§»åŠ¨åˆ°è¿™é‡Œï¼Œç­‰å¾…ç§»åŠ¨åˆ°ç£å¸¦æœº
    final_dir = compress_dir / "final" / backup_set.set_id
    final_dir.mkdir(parents=True, exist_ok=True)

    # å‹ç¼©æ—¶ä½¿ç”¨tempç›®å½•
    backup_dir = temp_dir
    logger.info(f"å‹ç¼©åˆ°ä¸´æ—¶ç›®å½•: {backup_dir}ï¼Œå®Œæˆåå°†ç§»åŠ¨åˆ°: {final_dir}")
```

## è¯¦ç»†æµç¨‹è¯´æ˜

### 1. æ–‡ä»¶åˆ†ç»„ä¸å‹ç¼©

**ä½ç½®**: `backup/compressor.py:557-660`

```python
async def group_files_for_compression(self, file_list: List[Dict]) -> List[List[Dict]]:
    """å°†æ–‡ä»¶åˆ†ç»„ä»¥è¿›è¡Œå‹ç¼©
    å•ä¸ªå‹ç¼©åŒ…çš„æœ€å¤§å¤§å°ä» config è·å–ï¼ˆMAX_FILE_SIZEï¼‰
    """
```

### 2. å‹ç¼©æ‰§è¡Œ

**ä½ç½®**: `backup/compressor.py:662-1078`

æ”¯æŒä¸‰ç§å‹ç¼©æ–¹æ³•ï¼š
- `7zip_command`: 7-Zipå‘½ä»¤è¡Œå·¥å…·ï¼ˆæ¨èï¼‰
- `pgzip`: PGZipå¤šçº¿ç¨‹å‹ç¼©
- `py7zr`: py7zråº“å‹ç¼©

### 3. Finalç›®å½•ç§»åŠ¨ï¼ˆæ¨¡å¼2ï¼‰

**ä½ç½®**: `backup/compressor.py:1013-1036`

```python
# å‹ç¼©å®Œæˆï¼Œå°†æ–‡ä»¶ä»tempç›®å½•ç§»åŠ¨åˆ°finalç›®å½•
if final_dir is None:
    # å¦‚æœfinal_diræœªå®šä¹‰ï¼Œè¯´æ˜é…ç½®æœ‰é—®é¢˜ï¼Œä½¿ç”¨tempç›®å½•
    logger.warning("final_diræœªå®šä¹‰ï¼Œä½¿ç”¨tempç›®å½•ä¸­çš„æ–‡ä»¶")
    final_archive_path = temp_archive_path
else:
    final_archive_path = final_dir / temp_archive_path.name
    try:
        logger.info(f"å‹ç¼©å®Œæˆï¼Œç§»åŠ¨æ–‡ä»¶åˆ°æ­£å¼ç›®å½•: {temp_archive_path.name}")
        shutil.move(str(temp_archive_path), str(final_archive_path))
        logger.info(f"æ–‡ä»¶å·²ç§»åŠ¨åˆ°æ­£å¼ç›®å½•: {final_archive_path}")

        # è®°å½•å…³é”®é˜¶æ®µï¼šæ–‡ä»¶ç§»åŠ¨åˆ°finalç›®å½•
        if backup_task:
            from backup.backup_db import BackupDB
            backup_db = BackupDB()
            backup_db._log_operation_stage_event(
                backup_task,
                f"[æ–‡ä»¶å·²ç§»åŠ¨åˆ°æ­£å¼ç›®å½•] {final_archive_path.name}ï¼Œå¤§å°: {format_bytes(final_archive_path.stat().st_size)}"
            )
    except Exception as move_error:
        logger.error(f"ç§»åŠ¨æ–‡ä»¶åˆ°æ­£å¼ç›®å½•å¤±è´¥: {str(move_error)}")
        # å¦‚æœç§»åŠ¨å¤±è´¥ï¼Œä½¿ç”¨tempç›®å½•ä¸­çš„æ–‡ä»¶è·¯å¾„
        final_archive_path = temp_archive_path
```

### 4. è¿”å›å‹ç¼©ä¿¡æ¯

**ä½ç½®**: `backup/compressor.py:1047-1057`

```python
compressed_info = {
    'path': str(final_archive_path.absolute()),  # ä½¿ç”¨finalç›®å½•ä¸­çš„ç»å¯¹è·¯å¾„
    'compressed_size': compressed_size,
    'original_size': compress_result['successful_original_size'] or total_original_size,
    'successful_files': successful_file_count,  # æˆåŠŸå‹ç¼©çš„æ–‡ä»¶æ•°
    'failed_files': 0,  # å¤±è´¥çš„æ–‡ä»¶æ•°ï¼ˆæ— æ³•ç²¾ç¡®ç»Ÿè®¡ï¼Œè®¾ä¸º0ï¼‰
    'checksum': checksum,
    'compression_enabled': compression_enabled,
    'compression_level': compression_level if compression_enabled else None,
    'compression_threads': compression_threads if compression_enabled else None
}
```

### 5. åŠ å…¥ç§»åŠ¨é˜Ÿåˆ—ï¼ˆæ¨¡å¼2ï¼‰

**ä½ç½®**: `backup/backup_engine.py:1127-1173`

```python
else:
    # å°†æ–‡ä»¶åŠ å…¥ç§»åŠ¨é˜Ÿåˆ—ï¼Œç”±åå°çº¿ç¨‹é¡ºåºç§»åŠ¨åˆ°ç£å¸¦æœº
    # å®šä¹‰å›è°ƒå‡½æ•°ï¼Œåœ¨ç§»åŠ¨å®Œæˆåè®°å½•æ—¥å¿—ï¼ˆæ•°æ®åº“å·²åœ¨ä¿å­˜æ—¶è®°å½•ï¼‰
    def move_callback(source_path: str, tape_file_path: Optional[str], success: bool, error: Optional[str]):
        """æ–‡ä»¶ç§»åŠ¨å®Œæˆåçš„å›è°ƒå‡½æ•°"""
        if success and tape_file_path:
            logger.info(f"æ–‡ä»¶å·²æˆåŠŸç§»åŠ¨åˆ°ç£å¸¦æœº: {tape_file_path}")
            # è®°å½•å…³é”®é˜¶æ®µï¼šæ–‡ä»¶å·²ç§»åŠ¨åˆ°ç£å¸¦æœº
            self.backup_db._log_operation_stage_event(
                backup_task,
                f"[æ–‡ä»¶å·²ç§»åŠ¨åˆ°ç£å¸¦æœº] {Path(tape_file_path).name} (æ–‡ä»¶ç»„ {current_group_idx + 1})"
            )
        elif not success:
            logger.error(f"æ–‡ä»¶ç§»åŠ¨åˆ°ç£å¸¦æœºå¤±è´¥: {source_path}, é”™è¯¯: {error}")
            # è®°å½•å…³é”®é˜¶æ®µï¼šç§»åŠ¨å¤±è´¥
            self.backup_db._log_operation_stage_event(
                backup_task,
                f"[ç§»åŠ¨åˆ°ç£å¸¦æœºå¤±è´¥] æ–‡ä»¶ç»„ {current_group_idx + 1}ï¼Œé”™è¯¯: {error}"
            )

    # å°†æ–‡ä»¶åŠ å…¥ç§»åŠ¨é˜Ÿåˆ—
    if self.tape_file_mover:
        from pathlib import Path
        file_path_check = Path(compressed_file['path'])
        logger.info(f"å‡†å¤‡å°†æ–‡ä»¶åŠ å…¥ç§»åŠ¨é˜Ÿåˆ—: {compressed_file['path']} (å­˜åœ¨: {file_path_check.exists()})")

        added = self.tape_file_mover.add_file(
            compressed_file['path'],  # è¿™é‡Œå·²ç»æ˜¯finalç›®å½•ä¸­çš„è·¯å¾„
            backup_set,
            current_group_idx,
            callback=move_callback
        )
```

## ç£å¸¦æœºé¡ºåºç§»åŠ¨æœºåˆ¶

### TapeFileMoverç±»

**ä½ç½®**: `backup/tape_file_mover.py`

**æ ¸å¿ƒç‰¹æ€§**:
1. **é˜Ÿåˆ—ç®¡ç†**: ä½¿ç”¨`Queue`ç®¡ç†ç§»åŠ¨ä»»åŠ¡
2. **å•çº¿ç¨‹æ‰§è¡Œ**: ç¡®ä¿ç£å¸¦æœºæ“ä½œä¸²è¡ŒåŒ–
3. **å¼‚æ­¥å›è°ƒ**: æ”¯æŒç§»åŠ¨å®Œæˆåçš„å›è°ƒå¤„ç†
4. **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶

**åˆå§‹åŒ–**: `backup/backup_engine.py:116-122`

```python
# åˆå§‹åŒ–æ–‡ä»¶ç§»åŠ¨é˜Ÿåˆ—ç®¡ç†å™¨
self.tape_file_mover = TapeFileMover(
    tape_handler=self.tape_handler,
    settings=self.settings
)
self.tape_file_mover.start()
logger.info("æ–‡ä»¶ç§»åŠ¨é˜Ÿåˆ—ç®¡ç†å™¨å·²å¯åŠ¨")
```

**ç§»åŠ¨ä»»åŠ¡æ•°æ®ç»“æ„**:

```python
@dataclass
class MoveTask:
    """ç§»åŠ¨ä»»åŠ¡"""
    source_path: str  # æºæ–‡ä»¶è·¯å¾„ï¼ˆfinalç›®å½•ä¸­çš„æ–‡ä»¶ï¼‰
    backup_set: BackupSet  # å¤‡ä»½é›†å¯¹è±¡
    group_idx: int  # ç»„ç´¢å¼•
    callback: Optional[Callable] = None  # ç§»åŠ¨å®Œæˆåçš„å›è°ƒå‡½æ•°
```

**å·¥ä½œæµç¨‹**:

1. **æ·»åŠ ä»»åŠ¡**: `add_file()` å°†æ–‡ä»¶åŠ å…¥é˜Ÿåˆ—
2. **å·¥ä½œçº¿ç¨‹**: `_worker_loop()` å•çº¿ç¨‹å¤„ç†é˜Ÿåˆ—
3. **æ‰§è¡Œç§»åŠ¨**: `_process_move_task()` è°ƒç”¨`tape_handler.write_to_tape_drive()`

```python
def add_file(self, source_path: str, backup_set: BackupSet, group_idx: int,
             callback: Optional[Callable] = None) -> bool:
    """æ·»åŠ æ–‡ä»¶åˆ°ç§»åŠ¨é˜Ÿåˆ—"""

    task = MoveTask(
        source_path=source_path,
        backup_set=backup_set,
        group_idx=group_idx,
        callback=callback
    )

    self._queue.put(task)
    logger.info(f"æ–‡ä»¶å·²åŠ å…¥ç§»åŠ¨é˜Ÿåˆ—: {source_file.name} (é˜Ÿåˆ—å¤§å°: {self._queue.qsize()})")
    return True
```

### TapeHandlerç±»

**ä½ç½®**: `backup/tape_handler.py`

**write_to_tape_driveæ–¹æ³•**:

```python
async def write_to_tape_drive(self, source_path: str, backup_set: BackupSet, group_idx: int) -> Optional[str]:
    """å°†å‹ç¼©æ–‡ä»¶ä»æœ¬åœ°ç›®å½•å¤åˆ¶åˆ°ç£å¸¦æœºï¼ˆLTFSæŒ‚è½½çš„ç›˜ç¬¦ï¼‰

    æµç¨‹ï¼š
    1. å…ˆå¤åˆ¶æ–‡ä»¶åˆ°ç£å¸¦ç›˜ç¬¦ï¼ˆé€šè¿‡LTFSæŒ‚è½½ï¼‰
    2. éªŒè¯å¤åˆ¶æˆåŠŸï¼ˆæ£€æŸ¥æ–‡ä»¶å¤§å°ï¼‰
    3. ç¡®è®¤æˆåŠŸåå†åˆ é™¤æºæ–‡ä»¶
    """
```

## å…³é”®ç‰¹æ€§æ€»ç»“

### 1. è·¯å¾„ä¼ é€’æ­£ç¡®æ€§ âœ…

- **Finalç›®å½•è·¯å¾„**: `compressed_info['path']` è¿”å›finalç›®å½•ä¸­çš„ç»å¯¹è·¯å¾„
- **é˜Ÿåˆ—ä¼ é€’**: `compressed_file['path']` æ­£ç¡®ä¼ é€’ç»™ `tape_file_mover.add_file()`
- **ç£å¸¦ç§»åŠ¨**: `tape_handler.write_to_tape_drive()` æ¥æ”¶æ­£ç¡®çš„æºè·¯å¾„

### 2. é¡ºåºæ‰§è¡Œä¿è¯ âœ…

- **å•çº¿ç¨‹å·¥ä½œå™¨**: `TapeFileMover` ä½¿ç”¨å•çº¿ç¨‹ç¡®ä¿ç£å¸¦æœºæ“ä½œä¸²è¡ŒåŒ–
- **é˜Ÿåˆ—æœºåˆ¶**: `Queue` ä¿è¯ä»»åŠ¡FIFOé¡ºåºå¤„ç†
- **åŒæ­¥æ§åˆ¶**: ç£å¸¦æœºä¸€æ¬¡åªå¤„ç†ä¸€ä¸ªæ–‡ä»¶ï¼Œé¿å…å¹¶å‘å†²çª

### 3. é”™è¯¯å¤„ç†ä¸æ—¥å¿— âœ…

- **ç§»åŠ¨å¤±è´¥å¤„ç†**: å®Œå–„çš„å¼‚å¸¸æ•è·å’Œé”™è¯¯æ—¥å¿—
- **å›è°ƒé€šçŸ¥**: ç§»åŠ¨å®Œæˆåçš„çŠ¶æ€å›è°ƒ
- **å…³é”®é˜¶æ®µè®°å½•**: æ•°æ®åº“è®°å½•å…³é”®æ“ä½œé˜¶æ®µ

### 4. å¹¶å‘è®¾è®¡ âœ…

- **å‹ç¼©ä¸é˜»å¡**: ç§»åŠ¨é˜Ÿåˆ—åœ¨åå°è¿è¡Œï¼Œä¸å½±å“å‹ç¼©æ“ä½œ
- **å¤šæ–‡ä»¶æ”¯æŒ**: åŒæ—¶å¤„ç†å¤šä¸ªå‹ç¼©æ–‡ä»¶çš„ç§»åŠ¨
- **èµ„æºç®¡ç†**: åˆç†çš„çº¿ç¨‹å’Œèµ„æºä½¿ç”¨

## é…ç½®å»ºè®®

### ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®

```python
# é«˜æ€§èƒ½åœºæ™¯ï¼šç›´æ¥å‹ç¼©åˆ°ç£å¸¦
COMPRESS_DIRECTLY_TO_TAPE = True
COMPRESSION_METHOD = "7zip_command"
COMPRESSION_THREADS = 4
COMPRESSION_LEVEL = 5
MAX_FILE_SIZE = 3 * 1024 * 1024 * 1024  # 3GB

# ç¨³å®šæ€§ä¼˜å…ˆåœºæ™¯ï¼šé€šè¿‡finalç›®å½•ç§»åŠ¨
COMPRESS_DIRECTLY_TO_TAPE = False
```

### ç›®å½•ç»“æ„

```
{BACKUP_COMPRESS_DIR}/
â”œâ”€â”€ temp/{backup_set.set_id}/          # ä¸´æ—¶å‹ç¼©ç›®å½•
â”œâ”€â”€ final/{backup_set.set_id}/         # æœ€ç»ˆæ–‡ä»¶ç›®å½•
â””â”€â”€ temp/{backup_set.set_id}/.7z_work_{archive_name}/  # 7zå·¥ä½œç›®å½•
```

## ç›‘æ§ä¸ç»´æŠ¤

### é˜Ÿåˆ—çŠ¶æ€ç›‘æ§

```python
# è·å–é˜Ÿåˆ—å¤§å°
queue_size = tape_file_mover.get_queue_size()

# æ£€æŸ¥æ˜¯å¦æ­£åœ¨å¤„ç†
is_processing = tape_file_mover.is_processing()
```

### å…³é”®é˜¶æ®µæ—¥å¿—

ç³»ç»Ÿä¼šè‡ªåŠ¨è®°å½•ä»¥ä¸‹å…³é”®é˜¶æ®µï¼š
1. `[å‹ç¼©å®Œæˆ]` - æ–‡ä»¶ç»„å‹ç¼©å®Œæˆ
2. `[æ–‡ä»¶å·²ç§»åŠ¨åˆ°æ­£å¼ç›®å½•]` - æ–‡ä»¶ç§»åŠ¨åˆ°finalç›®å½•
3. `[åŠ å…¥ç§»åŠ¨é˜Ÿåˆ—]` - æ–‡ä»¶åŠ å…¥ç£å¸¦ç§»åŠ¨é˜Ÿåˆ—
4. `[æ–‡ä»¶å·²ç§»åŠ¨åˆ°ç£å¸¦æœº]` - æ–‡ä»¶æˆåŠŸç§»åŠ¨åˆ°ç£å¸¦æœº

### å¼‚å¸¸å¤„ç†

- **ç§»åŠ¨å¤±è´¥**: æ–‡ä»¶ä¿ç•™åœ¨finalç›®å½•ï¼Œå¯æ‰‹åŠ¨é‡è¯•
- **é˜Ÿåˆ—é˜»å¡**: æ”¯æŒè¶…æ—¶æœºåˆ¶å’Œå¼ºåˆ¶åœæ­¢
- **ç£ç›˜ç©ºé—´**: å‹ç¼©å‰æ£€æŸ¥ç£ç›˜å¯ç”¨ç©ºé—´

## æ”¯æŒçš„å‹ç¼©æ ¼å¼

### 7zæ ¼å¼å‹ç¼©
- **7zip_command**: 7-Zipå‘½ä»¤è¡Œå·¥å…·ï¼ˆæ¨èï¼‰
- **py7zr**: py7zråº“å‹ç¼©

**æ–‡ä»¶åæ ¼å¼**: `backup_{backup_set.set_id}_{timestamp}.7z`

**ä»£ç ä½ç½®**: `backup/compressor.py:826-841`, `backup/compressor.py:855-957`

### Gzipæ ¼å¼å‹ç¼©
- **pgzip**: PGZipå¤šçº¿ç¨‹å‹ç¼©

**æ–‡ä»¶åæ ¼å¼**: `backup_{backup_set.set_id}_{timestamp}.tar.gz`

**ä»£ç ä½ç½®**: `backup/compressor.py:842-853`

### ç»Ÿä¸€çš„æ–‡ä»¶ç§»åŠ¨æ”¯æŒ

**è·¯å¾„ç”Ÿæˆ**: `backup/compressor.py:823-824`
```python
archive_suffix = ".tar.gz" if compression_method == 'pgzip' else ".7z"
archive_path = backup_dir / f"backup_{backup_set.set_id}_{timestamp}{archive_suffix}"
```

**è¿”å›å€¼æ ¼å¼**: ä¸¤ç§å‹ç¼©æ–¹å¼éƒ½è¿”å›ç»Ÿä¸€çš„æ ¼å¼ï¼š
```python
return {
    'successful_files': successful_files,
    'failed_files': failed_files,
    'successful_original_size': successful_original_size,
    'archive_path': str(archive_path_abs)  # ç»å¯¹è·¯å¾„
}
```

**è·¯å¾„å¤„ç†**: `backup/compressor.py:987-1005`
```python
# ç¡®å®šå‹ç¼©æ–‡ä»¶çš„å®é™…è·¯å¾„ï¼ˆä½¿ç”¨å‹ç¼©å‡½æ•°è¿”å›çš„å®Œæ•´è·¯å¾„ï¼‰
archive_path_str = compress_result.get('archive_path')
if archive_path_str:
    temp_archive_path = Path(archive_path_str)
    logger.info(f"å‹ç¼©å‡½æ•°è¿”å›çš„æ–‡ä»¶è·¯å¾„: {temp_archive_path}")
else:
    # å¦‚æœå‹ç¼©å‡½æ•°æ²¡æœ‰è¿”å›è·¯å¾„ï¼Œå›é€€åˆ°é¢„è®¾è·¯å¾„
    if compression_enabled:
        suffix = ".tar.gz" if compression_method == 'pgzip' else ".7z"
        temp_archive_path = backup_dir / f"backup_{backup_set.set_id}_{timestamp}{suffix}"
    else:
        temp_archive_path = backup_dir / f"backup_{backup_set.set_id}_{timestamp}.tar"
    logger.warning(f"å‹ç¼©å‡½æ•°æœªè¿”å›è·¯å¾„ï¼Œä½¿ç”¨é¢„è®¾è·¯å¾„: {temp_archive_path}")
```

## ç»“è®º

å½“å‰çš„å‹ç¼©æ–‡ä»¶ç§»åŠ¨æµç¨‹å·²ç»å®ç°äº†ï¼š

1. âœ… **Finalç›®å½•ç§»åŠ¨åŠŸèƒ½** - å‹ç¼©å®Œæˆåæ­£ç¡®ç§»åŠ¨åˆ°finalç›®å½•
2. âœ… **è·¯å¾„æ­£ç¡®ä¼ é€’** - finalç›®å½•è·¯å¾„æ­£ç¡®ä¼ é€’ç»™ç§»åŠ¨ç¨‹åº
3. âœ… **ç£å¸¦æœºé¡ºåºç§»åŠ¨** - å•çº¿ç¨‹é˜Ÿåˆ—ç¡®ä¿é¡ºåºæ‰§è¡Œ
4. âœ… **å¤šæ–‡ä»¶å¹¶å‘å¤„ç†** - æ”¯æŒå¤šä¸ªæ–‡ä»¶åŒæ—¶åŠ å…¥ç§»åŠ¨é˜Ÿåˆ—
5. âœ… **å®Œå–„é”™è¯¯å¤„ç†** - å¼‚å¸¸æ•è·å’ŒçŠ¶æ€å›è°ƒæœºåˆ¶
6. âœ… **7zæ ¼å¼æ”¯æŒ** - æ”¯æŒ7zip_commandå’Œpy7zrä¸¤ç§7zå‹ç¼©æ–¹å¼
7. âœ… **Gzipæ ¼å¼æ”¯æŒ** - æ”¯æŒpgzipå¤šçº¿ç¨‹gzipå‹ç¼©
8. âœ… **æ ¼å¼æ— å…³ç§»åŠ¨** - æ‰€æœ‰å‹ç¼©æ ¼å¼éƒ½ä½¿ç”¨ç»Ÿä¸€çš„ç§»åŠ¨æµç¨‹

**é‡è¦ç‰¹æ€§**ï¼š
- **æ ¼å¼é€æ˜**: ç§»åŠ¨æœºåˆ¶å¯¹å‹ç¼©æ ¼å¼é€æ˜ï¼Œ7zå’Œgzipæ–‡ä»¶éƒ½èƒ½æ­£å¸¸ç§»åŠ¨
- **ç»Ÿä¸€è·¯å¾„**: æ‰€æœ‰å‹ç¼©æ–¹å¼éƒ½è¿”å›ç›¸åŒæ ¼å¼çš„ç»å¯¹è·¯å¾„
- **ç»Ÿä¸€å¤„ç†**: finalç›®å½•ç§»åŠ¨å’Œç£å¸¦æœºé˜Ÿåˆ—å¯¹æ‰€æœ‰æ ¼å¼ä¸€è§†åŒä»

ç³»ç»Ÿæ”¯æŒä¸¤ç§å·¥ä½œæ¨¡å¼ï¼Œå¯æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©ç›´æ¥å‹ç¼©åˆ°ç£å¸¦æˆ–é€šè¿‡finalç›®å½•ä¸­è½¬çš„æ–¹æ¡ˆã€‚æ— è®ºä½¿ç”¨7zè¿˜æ˜¯gzipå‹ç¼©ï¼Œéƒ½èƒ½æ­£å¸¸ç§»åŠ¨åˆ°ç£å¸¦æœºã€‚

## å·²ä¿®å¤çš„é—®é¢˜

### 1. å‹ç¼©çº¿ç¨‹åœæ­¢é—®é¢˜

**é—®é¢˜æè¿°**: å‹ç¼©è¿‡ç¨‹ä¸­å¯èƒ½å› ä¸ºæ— é™ç­‰å¾…å¾ªç¯è€Œåœæ­¢å“åº”ã€‚

**ä¿®å¤æ–¹æ¡ˆ**: `backup/compressor.py:979-1009`

```python
# ä¿®å¤å‰ï¼ˆæœ‰é—®é¢˜ï¼‰
while not compress_progress['completed']:
    await asyncio.sleep(1)  # å¯èƒ½æ— é™ç­‰å¾…

# ä¿®å¤åï¼ˆå¸¦è¶…æ—¶å’Œå¼‚å¸¸å¤„ç†ï¼‰
compression_future = loop.run_in_executor(None, _do_7z_compress)
timeout_seconds = 3600  # 1å°æ—¶è¶…æ—¶
try:
    await asyncio.wait_for(compression_future, timeout=timeout_seconds)
    # ç­‰å¾…å‹ç¼©è¿›åº¦æ ‡è®°å®Œæˆï¼ˆæœ€å¤šç­‰å¾…30ç§’ï¼‰
    max_progress_wait = 30
    progress_wait_count = 0
    while not compress_progress['completed'] and progress_wait_count < max_progress_wait:
        await asyncio.sleep(1)
        progress_wait_count += 1
except asyncio.TimeoutError:
    logger.error(f"å‹ç¼©æ“ä½œè¶…æ—¶ï¼Œå¼ºåˆ¶ç»§ç»­")
    compress_progress['completed'] = True
    compress_progress['running'] = False
```

**ä¿®å¤æ•ˆæœ**:
- âœ… å‹ç¼©æ“ä½œä¸ä¼šæ— é™ç­‰å¾…
- âœ… å¼‚å¸¸æƒ…å†µä¸‹å¼ºåˆ¶ç»§ç»­æ‰§è¡Œ
- âœ… è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
- âœ… å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶

### 2. ç§»åŠ¨è¿‡ç¨‹é˜»å¡å‹ç¼©é—®é¢˜

**é—®é¢˜æè¿°**: tempåˆ°finalç›®å½•çš„æ–‡ä»¶ç§»åŠ¨æ˜¯åŒæ­¥çš„ï¼Œå¯èƒ½é˜»å¡å‹ç¼©æ“ä½œã€‚

**ä¿®å¤æ–¹æ¡ˆ**: `backup/compressor.py:1037-1062`

```python
# ä¿®å¤å‰ï¼ˆåŒæ­¥ç§»åŠ¨ï¼Œå¯èƒ½é˜»å¡ï¼‰
shutil.move(str(temp_archive_path), str(final_archive_path))

# ä¿®å¤åï¼ˆå¼‚æ­¥ç§»åŠ¨ï¼Œä¸é˜»å¡ï¼‰
await loop.run_in_executor(None, lambda: shutil.move(str(temp_archive_path), str(final_archive_path)))
```

**ä¿®å¤æ•ˆæœ**:
- âœ… å‹ç¼©æ“ä½œä¸ä¼šè¢«æ–‡ä»¶ç§»åŠ¨é˜»å¡
- âœ… ç§»åŠ¨æ“ä½œåœ¨åå°çº¿ç¨‹æ± ä¸­æ‰§è¡Œ
- âœ… æé«˜æ•´ä½“å‹ç¼©æ•ˆç‡
- âœ… æ”¯æŒå¹¶å‘å‹ç¼©æ“ä½œ

### 3. è·¯å¾„ä¼ é€’å®Œæ•´æ€§ä¿è¯

**å·²éªŒè¯çš„è·¯å¾„ä¼ é€’é“¾**:
1. **å‹ç¼©å‡½æ•°è¿”å›**: `archive_path_abs`ï¼ˆç»å¯¹è·¯å¾„ï¼‰
2. **tempåˆ°finalç§»åŠ¨**: `final_archive_path`ï¼ˆfinalç›®å½•è·¯å¾„ï¼‰
3. **è¿”å›ç»™è°ƒç”¨æ–¹**: `compressed_info['path']`ï¼ˆfinalç›®å½•ç»å¯¹è·¯å¾„ï¼‰
4. **ä¼ é€’ç»™ç§»åŠ¨é˜Ÿåˆ—**: `compressed_file['path']`ï¼ˆfinalç›®å½•è·¯å¾„ï¼‰
5. **ç£å¸¦æœºç§»åŠ¨**: `tape_handler.write_to_tape_drive()`ï¼ˆä»finalç§»åŠ¨åˆ°ç£å¸¦ï¼‰

**è·¯å¾„æ ¼å¼ç»Ÿä¸€**:
- æ‰€æœ‰å‹ç¼©æ ¼å¼éƒ½ä½¿ç”¨ç»Ÿä¸€çš„è·¯å¾„å¤„ç†é€»è¾‘
- 7zæ–‡ä»¶ï¼š`backup_{set_id}_{timestamp}.7z`
- Gzipæ–‡ä»¶ï¼š`backup_{set_id}_{timestamp}.tar.gz`
- è¿”å›è·¯å¾„ï¼š`{BACKUP_COMPRESS_DIR}/final/{backup_set.set_id}/æ–‡ä»¶å`

## æµ‹è¯•éªŒè¯

### ä¿®å¤éªŒè¯è„šæœ¬

åˆ›å»ºäº†ä¸“é—¨çš„æµ‹è¯•è„šæœ¬ [test_compression_flow_fixed.py](test_compression_flow_fixed.py) éªŒè¯ä¿®å¤æ•ˆæœï¼š

1. **å‹ç¼©éé˜»å¡éªŒè¯** - æµ‹è¯•å‹ç¼©æ“ä½œä¸ä¼šå› ç§»åŠ¨è€Œé˜»å¡
2. **å¼‚æ­¥ç§»åŠ¨éªŒè¯** - æµ‹è¯•tempåˆ°finalçš„å¼‚æ­¥ç§»åŠ¨
3. **è·¯å¾„å®Œæ•´æ€§éªŒè¯** - æµ‹è¯•è·¯å¾„ä¼ é€’çš„æ­£ç¡®æ€§
4. **ç§»åŠ¨é˜Ÿåˆ—éªŒè¯** - æµ‹è¯•ç£å¸¦æœºç§»åŠ¨é˜Ÿåˆ—çš„éé˜»å¡ç‰¹æ€§

### è¿è¡Œæµ‹è¯•

```bash
python test_compression_flow_fixed.py
```

**é¢„æœŸç»“æœ**:
- å‹ç¼©æ“ä½œåœ¨åˆç†æ—¶é—´å†…å®Œæˆ
- æ–‡ä»¶æ­£ç¡®ç§»åŠ¨åˆ°finalç›®å½•
- ç§»åŠ¨é˜Ÿåˆ—å¿«é€Ÿå“åº”
- å‹ç¼©çº¿ç¨‹ä¸ä¼šåœæ­¢

## å®Œæ•´ç§»åŠ¨æµç¨‹éªŒè¯

### å¤šæ–‡ä»¶ç§»åŠ¨æµ‹è¯•

åˆ›å»ºäº†ä¸“é—¨çš„æµ‹è¯•è„šæœ¬ [test_multiple_files_movement.py](test_multiple_files_movement.py) éªŒè¯å¤šä¸ªæ–‡ä»¶çš„å®Œæ•´ç§»åŠ¨æµç¨‹ï¼š

**æµ‹è¯•åœºæ™¯**:
- 3ä¸ªæ–‡ä»¶ç»„ï¼Œæ¯ç»„2ä¸ªæ–‡ä»¶
- å®Œæ•´æµç¨‹ï¼šå‹ç¼© â†’ temp â†’ final â†’ ç£å¸¦æœº
- å¤šä¸ªæ–‡ä»¶é€ä¸€é¡ºåºæ‰§è¡Œ

**éªŒè¯å†…å®¹**:
1. **å®Œæ•´ç§»åŠ¨é“¾è·¯** - éªŒè¯ temp â†’ final â†’ ç£å¸¦æœºçš„å®Œæ•´æµç¨‹
2. **é¡ºåºæ‰§è¡Œ** - éªŒè¯å¤šä¸ªæ–‡ä»¶æŒ‰åŠ å…¥é¡ºåºé€ä¸€ç§»åŠ¨åˆ°ç£å¸¦æœº
3. **é˜Ÿåˆ—æœºåˆ¶** - éªŒè¯ç£å¸¦æœºç§»åŠ¨é˜Ÿåˆ—çš„é¡ºåºæ‰§è¡Œç‰¹æ€§
4. **éé˜»å¡æ“ä½œ** - éªŒè¯å‹ç¼©æ“ä½œä¸ä¼šè¢«ç§»åŠ¨é˜Ÿåˆ—é˜»å¡

### å®Œæ•´ç§»åŠ¨æµç¨‹

**æ­¥éª¤1: æ–‡ä»¶åˆ†ç»„ä¸å‹ç¼©** (`backup/backup_engine.py:1096-1107`)
```python
for group_local_idx, file_group in enumerate(file_groups):
    compressed_file = await self.compressor.compress_file_group(
        file_group, backup_set, backup_task,
        base_processed_files=processed_files, total_files=total_files_from_db
    )
```

**æ­¥éª¤2: temp â†’ final ç§»åŠ¨** (`backup/compressor.py:1024`)
```python
# å¼‚æ­¥ç§»åŠ¨æ–‡ä»¶åˆ°finalç›®å½•ï¼Œé¿å…é˜»å¡å‹ç¼©æ“ä½œ
await loop.run_in_executor(None, lambda: shutil.move(str(temp_archive_path), str(final_archive_path)))
```

**æ­¥éª¤3: åŠ å…¥ç£å¸¦æœºç§»åŠ¨é˜Ÿåˆ—** (`backup/backup_engine.py:1153-1158`)
```python
added = self.tape_file_mover.add_file(
    compressed_file['path'],  # finalç›®å½•ä¸­çš„è·¯å¾„
    backup_set,
    current_group_idx,
    callback=move_callback
)
```

**æ­¥éª¤4: final â†’ ç£å¸¦æœº ç§»åŠ¨** (`backup/tape_file_mover.py:203-209`)
```python
tape_file_path = loop.run_until_complete(
    self.tape_handler.write_to_tape_drive(
        task.source_path,      # finalç›®å½•ä¸­çš„æ–‡ä»¶
        task.backup_set,
        task.group_idx
    )
)
```

### é¡ºåºæ‰§è¡Œä¿è¯æœºåˆ¶

**é˜Ÿåˆ—ç®¡ç†** (`backup/tape_file_mover.py:139-164`)
```python
def _worker_loop(self):
    """å·¥ä½œçº¿ç¨‹å¾ªç¯ï¼Œé¡ºåºå¤„ç†é˜Ÿåˆ—ä¸­çš„æ–‡ä»¶ç§»åŠ¨ä»»åŠ¡"""
    while self._running:
        # ä»é˜Ÿåˆ—è·å–ä»»åŠ¡ï¼ˆFIFOé¡ºåºï¼‰
        task = self._queue.get(timeout=1)
        if task is None:
            break  # åœæ­¢ä¿¡å·

        # é¡ºåºå¤„ç†ä»»åŠ¡ï¼ˆå•çº¿ç¨‹ç¡®ä¿é¡ºåºæ‰§è¡Œï¼‰
        self._process_move_task(task)
        self._queue.task_done()
```

**å…³é”®ç‰¹æ€§**:
- âœ… **FIFOé˜Ÿåˆ—**: å…ˆè¿›å…ˆå‡ºï¼Œä¿è¯åŠ å…¥é¡ºåº
- âœ… **å•çº¿ç¨‹å¤„ç†**: ç¡®ä¿ç£å¸¦æœºæ“ä½œä¸²è¡ŒåŒ–
- âœ… **éé˜»å¡åŠ å…¥**: `add_file()` ç«‹å³è¿”å›ï¼Œä¸é˜»å¡å‹ç¼©
- âœ… **åå°å¤„ç†**: ç§»åŠ¨æ“ä½œåœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œ

### è¿è¡Œæµ‹è¯•

```bash
# æµ‹è¯•å¤šæ–‡ä»¶ç§»åŠ¨æµç¨‹
python test_multiple_files_movement.py

# æµ‹è¯•ä¿®å¤åçš„å•æ–‡ä»¶æµç¨‹
python test_compression_flow_fixed.py

# æµ‹è¯•æ‰€æœ‰å‹ç¼©æ ¼å¼
python test_compression_flow.py
```

**é¢„æœŸç»“æœ**:
- ğŸ“¦ å‹ç¼©æˆåŠŸç‡: 100%
- ğŸšš ç§»åŠ¨æˆåŠŸç‡: â‰¥80%
- ğŸ“‹ ç§»åŠ¨é¡ºåº: ä¸åŠ å…¥é¡ºåºä¸€è‡´
- â±ï¸ å‹ç¼©ä¸é˜»å¡: ç§»åŠ¨é˜Ÿåˆ—ä¸é˜»å¡å‹ç¼©æ“ä½œ