# 计划任务格式化功能改进总结

## 一、改进内容

### 1.1 判断当前磁带卷标是否为当月

**位置**: `web/api/scheduler.py:_check_and_format_tape_if_needed`

**逻辑**:
1. 从卷标中提取年月信息（正则：`(\d{4})(\d{2})`）
2. 与当前系统时间比较
3. 如果是当月，根据当前系统时间更新卷标
4. 如果不是当月，也根据当前系统时间生成新卷标

**代码**:
```python
# 获取当前系统时间
now = datetime.now()
current_year = now.year
current_month = now.month

# 从卷标中提取年月信息
match = re.search(r'(\d{4})(\d{2})', volume_label)
if match:
    label_year = int(match.group(1))
    label_month = int(match.group(2))

# 判断是否为当月
is_current_month = (label_year == current_year and label_month == current_month)

# 如果是当月，根据当前系统时间更新卷标
if is_current_month:
    updated_label = _normalize_tape_label(volume_label, current_year, current_month)
    volume_label = updated_label
else:
    # 如果不是当月，使用当前系统时间生成新卷标
    updated_label = _normalize_tape_label(volume_label, current_year, current_month)
    volume_label = updated_label
```

### 1.2 复用磁盘管理的格式化功能

**位置**: `web/api/scheduler.py:_format_tape_via_disk_management`

**改进**:
- ✅ **后台异步执行**：使用 `asyncio.create_task()`，不阻塞API
- ✅ **状态更新**：格式化前设置为 `MAINTENANCE`，成功后设置为 `AVAILABLE`，失败设置为 `ERROR`
- ✅ **读取实际值**：格式化成功后读取实际卷标和序列号，并更新数据库
- ✅ **错误处理**：格式化失败时发送钉钉通知
- ✅ **与磁盘管理一致**：完全复用磁盘管理的格式化逻辑

### 1.3 序列号格式统一

**位置**: `web/api/scheduler.py:_generate_serial_number`

**改进**:
- 从 `YYMMNN` 格式改为 `TPMMNN` 格式
- 与磁盘管理的序列号格式保持一致

**示例**:
- 旧格式：`250301`（2025年3月第一张）
- 新格式：`TP0301`（3月第一张）

## 二、执行流程

### 2.1 完整流程

```
1. 用户创建计划任务（指定卷标）
   ↓
2. 从卷标中提取年月信息
   ↓
3. 判断是否为当月
   ├─→ 是当月：根据当前系统时间更新卷标
   └─→ 不是当月：根据当前系统时间生成新卷标
   ↓
4. 生成序列号（TPMMNN格式）
   ↓
5. 检查数据库中是否存在该卷标
   ├─→ 不存在：创建记录（状态为MAINTENANCE）
   └─→ 存在：更新记录（状态为MAINTENANCE）
   ↓
6. 后台执行格式化任务（不阻塞API）
   ↓
7. 格式化完成后：
   ├─→ 成功：读取实际值 → 更新数据库 → 状态改为AVAILABLE
   └─→ 失败：状态改为ERROR → 发送钉钉通知
```

### 2.2 与磁盘管理的对比

| 特性 | 计划任务格式化（改进后） | 磁盘管理格式化 |
|------|----------------------|--------------|
| **执行方式** | ✅ 后台异步执行 | ✅ 后台异步执行 |
| **阻塞API** | ❌ 不阻塞 | ❌ 不阻塞 |
| **状态更新** | ✅ 更新（MAINTENANCE → AVAILABLE/ERROR） | ✅ 更新（MAINTENANCE → AVAILABLE/ERROR） |
| **读取实际值** | ✅ 读取并更新 | ✅ 读取并更新 |
| **错误处理** | ✅ 完善（状态更新、通知） | ✅ 完善（状态更新、通知） |
| **序列号格式** | ✅ TPMMNN | ✅ TPMMNN |

## 三、关键改进点

### 3.1 当月判断逻辑

**场景1：卷标是当月**
- 输入：`TP20251101`（2025年11月）
- 当前时间：2025年11月
- 结果：保持或更新为当前系统时间格式（如 `TP20251101`）

**场景2：卷标不是当月**
- 输入：`TP20251001`（2025年10月）
- 当前时间：2025年11月
- 结果：更新为当前系统时间格式（如 `TP20251101`）

### 3.2 后台异步执行

**改进前**：
```python
# 同步执行，阻塞API
format_result = await tape_tools_manager.format_tape_ltfs(...)
```

**改进后**：
```python
# 后台执行，不阻塞API
asyncio.create_task(format_tape_background())
```

### 3.3 完整的状态管理

**状态流转**：
```
创建/更新记录 → MAINTENANCE（格式化中）
   ↓
格式化成功 → AVAILABLE（可用）
格式化失败 → ERROR（故障）
```

## 四、代码变更总结

### 4.1 修改的文件

1. **`web/api/scheduler.py`**:
   - 修改 `_check_and_format_tape_if_needed`：添加当月判断和卷标更新逻辑
   - 修改 `_format_tape_via_disk_management`：复用磁盘管理的后台格式化逻辑
   - 修改 `_generate_serial_number`：序列号格式从 `YYMMNN` 改为 `TPMMNN`
   - 添加导入：`import re`, `import asyncio`

### 4.2 新增功能

1. ✅ **当月判断**：自动判断卷标是否为当月
2. ✅ **卷标更新**：根据当前系统时间更新卷标
3. ✅ **后台执行**：格式化在后台异步执行，不阻塞API
4. ✅ **状态管理**：完整的状态更新流程
5. ✅ **实际值读取**：格式化后读取实际值并更新数据库
6. ✅ **错误处理**：格式化失败时发送钉钉通知

## 五、使用示例

### 5.1 创建计划任务时的格式化

```json
{
  "task_name": "每日备份",
  "action_type": "backup",
  "action_config": {
    "volume_label": "TP20251001",  // 10月的卷标
    "backup_target": "tape"
  }
}
```

**执行流程**：
1. 检测到卷标 `TP20251001` 是10月
2. 当前是11月，不是当月
3. 更新卷标为 `TP20251101`（当前系统时间）
4. 生成序列号 `TP1101`（11月第一张）
5. 后台执行格式化（不阻塞API）

### 5.2 当月卷标的处理

```json
{
  "action_config": {
    "volume_label": "TP20251101"  // 11月的卷标
  }
}
```

**执行流程**：
1. 检测到卷标 `TP20251101` 是11月
2. 当前是11月，是当月
3. 保持或更新卷标为当前系统时间格式
4. 生成序列号 `TP1101`
5. 后台执行格式化

## 六、优势

1. ✅ **不阻塞API**：格式化在后台执行，API立即返回
2. ✅ **功能一致**：与磁盘管理使用相同的格式化逻辑
3. ✅ **状态可见**：UI中可以查看格式化进度（MAINTENANCE状态）
4. ✅ **数据准确**：读取实际值并更新数据库，确保一致性
5. ✅ **错误处理**：格式化失败时自动通知和状态更新
6. ✅ **自动更新**：根据当前系统时间自动更新卷标

## 七、注意事项

1. **卷标格式**：卷标必须包含年月信息（格式：`TPYYYYMMNN`）
2. **序列号格式**：统一使用 `TPMMNN` 格式
3. **状态管理**：格式化期间状态为 `MAINTENANCE`，完成后为 `AVAILABLE` 或 `ERROR`
4. **后台执行**：格式化在后台执行，API立即返回，不等待格式化完成

