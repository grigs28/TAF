# 配置参数存储规划

## 概述

本文档定义了配置参数在 `.env` 文件和数据库中的存储策略，确保配置管理的安全性和灵活性。

## 存储策略

### 1. .env 文件存储策略

`.env` 文件用于存储**启动时的基础配置**和**敏感信息**。

#### ✅ 应该存储在 .env 中

**敏感配置**（必须）：
- 数据库密码、密钥
- API密钥、Token
- 加密密钥
- 第三方服务凭据

**基础运行时配置**（必须）：
- 数据库连接信息
- 服务端口、地址
- 调试模式
- 环境类型

**常用可调配置**（建议）：
- 日志级别
- 连接池大小
- 工作线程数
- 临时目录

#### ❌ 不应该存储在 .env 中

- Web界面中的业务配置
- 用户个性化设置
- 运行时的动态配置
- 统计和监控数据

### 2. 数据库存储策略

数据库用于存储**业务配置**、**用户设置**和**系统状态**。

#### ✅ 应该存储在数据库中

**业务配置**：
- 备份策略配置
- 保留策略设置
- 通知规则配置
- 调度任务配置

**用户设置**：
- 个人偏好
- 界面设置
- 通知偏好
- 系统设置（UI中可修改的）

**系统状态和元数据**：
- 配置修改历史
- 配置版本
- 最近修改时间
- 修改者信息

## 配置分类

### 分类一：固定配置（.env only）

这些配置在系统初始化时读取，通常不会改变。

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| APP_NAME | 企业级磁带备份系统 | 应用名称 |
| APP_VERSION | 1.0.0 | 应用版本 |
| SECRET_KEY | - | JWT密钥 |
| ALGORITHM | HS256 | JWT算法 |

### 分类二：环境配置（.env only）

这些配置根据部署环境不同而变化。

| 配置项 | 开发环境 | 生产环境 |
|--------|---------|---------|
| DEBUG | true | false |
| ENVIRONMENT | development | production |
| DB_HOST | localhost | 192.168.0.20 |
| WEB_PORT | 8080 | 8080 |

### 分类三：敏感配置（.env only，必须加密）

敏感信息必须只在 .env 中存储，且需要加密。

| 配置项 | 说明 |
|--------|------|
| DB_PASSWORD | 数据库密码 |
| DINGTALK_API_KEY | 钉钉API密钥 |
| SECRET_KEY | 加密密钥 |

### 分类四：业务配置（.env + 数据库）

这些配置在 .env 中有默认值，但可以在Web界面中修改并保存到数据库。

| 配置项 | .env默认值 | 数据库覆盖 | 说明 |
|--------|-----------|-----------|------|
| DEFAULT_RETENTION_MONTHS | 6 | ✅ | 默认保留月数 |
| AUTO_ERASE_EXPIRED | true | ✅ | 自动擦除过期磁带 |
| COMPRESSION_LEVEL | 9 | ✅ | 压缩级别 |
| MONTHLY_BACKUP_CRON | 0 2 1 * * | ✅ | 月度备份时间 |

### 分类五：系统配置（数据库 only）

这些配置只存储在数据库中，不在 .env 中。

| 配置项 | 说明 |
|--------|------|
| web_theme | Web界面主题 |
| user_preferences | 用户偏好设置 |
| notification_rules | 通知规则 |
| backup_schedules | 备份调度 |
| tape_inventory | 磁带库存信息 |

## 实现方案

### 1. 配置读取优先级

```
系统启动时：
.env文件 → 加载基础配置
数据库 → 加载业务配置覆盖.env默认值

运行时：
Web界面修改 → 保存到数据库 → 立即生效（无需重启）

紧急情况：
恢复.env中的默认值 → 重启系统
```

### 2. 数据库配置表设计

需要创建 `system_config` 表：

```sql
CREATE TABLE system_config (
    id SERIAL PRIMARY KEY,
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value TEXT NOT NULL,
    config_type VARCHAR(50) NOT NULL,
    category VARCHAR(50),
    description TEXT,
    is_sensitive BOOLEAN DEFAULT FALSE,
    can_modify BOOLEAN DEFAULT TRUE,
    default_value TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_by VARCHAR(100)
);

CREATE INDEX idx_system_config_key ON system_config(config_key);
CREATE INDEX idx_system_config_category ON system_config(category);
```

### 3. 配置管理类设计

```python
class ConfigManager:
    """配置管理器"""
    
    def __init__(self):
        self.env_config = {}  # 从.env加载
        self.db_config = {}   # 从数据库加载
    
    def get_config(self, key: str):
        """获取配置（优先数据库）"""
        if key in self.db_config:
            return self.db_config[key]
        return self.env_config.get(key)
    
    async def set_config(self, key: str, value: str, user: str = None):
        """设置配置到数据库"""
        # 验证配置
        # 保存到数据库
        # 更新内存缓存
        pass
    
    async def reset_config(self, key: str):
        """重置为默认值"""
        # 从.env读取默认值
        # 更新数据库
        pass
```

## 具体配置存储清单

### .env 文件中的配置

#### A. 应用基础
- APP_NAME
- APP_VERSION
- DEBUG
- ENVIRONMENT

#### B. Web服务
- WEB_HOST
- WEB_PORT
- WEB_WORKERS
- MAX_UPLOAD_SIZE

#### C. 数据库连接
- DATABASE_URL
- DB_HOST
- DB_PORT
- DB_USER
- DB_PASSWORD（敏感）
- DB_DATABASE
- DB_POOL_SIZE
- DB_MAX_OVERFLOW

#### D. 安全配置
- SECRET_KEY（敏感）
- ALGORITHM
- ACCESS_TOKEN_EXPIRE_MINUTES

#### E. 第三方服务
- DINGTALK_API_URL
- DINGTALK_API_KEY（敏感）
- DINGTALK_DEFAULT_PHONE

#### F. 路径配置
- BACKUP_TEMP_DIR
- RECOVERY_TEMP_DIR
- LOG_FILE
- WEB_STATIC_DIR
- WEB_TEMPLATE_DIR

#### G. 硬件配置
- TAPE_DRIVE_LETTER
- TAPE_DEVICE_PATH
- DEFAULT_BLOCK_SIZE
- MAX_VOLUME_SIZE

### 数据库中的配置

#### A. 备份策略
- backup_default_retention_months
- backup_compression_level
- backup_max_file_size
- backup_exclude_patterns

#### B. 磁带管理
- tape_pool_size
- tape_auto_erase_expired
- tape_check_interval
- tape_health_threshold

#### C. 调度任务
- scheduler_enabled
- scheduler_monthly_backup_cron
- scheduler_retention_check_cron
- scheduler_health_check_interval

#### D. 通知配置
- notification_enabled
- notification_rules
- notification_phone_list
- notification_templates

#### E. 系统设置
- system_default_language
- system_timezone
- system_max_upload_size
- system_session_timeout

#### F. 高级配置
- performance_compression_threads
- performance_query_cache_enabled
- monitoring_metrics_enabled
- security_password_policy

## 配置修改流程

### Web界面修改配置

```
1. 用户在Web界面修改配置
   ↓
2. 前端发送PUT请求到 /api/system/config
   ↓
3. 后端验证配置合法性
   ↓
4. 保存到数据库 system_config 表
   ↓
5. 更新内存配置缓存
   ↓
6. 通知相关模块配置已变更
   ↓
7. 返回成功响应
   ↓
8. 前端刷新界面显示新配置
```

### 系统启动加载配置

```
1. 读取 .env 文件
   ↓
2. 加载到 Settings 类
   ↓
3. 连接数据库
   ↓
4. 从 system_config 表读取配置
   ↓
5. 覆盖 Settings 中的默认值
   ↓
6. 初始化各模块
   ↓
7. 系统就绪
```

### 配置同步策略

- **首次启动**：创建 system_config 表并初始化
- **配置变更**：实时生效，无需重启
- **配置冲突**：数据库配置优先
- **配置恢复**：可从 .env 恢复默认值

## 安全考虑

### 1. 敏感信息加密

- 所有密码字段在数据库中加密存储
- 使用环境变量而非明文配置
- 定期轮换密钥

### 2. 配置访问控制

- Web界面需要认证
- 敏感配置仅管理员可见
- 配置修改记录审计日志

### 3. 配置备份

- 定期备份 system_config 表
- 版本化配置变更历史
- 支持配置回滚

## 总结

| 存储位置 | 用途 | 修改频率 | 重启生效 |
|---------|------|---------|---------|
| .env | 基础配置、敏感信息 | 低 | 是 |
| 数据库 | 业务配置、用户设置 | 高 | 否 |

---
**企业级磁带备份系统**
版本：v1.0.0
更新时间：2024-11-01

